<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Developing Python Web Applications with Flask</title>

<!-- @@ start change in v1 -->
<link href="../css/programming_notes_v1.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../scripts/programming_notes_v1.js"></script>
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" /></head>

<body>

<div id="wrap-outer">

<!-- header filled by JavaScript -->
<div id="header" class="header-footer"><p>&nbsp;</p></div>

<div id="wrap-inner">

<div id="wrap-toc">
<h5>TABLE OF CONTENTS <a id="show-toc" href="#show-toc">(HIDE)</a></h5>
<div id="toc"></div>  <!-- for showing the "Table of Content" -->
</div>

<div id="content-header">
<h1>Python</h1>
<h2>Developing Web Applications with Flask</h2>
</div>

<div id="content-main">

<!-- @@ end change in v1 -->

<h3>Introduction to Python-Flask Webapp Framework</h3>

<h5>References:</h5>
<ol>
<li>Flask @ <a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>; Flask Documentation &amp; User Guide @ <a href="http://flask.pocoo.org/docs/0.10/">http://flask.pocoo.org/docs/0.10/</a>; Flask API @<a href="http://flask.pocoo.org/docs/0.10/api/">http://flask.pocoo.org/docs/0.10/api/</a>.</li>

<li>Werkzeug @ <a href="http://werkzeug.pocoo.org/">http://werkzeug.pocoo.org/</a>.</li>
<li>Jinja2 @ <a href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>.</li>
<li>Italo Maia, Building Web Applications with Flask, Packt Pub., 2015.</li>
<li>Miguel Grinberg, Flask Web Development, O'Reilly, 2014.</li>
</ol>
<br />

<p>To build a complex webapp, you could <em>roll-your-own</em> or build it over a <em>framework</em> (which provides a set of libraries for common tasks). Rolling-your-own means that you need to write ten-thousand lines of boiler-plate codes, that are already provided by a framework. Worse still, your codes are most likely messy, buggy, un-tested and un-maintainable - you can't write better codes than those who could build framework.  On the other hand, using a framework means that you need to spend weeks or even months reading and understanding the framework, as each framework has it own &quot;syntax&quot; and, hence, a steep learning curve. Furthermore, there are just too many frameworks available and choosing a <em>right</em> framework turns out to be difficult decision.</p>

<p>There are many python frameworks available, e.g., full-stack frameworks like Djiango, TurboGears, web2py; non-full-stack frameworks like Flask, Pyramid. You need to make your own decision to select a framework, which is really a hard decision.</p>

<h4>Flask</h4>

<p>Flask (@ <a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>) was created by Armin Ronacher in 2000 as a small, minimalistic and light-weight Python Webapp framework. It is so small to be called a micro-framework. Flask is actually a glue that sticks together two popular frameworks:</p>

<ol>
<li>Werkzeug (@ <a href="http://werkzeug.pocoo.org/">http://werkzeug.pocoo.org/</a>): a WSGI utility library for Python, which includes a URL routing system, fully featured request and response objects and a powerful debugger. The WSGI (Web Server Gateway Interface) is a specification for simple and universal interface between web servers and web applications or frameworks for the Python programming language.</li>

<li>Jinja2 (@ <a href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>): a full-feature template engine for Python.</li>
</ol>

<p>High-level tasks like database access, web form and user authentication are supported through extensions.</p>

<p>Within the scope of MVC (Model-View-Controller) architecture, Werkzeug covers the Controller (C) and Jinja2 covers the View (V).  Flask does not provide an integrated Model (M) layer, and lets you pick your database solution. A popular choice is SQLAlchemy with a ORM (Object-Relational Mapper) over a relational database such as MySQL or PostgreSQL.</p>

<p>The Flask framework provides:</p>
<ul>
<li>a WSGI compliance interface.</li>
<li>URL routing and Request dispatching.</li>
<li>Secure cookies and Sessions.</li>
<li>a built-in Development Web Server and Debugger.</li>
<li>Unit-test client that facilitates write-test-first.</li>
<li>Jinja2 templates (tags, filters, macros, etc).</li>
</ul>

<p>Via Flask, you can handle HTTP and AJAX requests, user sessions between requests, route requests to controllers, evaluate and validate the request data, and response with HTML or JSON, and so on.</p>

<h4>Installing Flask</h4>

<pre class="color-command">
$ <strong>sudo pip install flask</strong>
......
Successfully installed flask Werkzeug Jinja2 ...

<span class="color-comment"># Verify the installation</span>
$ <strong>pip show flask</strong>
Name: Flask
Version: <strong>0.10.1</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: Werkzeug, Jinja2, itsdangerous
$ <strong>pip show Werkzeug</strong>
Name: Werkzeug
Version: <strong>0.11.2</strong>
$ <strong>pip show Jinja2</strong>
Name: Jinja2
Version: <strong>2.8</strong>
Requires: MarkupSafe</pre>

<p>Notes: You could also install flask via <code>apt-get</code>, but that might not get you the latest version. I recommend that you use <code>pip install</code>, and make full use of <code>pip</code> package management facility. See ...</p>

<h4 id="EclipsePyDev">Eclipse PyDev IDE</h4>

<p>Using a proper IDE (with debugger, profiler, etc.) is CRITICAL in software development.</p>

<p>Read <a href="Python1_Basics.html#EclipsePyDev">HERE</a> on how to install and use Eclipse PyDev for Python program development. This section highlights how to use Eclipse PyDev to develop Flask webapp.</p>

<h5>Using <code>virtualenv</code></h5>
<p>To use <code>virtualenv</code>, create a Python Interpreter for your virtual environment: Window &rArr; Preferences &rArr; PyDev &rArr; Interpreters &rArr; Python Interpreter &rArr; New &rArr; Enter a name and select the Python Interpreter for the virtual environment.</p>
     
<h5>Writing Python-Flask Webapps</h5>
<p>As usual, you can create a PyDev project (New &rArr; Project &rArr; PyDev &rArr; PyDev Project), and then PyDev module under the project (New &rArr; PyDev Module).</p>

<p>If you use any Flask's extensions, you need to build the import list for &quot;<code>flask.ext</code>&quot; via: Window &rArr; Preferences &rArr; PyDev &rArr; Interpreters &rArr; Python Interpreter &rArr; Select your interpreter &rArr; Forced Builtins &rArr; New &rArr; enter &quot;<code>flask.ext</code>&quot;.</p>

<p>To run the Webapp, right-click on the Flask script &rArr; Run As &rArr; Python Run.</p>

<h5>Debugging Python-Flask Webapps running on Flask's Built-in Web Server</h5>

<p>As usual, set a breakpoint by double-clicking on the left margin of the desired line &rArr; Debug As &rArr; Python Run. You can then trace the program, via Step-Over, Step-Into, Step-Out, Resume, or Terminate.</p>

<p>To enable the reloader (auto reload after code modification) and debugger, include &quot;<code>app.debug=True</code>&quot; or &quot;<code>app.run(debug=True)</code>&quot;.</p>

<h5>Debugging Python-Flask Webapp Remotely (running on Apache WSGI)</h5>
<p><strong>Reference</strong>: Remote Debugger @ <a href="http://www.pydev.org/manual_adv_remote_debugger.html">http://www.pydev.org/manual_adv_remote_debugger.html</a>.</p>

<p>The steps are:</p>
<ol>
<li>Start the Remote Debug Server: Switch into &quot;Debug&quot; perspective (Click the &quot;Debug&quot; perspective button; or Window menu &rArr; Open Perspective &rArr; Other &rArr; Debug), and click the &quot;PyDev: Start the pydev server&quot; (or select from the &quot;PyDev&quot; menu). You shall receive a message &quot;Debug Server at port: 5678&quot;, in the Console-pane. In addition, in the Debug-pane, you should see a process &quot;Debug Server&quot;.</li>

<li>Include the module <code>pydevd.py</code> into your <code>sys.path</code> (or <code>PYTHONPATH</code>). First, locate the module path (which is installation-dependent) under <code>eclipse/plugins/org.python.pydev_x.x.x/pysrc/pydevd.py</code>. There are several ways to add this module-path to <code>sys.path</code>:
<ul>
<li>In your <code>.wsgi</code>: Include
<pre class="color-command">
sys.path.append('/path/to/eclipse/plugins/org.python.pydev_x.x.x.x/pysrc')</pre></li>

<li>In your apache configuration file: Include
<pre class="color-command">
WSGIDaemonProcess myflaskapp user=flaskuser group=www-data threads=5 python-path=/path/to/eclipse/plugins/org.python.pydev_x.x.x.x/pysrc</pre></li>

<li>You might be able to set a system-wide environment variable for all processes in <code>/etc/environment</code>:
<pre class="color-command">
PYTHONPATH='/path/to/eclipse/plugins/org.python.pydev_x.x.x.x/pysrc'</pre>
Take note that variable expansion does not work here. Also there is no need to use the <code>export</code> command.
<br />
Also take note that exporting the <code>PYTHONPATH</code> from a bash shell or under <code>~/.profile</code> probably has no effects on the WSGI processes.</li>
</ul>

NOTES: You should also include this module-path in your Eclipse PyDev (to avoid the annoying module not found error): Window &rArr; Preferences &rArr; PyDev &rArr; Interpreters &rArr; Python Interpreters &rArr; Libraries &rArr; Add Folder.</li>

<li>Call <code>pydevd.settrace()</code>: Insert &quot;<code>import pydevd; pydevd.settrace()</code>&quot; inside your program.  Whenever this call is made, the debug server suspend the execution and show the debugger. This line is similar to an initial breakpoint.<br />
NOTES: You need to remove <code>pydevd.settrace()</code> if your debug server is not running.
</li>
</ol>

<h5>Reloading Modified Source Code under WSGI</h5>
<p><strong>Reference</strong>: <code>modwsgi</code> Reloading Source Code @ <a href="https://code.google.com/p/modwsgi/wiki/ReloadingSourceCode">https://code.google.com/p/modwsgi/wiki/ReloadingSourceCode</a>.</p>

<p>If you modify your source code, running under WSGI, you need to restart the Apache server to reload the source code.</p>

<p>On the other hand, if you your WSGI process is run in so-called daemon mode (to verify, check if <code>WSGIDaemonProcess</code> is used in your apache configuration), you can reload the WSGI process by touching the <code>.wsgi</code> file.</p>

<p>By default, reloading is enabled and a change to the WSGI file will trigger the reloading. You can use the <code>WSGIScriptReloading On|Off</code> directive to control the reloading.</p>

<h3>Routes and View Functions</h3>

<p>Let us begin by creating our first webapp in Flask. Flask comes with a built-in developmental web server, i.e., you do not need to run an external web server (such as Apache).</p>

<h4>Get Started with Routes and View Functions</h4>

<p>Create a Python-Flask script called <code>app1.py</code>, under your chosen project directory, as follows:</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""
app1.py: First Python-Flask webapp
"""</span>
from flask import Flask  <span class="color-comment"># Import class Flask from module flask</span>
app = Flask(__name__)    <span class="color-comment"># Construct an instance of Flask class</span>

@app.route('/')   <span class="color-comment"># Register index() as route handler for root URL '/'</span>
def index():
   <span class="color-comment">"""Route handler (or View Function) for root URL '/'"""</span>
   return 'Hello, world!'

if __name__ == '__main__':  <span class="color-comment"># Script executed directly?</span>
   app.run()  <span class="color-comment"># Launch built-in web server and run this Flask webapp</span></pre>

<p>Run <code>app1.py</code>:</p>
<pre class="color-command">
$ <strong>cd /path/to/project-directory</strong>
$ <strong>python app1.py</strong>
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</pre>
 
<p>Flask launches its built-in developmental web server and starts the webapp. You can access the webapp from a browser via URL <code>http://127.0.0.1:5000</code> (or <code>http://localhost:5000</code>). The webapp shall display the hello-world message.</p>

<p>Check the console for the HTTP request and response status code:</p>

<pre class="color-example">
127.0.0.1 - - [15/Nov/2015 12:46:42] "GET / HTTP/1.1" 200 -</pre>

<p>You can stop the server by pressing Ctrl-C.</p>

<h5>Dissecting the Program</h5>

<ol>
<li>Line 1 sets the source code encoding to UTF-8, recommended for internationalization.</li>
<li>Lines 2-4 are the doc-string for the Python module.</li>
<li>In Line 5, we import the <code>Flask</code> class from the <code>flask</code> module.  The <code>from...import...</code> syntax allows us to reference the <code>Flask</code> class directly. In Line 6, we create a new instance of <code>Flask</code> called <code>app</code>. We pass the Python's global variable <code>__name__</code> into the <code>Flask</code>'s constructor, which would be used to determine the root path of the application so as to locate the relevant resources such as static contents (images, CSS, JavaScript) and templates.</li>

<li>Flask handles HTTP requests via the so-called routes. The decorator <code>@app.route(<em>url</em>)</code> registers the decorated function as the route handler for the <code><em>url</em></code>.</li>

<li>In Line 8-11, Flask registers the function <code>index()</code> as the route handler for the root url <code>'/'</code>.  The return value of this function forms the response message for the HTTP request. In this case, the response message is just a plain text, but it would be in HTML/XML or JSON.</li>

<li>In Flask, the route handling function is called a <em>view function</em> or <em>view</em>. This is different from the View (or Presentation) in MVC.</li>

<li>The <code>if __name__ == '__main__'</code> ensures that the script is executed directly by the Python Interpreter (instead of loaded as an imported module, where <code>__name__</code> will take on the module name).</li>

<li>The <code>app.run()</code> launches the Flask's built-in development web server. It then waits for request from client, and handles the request via the route and view function.</li>

<li>You can press Ctrl-C to shutdown the web server.</li>

<li>The built-in developmental web server provided by <code>Flask</code> is not meant for use in production. I will show you how to run a Flask app under Apache web server later.</li>
</ol>

<h4>Multiple Routes for the Same View Function</h4>
<p>You can register more than one URLs to the same view function. For example, modify <code>app1.py</code> (and save as <code>app1a.py</code>) as follows:</p>

<pre class="color-example">
.....
@app.route('/')
@app.route('/hello')
def index():
   <span class="color-comment">"""Route Handler (View Function) for '/' and '/hello"""</span>
   return 'Hello, world!'
......</pre>

<p>Start this application. Try accessing the webapp via URL <code>http://127.0.0.1:5000/</code> or <code>http://127.0.0.1:5000/hello</code>.</p>

<h4>Serving HTML pages</h4>
<p>Instead of plain-text, you can response with an HTML page by returning an HTML-formatted string. For example, modify the <code>app1.py</code> (and save as <code>app1b.py</code>) as follows:</p>
<pre class="color-example">
.....
@app.route('/')
def index():
   <span class="color-comment">"""Return an HTML-formatted string and an optional response status code"""</span>
   return &quot;&quot;&quot;&lt;!DOCTYPE html&gt;
      &lt;html&gt;
      &lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
      &lt;body&gt;&lt;h1&gt;Hello, world!&lt;/h1&gt;&lt;/body&gt;
      &lt;/html&gt;&quot;&quot;&quot;, 200
......</pre>

<ol>
<li>The second optional return value is the HTTP response status code, with default value of 200 (for OK).</li>
</ol>

<h4>Separating the Presentation View from the Controller with Templates</h4>

<p>Instead of putting the response message directly inside the route handling function (which violates the MVC architecture), we separate the View (or Presentation) from the Controller by creating an HTML page called &quot;<code>index.html</code>&quot; under a sub-directory called &quot;<code>templates</code>&quot;, as follows:</p>

<p><code>templates/index.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;Hello&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, world!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>Modify the Flask script (and save as <code>app1c.py</code>) as follows:</p>
<pre class="color-example">
......
from flask import Flask, render_template  <span class="color-comment"># Need render_template to render HTML pages</span>
......
@app.route('/')
def index():
   <span class="color-comment">"""Render an HTML template and return"""</span>
   return render_template('index.html')  <span class="color-comment"># To be placed under sub-directory templates</span>
......</pre>

<ol>
<li>The function <code>render_template()</code> (from module <code>flask</code>) is used to render a Jinja2 template to an HTML page. We will elaborate on the powerful Jinja2 templates later.</li>
</ol>

<h4>Debug Mode - Enabling &quot;Reloader&quot; and &quot;Debugger&quot;</h4>

<p>In the above examples, you need to restart the app if you make any modifications to the codes. For development, we can turn on the debug mode, which enables the reloader and the debugger.</p>

<p>There are two ways to turn on debug mode:</p>

<ol>
<li>Set the <code>debug</code> attribute of the <code>Flask</code> instance <code>app</code> to <code>True</code>:
<pre class="color-example">
app = Flask(__name__)
<strong>app.debug = True</strong>  <span class="color-comment"># Enable reloader and debugger</span>
......

if __name__ == '__main__':
   app.run()</pre></li>

<li>Pass a keyword argument <code>debug=True</code> into the <code>app.run()</code>:
<pre class="color-example">
app = Flask(__name__)
......
if __name__ == '__main__':
   app.run(<strong>debug=True</strong>)  <span class="color-comment"># Enable reloader and debugger</span>
</pre></li>
</ol>

<p>Modify the Flask script (and save as <code>app1d.py</code>) to run in debug mode. Observe the console messages:</p>
<pre class="color-example">
$ <strong>python hello.py</strong> 
 * Restarting with stat
 * Debugger is active!
 * Debugger pin code: 187-596-537
 ......</pre>

<p>In debug mode, the Flask app monitors your source code, and reload the source code if any modification is detected (i.e., auto-reloader). It also launches the debugger if an error is detected.</p>

<p>IMPORTANT: Debug mode should NOT be used for production, because it lets users to execute code on the server.</p>

<h4>URL with Variable</h4>

<p>You can use variable in the URL, for example (save as <code>app1e.py</code>),</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""
app1e.py: Using URL Variables
"""</span>
from flask import Flask
app = Flask(__name__)

@app.route('/hello')
def hello():
   return 'Hello, world!'

@app.route('/hello/&lt;username&gt;')  <span class="color-comment"># URL with a variable</span>
def hello_user(username):        <span class="color-comment"># The function shall take the URL variable as parameter</span>
   return 'Hello, %s' % username

@app.route('/hello/&lt;int:userid&gt;')  <span class="color-comment"># Variable with type filter. Accept only int</span>
def hello_userid(userid):          <span class="color-comment"># The function shall take the URL variable as parameter</span>
   return 'Hello, your ID is: %d' % userid

if __name__ == '__main__':
    app.run(debug=True)  <span class="color-comment"># Enable reloader and debugger</span></pre>

<h5>Dissecting the Program</h5>

<ol>
<li>The URL of the second route contains a variable in the form of <code>&lt;url-varname&gt;</code>, which is also defined as a function parameter. Try issuing URL <code>http://localhost:5000/hello/peter</code>.</li>

<li>You can also apply a type converter to the variable (as in the 3rd route), in the form of <code>&lt;type-converter:url-varname&gt;</code> to filter the type of the URL variable. The available type-converters are: <code>int</code>, <code>float</code>, <code>path</code> (accept slash).  Try issuing URL <code>http://localhost:5000/hello/123</code></li>
</ol>

<h4>Functions <code>redirect()</code> and <code>url_for()</code></h4>

<p>In your view functions, you can use <code>return redirect(<em>url</em>)</code> to redirect the response to another URL.</p>

<p>Instead of hard-coding URLs in your view functions (and templates), you could use helper function <code>url_for()</code> to generate URL based on the view function's name. The <code>url_for()</code> takes a view function name, and returns its URL. For example, suppose that <code>main()</code> is the view function for <code>'/'</code>, and <code>hello()</code> for <code>'/hello/&lt;username&gt;'</code>:</p>

<ul>
<li><code>url_for('main')</code>: return the internal URL <code>/</code>.</li>
<li><code>url_for('main', _external=True)</code>: return the external URL <code>http://localhost:5000/</code>.</li>
<li><code>url_for('main', page=2)</code>: return the internal URL <code>/?page=2</code>. All optional keyword arguments are treated as GET parameters.</li>
<li><code>url_for('hello', username='peter', _external=True)</code>: return the external URL <code>http://localhost:5000/hello/peter</code>.</li>
</ul>

<p>For example,</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""
app1f.py: Using functions redirect() and url_for()
"""</span>
from flask import Flask, redirect, url_for
app = Flask(__name__)

@app.route('/')
def index():
   return redirect(url_for('start', username='Peter'))
         <span class="color-comment"># Also pass an optional URL variable</span>

@app.route('/go/&lt;username&gt;')
def start(username):
   return 'Hello, %s' % username

if __name__ == '__main__':
    app.run(debug=True)</pre>


<p>It is recommended to use <code>url_for()</code>, instead of hardcoding the links in your codes, as it is more flexible, and allows you to change your URL.</p>


<h4>Other Static Resources: Images, CSS, JavaScript</h4>

<p>By default, Flask built-in server locates the static resource under the sub-directory <code>static</code>. You can create sub-sub-directories such as <code>images</code>, <code>css</code> and <code>js</code>.</p>

<p>The directory structure of a Flask webapp is as follows:</p>
<pre class="color-example">
project-directory
  |
  +- templates
  +- static
      |
      +- css
      +- js
      +- images</pre>

<p>[TODO] Example</p>

<p>In production, the <code>static</code> directory should be served by an HTTP server (such as Apache).</p>

<h4>The <code>flask</code> Package</h4>

<p>A typical <code>import from flask</code> statement is as follows:</p>

<pre class="color-example">
from flask import Flask, request, session, g redirect, url_for, abort, render_template, flash</pre>

<ul>
<li><code>Flask</code> class: </li>
<li><code>request</code> object: </li>
<li><code>session</code> object: for storing information for a user (thread), used for passing information from one request to the next request, in a multi-thread environment.</li>
<li><code>g</code> object: for storing information for a user (thread) for one request only, used for passing information from one function to another function, in a multi-thread environment. It is also known as request-global or application-global.</li>
<li><code>redirect()</code> and <code>url_for()</code> function:</li>
<li><code>abort()</code> function: </li>
<li><code>render_template()</code> function: </li>
<li><code>flash()</code> function: </li>
</ul>

<p>[TODO]</p>


<h3>Jinja2 Templates</h3>

<h4>Jinja2 Templates Get Started</h4>

<p>In Flask, the route handlers (or view functions) are primarily meant for the business logic (i.e., Controller in MVC), while the presentation (i.e., View in MVC) is to be taken care by the so-called templates. A template is a file that contains the static texts, as well as placeholder for rendering dynamic contents.</p>

<p>Flask uses a powerful template engine called Jinja2.</p>

<h5>Example: Getting Started in Jinja2 Templates with HTML Forms</h5>

<p>Create a sub-directory called <code>templates</code>, under your project directory. Create the <code>index.html</code> (which is an ordinary html file) under the <code>templates</code> sub-directory, as follows:</p>

<p><code>templates/index.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;Main Entry Page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form action="submit" method="post"&gt;
  &lt;label for="username"&gt;Please enter your name: &lt;/label&gt;&lt;br&gt;
  &lt;input type="text" id="username" name="username"&gt;&lt;br&gt;
  &lt;input type="submit" value="SEND"&gt;
  &lt;input type="reset" value="RESET"&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>Create a templated-html file called <code>response.html</code> under the <code>templates</code> sub-directory, as follows:</p>

<p><code>templates/response.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;Response Page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, <strong>{{ username }}</strong>&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>Create the main script <code>jinja_app1.py</code> under the project directory, as follows:</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""jinja_app1.py: Get start with Jinja2 templates"""</span>
from flask import Flask, render_template, request
app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/submit', methods=['POST'])
def submit():
    <span class="color-comment"># Read the HTTP POST request parameter from request.form</span>
    _username = request.form['username']
 
    <span class="color-comment"># Validate and send response</span>
    if _username:
        return render_template('response.html', username=_username)
    else:
        return 'Please go back and enter your name...'

if __name__ == '__main__':
    app.run(debug=True)</pre>

<h5>How it Works</h5>
<ol>
<li>The <code>index.html</code> is an ordinary html file. But the <code>response.html</code> is a Jinja template file.  It contains static texts as well as placeholders for dynamic contents.  The placeholders are identified as <code>{{ <em>template-varname</em> }}</code>.</li>

<li>To render a template, use <code>render_template()</code> function (with <code>from flask import render_template</code>). This function takes a template filename as the first argument; and optional key-value pairs as additional arguments.</li>

<li>This example also illustrates the handling of form data. We processes the POST request parameters, extracted via <code>request.form[<em>param-name</em>]</code> (with <code>from flask import request</code>).</li>

<li>There are several ways to retrieve the HTTP request parameters:
<ul>
<li><code>request.args</code>: a key-value dictionary containing the GET parameters in the URL. For example, in <code>http://localhost/?page=10</code>, the <code>request.args['page']</code> returns 10.</li>
<li><code>request.form</code> dictionary: a dictionary containing the POST parameters sent in the request body as in the above example.</li>
<li><code>request.values</code>: a dictionary containing both GET and POST parameters.</li>
</ul></li>
</ol>

<h4>Jinja2 Template Syntaxes</h4>

<p>Reference: Template Designer Documentation @ <a href="http://jinja.pocoo.org/docs/dev/templates/">http://jinja.pocoo.org/docs/dev/templates/</a>.</p>
<br />

<p>A Jinja2 template is simply a text file embedded with Jinja2 statements, marked by:</p>
<ul>
<li><code>{# ...<em>comment</em>... #}</code>: a comment not included in the template output.</li>
<li><code>{{ ...<em>expression</em>... }}</code>: an expression (such as variable or  function call) to be evaluated to produce the template output.</li>
<li><code>{% ...<em>statement</em>... %}</code>: a Jinja2 statement.</li>
</ul>
<p>You can use Jinja2 template to create any formatted text, including HTML, XML, Email, or MarkDown.</p>

<p>Jinja2 template engine is powerful. It supports variable, control constructs (conditional and loop), and inheritance. Jinja2 syntaxes closely follow Python.</p>

<h5>Variables</h5>
<p>Template variables are defined by the so-called <em>context dictionary</em> passed to the template.  They can be having a simple type (such as string or number), or a complex type (such as list or object). You can use an expression <code>{{ <em>varname</em> }}</code> to evaluate and output its value.</p>

<p>The following flask's variables/functions are available inside the Jinja2 templates:</p>

<ul>
<li><code>config</code>: the <code>flask.config</code> object.</li>
<li><code>request</code>: the <code>flask.request</code> object.</li>
<li><code>g</code>: the <code>flask.g</code>object, for passing information for the active request only.</li>
<li><code>session</code>: the <code>flask.session</code> object, for passing information form one request to next request for a particular user.</li>
<li><code>url_for()</code>: the <code>flask.url_for()</code> function.</li>
<li><code>get_flashed_message()</code>: the <code>flask.get_flashed_message()</code> function.</li>
</ul>

<p>To inject new variables/functions into all templates from flask script, use <code>@app_context_processor</code> decorator. See ...</p>

<h5>Testing Jinja2 Syntaxes</h5>
<p>You can test Jinja2 syntaxes without writing a full webapp by constructing a <code>Template</code> instance and invoking the <code>render()</code> function. For example,</p>

<pre class="color-example">
<span class="color-comment"># Import Template class</span>
&gt;&gt;&gt; from jinja2 import Template

<span class="color-comment"># Create a Template containing Jinja2 variable</span>
&gt;&gt;&gt; t = Template('Hello, <strong>{{ name }}</strong>')

<span class="color-comment"># Render the template with value for variable</span>
&gt;&gt;&gt; t.render(name='peter')
u''Hello, peter'   <span class="color-comment"># u'...' for Unicode string</span></pre>

<h5>Filters</h5>

<p>You can modify a value by piping it through so called <em>filter</em>, using the pipe symbol (<code>'|'</code>) in the form of <code>{{ <em>varname</em>|<em>filter-name</em> }}</code>, e.g.,</p>

<pre class="color-example">
&gt;&gt;&gt; from jinja2 import Template
&gt;&gt;&gt; t1 = Template('Hello, <strong>{{ name|striptags }}</strong>')
&gt;&gt;&gt; t1.render(name='&lt;em&gt;Peter&lt;/em&gt;')
u'Hello, Peter'  <span class="color-comment"># HTML tags stripped</span>

&gt;&gt;&gt; t2 = Template('Hello, <strong>{{ name|trim|title }}</strong>')
&gt;&gt;&gt; t2.render(name='  peter and paul  ')
u'Hello, Peter And Paul'  <span class="color-comment"># trim leading/trailing spaces and initial-cap each word</span></pre>

<p>The piping operation <code>{{ name|trim|title }}</code> is the same as function call <code>title(trim(name))</code>. Filters can also accept arguments, e.g. <code>{{ mylist|join(', ') }}</code>, which is the same as <code>str.join(', ', mylist)</code>.</p>

<p>The commonly-used built-in filters are:</p>
<ul>
<li><code>upper</code>: to uppercase</li>
<li><code>lower</code>: to lowercase</li>
<li><code>capitalize</code>: first character in uppercase, the rest in lowercase</li>
<li><code>title</code>: initial-capitalize each word</li>
<li><code>trim</code>: strip leading and trailing white-spaces</li>
<li><code>striptags</code>: remove all HTML tags</li>

<li><code>default('<em>default-value</em>')</code>: provides the default value if the value is not defined, e.g.
<pre class="color-example">
from jinja2 import Template
t = Template('{{ var|default('default value') }}')

print(t.render())                  <span class="color-comment"># Output: default value</span>
print(t.render(var='some value'))  <span class="color-comment"># Output: some value</span>
</pre></li>

<li><code>safe</code>: output without escaping HTML special characters. See the section below.</li>

<li><code>tojson</code>: convert the given object to JSON representation. You need to coupled with <code>safe</code> to disable autoescape, e.g., <code>{{ username|tojson|safe }}</code>.</li>
</ul>


<h5>Auto-Escape and <code>safe</code> filter</h5>

<p>To protect against XSS (Cross-Site Scripting) attack, it is important to replace special characters that are used to create markups, such as <code>&lt;</code> and <code>&gt;</code>, to their escape sequences, such as <code>&amp;lt;</code> and <code>&amp;gt;</code>, before sending these characters in the response message to be rendered by the browser.</p>

<p>In Jinja2, if you use <code>render_template()</code> to render a <code>.html</code> (or  <code>.htm</code>, <code>.xml</code>, <code>.xhtml</code>), auto-escape is enabled by default for all the template variables, unless the filter <code>safe</code> is applied to disable the escape.</p>

<p>For example, in the above example, try entering <code>&lt;em&gt;Peter&lt;/em&gt;</code> into the <code>username</code>, and do &quot;view source&quot; to view the rendered output. Then, mark the template variable with <code>safe</code> filter.</p>

<p>You can also explicitly enable/disable autoescape in your Jinja2 template using <code>{% autoescape %}</code>, e.g.,</p>

<pre class="color-example">
{% autoescape false %}
  &lt;p&gt;{{ var_no_escape }}&lt;/p&gt;
{% endautoescape %}</pre>



<h5>Assignment and <code>set</code> Statement</h5>

<p>You can create a variable by assigning a value to a variable via the <code>set</code> statement, e.g.,</p>

<pre class="color-example">
{% set username = 'Peter' %}
{% set navigation = [('index.html', 'Index'), ('about.html', 'About')] %}
{% set key, value = myfun() %}
</pre>


<h5>Conditionals</h5>
<p>The syntax is:</p>
<pre class="color-syntax">
<strong>{% if</strong> ...... <strong>%}</strong>
   ......
<strong>{% elif</strong> ...... <strong>%}</strong>
   ......
<strong>{% else %}</strong>
   ......
<strong>{% endif %}</strong></pre>

<p>For example,</p>
<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
from jinja2 import Template
t = Template('''
{% if name %}
  Hello, {{ name }}
{% else %}
  Hello, everybody
{% endif %}''')

print(t.render(name='Peter'))  <span class="color-comment"># 'Hello, Peter'</span>
print(t.render())              <span class="color-comment"># 'Hello, everybody'</span>
</pre>

<h5>Loops</h5>
<p>Jinja2 support <code>for...in</code> loop. The syntax is:</p>
<pre class="color-syntax">
<strong>{% for</strong> <em>item</em> <strong>in</strong> <em>list</em> <strong>%}</strong>
   ......
<strong>{% endfor %}</strong></pre>

<p>For example, to generate an HTML list:</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
from jinja2 import Template
t = Template('''
&lt;ul&gt;
{% for message in messages %}&lt;li&gt;{{ message }}&lt;/li&gt;{% endfor %}
&lt;/ul&gt;''')

print(t.render(messages=['apple', 'orange', 'pear']))</pre>

<p>The output is:</p>
<pre class="output">
&lt;ul&gt;
&lt;li&gt;apple&lt;/li&gt;&lt;li&gt;orange&lt;/li&gt;&lt;li&gt;pear&lt;/li&gt;
&lt;/ul&gt;</pre>

<h5><code>break</code> and <code>continue</code></h5>
<p>Jinja2 does not support <code>break</code> and <code>continue</code> statements for loops.</p>

<h5>for loop with else</h5>
<p>You can add a <code>else</code>-clause to the <code>for</code> loop. The <code>else</code>-block will be executed if <code>for</code> is empty.</p>
<pre class="color-syntax">
<strong>{% for</strong> <em>item</em> <strong>in</strong> <em>list</em> <strong>%}</strong>
   ......
<strong>{% else %}</strong>
   ......      <span class="color-comment"># run if for loop is empty</span>
<strong>{% endfor %}</strong></pre>


<h5>The Variable <code>loop</code></h5>

<p>Inside the loop, you can access a special variable called <code>loop</code>, e.g.,</p>
<ul>
<li><code>loop.first</code>: first iteration?</li>
<li><code>loop.last</code>: last iteration?</li>
<li><code>loop.cycle('str1', 'str2', ...)</code>: print str1, str2,... alternating</li>
<li><code>loop.index</code>: 1-based index</li>
<li><code>loop.index0</code>: 0-based index</li>
<li><code>loop.revindex</code>: reverse 1-based index</li>
<li><code>loop.revindex0</code>: reverse 0-based index</li>
</ul>

<p>For example:</p>
<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
from jinja2 import Template
t = Template('''
&lt;ul&gt;
{% for item in items %}&lt;li&gt;
  {% if loop.first %}THIS IS ITEM 1{% endif %}
  {{ loop.index }}: {{ item }} ({{ loop.cycle('odd', 'even') }})&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;''')

print(t.render(items=['apple', 'banana', 'cherry']))</pre>

<p>The output is:</p>
<pre class="output">
&lt;ul&gt;
&lt;li&gt;
  THIS IS ITEM 1
  1: apple (odd)&lt;/li&gt;
&lt;li&gt;
  
  2: banana (even)&lt;/li&gt;
&lt;li&gt;
  
  3: cherry (odd)&lt;/li&gt;

&lt;/ul&gt;</pre>

<h5><code>with</code> block-scope variable</h5>
<p>You can create block-scope variable using the <code>with</code> statement, e.g.,</p>

<pre class="color-example">
{% with messages = get_flashed_messages() %}
  {% if messages %}
    &lt;ul class='flashes'&gt;
    {% for message in messages %}&lt;li&gt;{{ message }}&lt;/li&gt;{% endfor %}
    &lt;/ul&gt;
  {% endif %}
{% endwith %}</pre>

<p>The variable <code>message</code> is only visible inside the <code>with</code>-block.</p>

<p>Take note that <code>with</code> belongs to Jinja2 extension, and may not be available by default.</p>

<h5><code>macro</code> and <code>import</code></h5>
<p>A Jinja2 macro is similar to a Python function. The syntax is:</p>
<pre class="color-syntax">
<strong>{% macro</strong> <em>macro-name(args)</em> <strong>%}</strong>
   ......
<strong>{% endmacro %}</strong></pre>

<p>For example,</p>
<pre class="color-example">
<strong>{% macro gen_list_item(item) %}
   &lt;li&gt;{{ item }}&lt;/li&gt;
{% endmacro %}</strong>

&lt;ul&gt;
  {% for message in messages %}
    {{ <strong>gen_list_item(message)</strong> }}
  {% endfor %}
&lt;/ul&gt;</pre>

<p>You can also store all the macros in a standalone file, and import them into a template. For example,</p>

<pre class="color-example">
{% <strong>import 'macro.html' as macros</strong> %}

&lt;ul&gt;
  {% for message in messages %}
    {{ <strong>macros</strong>.gen_list_item(message) }}
  {% endfor %}
&lt;/ul&gt;</pre>

<p>The <code>import</code> statement can take several forms (similar to Python's <code>import</code>)</p>
<pre class="color-example">
{% import 'macro.html' as macros %}
{% from 'macro.html' import gen_list_item as gen_list %}</pre>

<h4>Building Templates with <code>include</code> and Inheritance</h4>

<p>Three Jinja2 statements, namely, <code>include</code>, <code>block</code> and <code>extends</code>, can be used to build templates from different files. The <code>block</code> and <code>extends</code> statements are used together in inheritance.</p>

<h5>Include</h5>
<p>In a template file, you can include another template file, via the <code>include</code> statement. For example,</p>
<pre class="color-example">
{% <strong>include</strong> 'header.html' %}</pre>

<h5>Blocks</h5>

<p>You can define a block via the <code>block</code> statement, as follows:</p>

<pre class="color-syntax">
<strong>{% block</strong> <em>block-name</em> <strong>%}</strong>
.....
<strong>{% endblock %}</strong></pre>

<p>Blocks can be used as placeholders for substitution, as illustrated in template inheritance below.</p>

<h5>Template Inheritance via <code>extends</code> and <code>block</code> Statements</h5>
<p>You can derive a template from a base template through template inheritance (similar to Python class inheritance), via the <code>extends</code> and <code>block</code> statements.</p>

<p>As an example, we shall first create a base template (called <code>base.html</code>) as follows:</p>

<p><code>templates/base.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  <strong>{% block head %}</strong>
  &lt;link rel="stylesheet" href="style.css" /&gt;
  &lt;title&gt;<strong>{% block title %}{% endblock %}</strong> - ABC Corp.&lt;/title&gt;
  <strong>{% endblock %}</strong>
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="header"&gt;
    <strong>{% block header %}{% endblock %}</strong>
  &lt;/div&gt;
  
  &lt;div id="content"&gt;
    <strong>{% block content %}{% endblock %}</strong>
  &lt;/div&gt;
  
  &lt;div id="footer"&gt;
    <strong>{% block footer %}</strong> &copy; Copyright 2015 by ABC Corp.<strong>{% endblock %}</strong>
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>The base template contains 5 blocks, defined via <code>{% block <em>block-name</em> %}...{% endblock %}</code>. We can derive child templates from the base template by filling in these blocks. For example, let's create a <code>hello.html</code> that extends from <code>base.html</code> as follows:</p>

<p><code>templates/hello.html</code></p>

<pre class="color-example">
<strong>{% extends "base.html" %}</strong>
{% block title %}Main Page{% endblock %}
{% block head %}
  {{ super() }}{# Render the contents of the parent block #}
  &lt;style type="text/css"&gt;
    .red { color: red; }
  &lt;/style&gt;
{% endblock %}
{% block header %}&lt;h1&gt;Hello&lt;/h1&gt;{% endblock %}
{% block content %}
  &lt;p class="red"&gt;hello, world!&lt;/p&gt;
{% endblock %}</pre>

<ol>
<li>The <code>{% extends .... %}</code> specifies the parent template.</li>
<li>Blocks are defined, that replaces the blocks in the parent template.</li>
<li>The <code>{{ super() }}</code> renders the contents of the parent block.</li>
</ol>

<p>To test the template, write a script, as follows:</p>
<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
from flask import Flask, render_template
app = Flask(__name__)

@app.route('/')
def index():
   return render_template('hello.html')

if __name__ == '__main__':
   app.run()</pre>


<h5><code>url_for()</code></h5>

<p>The <code>url_for()</code> helper function, which returns the URL for the given view function name, works in Jinja2 template as well.</p>

<p>In Flask, the static resources, such as images, css, and JavaScripts are stored in a sub-directory called <code>static</code>, by default, with sub-sub-directories such as <code>img</code>, <code>css</code>, <code>js</code>. The routes for these static files are <code>/static/&lt;filename&gt;</code>.</p>

<ul>
<li><code>url_for('static', filename='css/mystyles.css', _external=True)</code>: return the external URL <code>http://localhost:5000/static/css/mystyles.css</code>.</li>
</ul>

<p>For example, to include an addition CSS in the <code>head</code> block:</p>
<pre class="color-example">
{% block head %}
{{ super() }}
&lt;link rel="stylesheet" href="{{ url_for('static', filename='css/mystyles.css') }}"&gt;
{% endblock %}</pre>



<h3>Web Forms via FlaskWTF and WTForms</h3>

<h5>References</h5>
<ol>
<li>FlaskWTF @ <a href="https://flask-wtf.readthedocs.org/en/latest/">https://flask-wtf.readthedocs.org/en/latest/</a>.</li>

<li>WTForms Documentation @ <a href="https://wtforms.readthedocs.org/en/latest/">https://wtforms.readthedocs.org/en/latest/</a>.</li>
</ol>
<br />

<p>Recall that you can use the <code>request.form</code> to retrieve the request parameters (See previous example). However, there are many repetitive and tedious task in handling form input data such as input validation. The Flask-WTF extension greatly simplifies form processing, such as generating HTML form codes, validating submitted data, cross-site request forgery (CSRF) protection, file upload, and etc.</p>

<h5>Installing Flask-WTF</h5>
<pre class="color-command">
$ <strong>sudo pip install flask-wtf</strong>
Successfully installed flask-wtf WTForms

$ <strong>pip show --files flask-wtf</strong>
Name: Flask-WTF
Version: $ <strong>0.12</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: WTForms, Flask, Werkzeug
$ <strong>pip show --files WTForms</strong>
Name: WTForms
Version: $ <strong>2.0.2</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires:</pre>

<h4>WTForms 2.0.2</h4>

<p>Flask-WTF uses WTForms for form input handling and validation. Installing Flask-WTF  will automatically install WTForms, as shown above.</p>

<p>In WTForms,</p>
<ul>
<li><code>Form</code>s are the core container that glue everything together. A <code>Form</code> is a collection of <code>Field</code>s. You create a form by sub-classing the <code>wtforms.Form</code> class.</li>

<li>A <code>Field</code> has a data type, such as <code>IntegerField</code>, <code>StringField</code>. It contains the field data, and also has properties, such as <code>label</code>, <code>id</code>, <code>description</code>, and <code>default</code>.</li>

<li>Each field has a <code>Widget</code> instance, for rendering an HTML representation of the field.</li>

<li>A field has a list of <code>validators</code>.</li>
</ul>

<p>You can explore these object in the console, e.g.,</p>

<pre class="color-command">
&gt;&gt;&gt; <strong>from wtforms import Form, StringField, PasswordField</strong>
&gt;&gt;&gt; <strong>from wtforms.validators import InputRequired, Length</strong>

<span class="color-comment"># Derive a subclass of Form called LoginForm, containing Fields</span>
&gt;&gt;&gt; <strong>class LoginForm(Form):
...    username = StringField(u'User Name:', validators=[InputRequired(), Length(max=30)])
...    passwd = PasswordField(u'Password:', validators=[Length(min=4, max=16)])
...</strong>
<span class="color-comment"># Construct an instance of LoginForm called form</span>
&gt;&gt;&gt; <strong>form = LoginForm()</strong>
<span class="color-comment"># You can reference a field via dictionary-style or attribute-style</span>
&gt;&gt;&gt; <strong>form['username']</strong>
&lt;wtforms.fields.core.StringField object at 0x7f51dfcbbf50&gt;
&gt;&gt;&gt; <strong>form.username</strong>
&lt;wtforms.fields.core.StringField object at 0x7f51dfcbbf50&gt;

<span class="color-comment"># Show field attributes</span>
&gt;&gt;&gt; <strong>form.username.label</strong>
Label('username', 'User Name:')
&gt;&gt;&gt; <strong>form.username.id</strong>
'username'
&gt;&gt;&gt; <strong>form.passwd.validators</strong>
[&lt;wtforms.validators.Length object at 0x7fdf0d99ee90&gt;]

<span class="color-comment"># Show form data</span>
&gt;&gt;&gt; <strong>form.data</strong>
{'username': None, 'passwd': None}

<span class="color-comment"># Run validator</span>
&gt;&gt;&gt; <strong>form.validate()</strong>
False
<span class="color-comment"># Show validation errors</span>
&gt;&gt;&gt; <strong>form.errors</strong>
{'username': [u'This field is required.'], 
 'passwd': [u'Field must be between 4 and 16 characters long.']}

<span class="color-comment"># To render a field, coerce it to a string:</span>
&gt;&gt;&gt; <strong>str(form.username)</strong>
'&lt;input id="username" name="username" type="text" value=""&gt;'
&gt;&gt;&gt; <strong>unicode(form.username)</strong>
u'&lt;input id="username" name="username" type="text" value=""&gt;'
&gt;&gt;&gt; <strong>print(form.username)</strong>
&lt;input id="username" name="username" type="text" value=""&gt;

<span class="color-comment"># You can also &quot;call&quot; the field with additional keyword arguments:</span>
&gt;&gt;&gt; <strong>form.username()</strong>
u'&lt;input id="username" name="username" type="text" value=""&gt;'
&gt;&gt;&gt; <strong>form.username(class_='red', style='width:300px')</strong>
u'&lt;input class="red" id="username" name="username" style="width:300px" type="text" value=""&gt;'</pre>

<p>The <code>Field</code> has the following constructor:</p>

<pre class="color-syntax">
__init__(label=u'', validators=None, filters=(), description=u'', id=None, default=None,
   widget=None, _form=None, _name=None, _prefix='', _translations=None)</pre>

<ul>
<li><code>validators</code>: a sequence of validators called by <code>validate()</code>. <code>form.validate_on_submit()</code> check on all these validators.</li>

<li><code>filters</code>: a sequence of filter run on input data.</li>

<li><code>description</code>: A description for the field, for tooltip help text.</li>

<li><code>widget</code>: If provided, overrides the widget used to render the field.</li>

</ul>


<p>The commonly-used <code>Field</code>s are:</p>
<ul>
<li><code>TextField</code>: Base <code>Field</code> for the others, for <code>&lt;input type='text'&gt;</code></li>

<li><code>StringField</code>, <code>IntegerField</code>, <code>FloatField</code>, <code>DecimalField</code>, <code>DateField</code>, <code>DateTimeField</code>: subclass of <code>TextField</code>, which display and coerces data into the respective type.</li>

<li><code>BooleanField</code>: rendered as <code>&lt;input type='checkbox'&gt;</code>.</li>
<li><code>RadioField(..., choices=[(value, label)])</code>: rendered as radio buttons.</li>
<li><code>SelectField(..., choices=[(value, label)])</code>: </li>
<li><code>SelectMultipleField(..., choices=[(value, label)])</code></li>
<li><code>FileField</code></li>
<li><code>SubmitField</code></li>
<li><code>HiddenField</code>: rendered as <code>&lt;input type='hidden'&gt;</code>.</li>
<li><code>PasswordField</code>: rendered as <code>&lt;input type='password'&gt;</code>.</li>
<li><code>TextAreaField</code></li>
</ul>

<p>The commonly-used <code>validators</code> are as follows. Most validators have a keyword argument <code>message</code> for a custom error message.</p>
<ul>
<li><code>InputRequired()</code></li>
<li><code>Optional()</code>: allow empty input, and stop the validation chain if input is empty.</li>
<li><code>Length(min=-1, max=-1)</code></li>
<li><code>EqualTo(<em>fieldname</em>)</code></li>
<li><code>NumberRange(min=None, max=None)</code></li>
<li><code>AnyOf(<em>sequence</em>)</code></li>
<li><code>NoneOf(<em>sequence</em>)</code></li>
<li><code>Regexp(<em>regex</em>, flags=0)</code>: flags are regex flags such as <code>re.IGNORECASE</code>.</li>
<li><code>Email()</code></li>
<li><code>URL()</code></li>
</ul>

<h4>Using Flask-WTF 0.12</h4>

<p>Flask integrates WTForms using extension Flask-WTF.</p>

<p>Besides integrating WTForms, Flask-WTF also:</p>
<ul>
<li>provides CSRF protection</li>
<li>supports file upload with Flask-Uploads</li>
<li>supports recaptcha</li>
<li>supports internationalization</li>
</ul>

<p>By default, Flask-WTF protects all forms against Cross-Site Request Forgery (CSRF) attacks. You need to set up an encryption key to generate an encrypted token in <code>app.config</code> dictionary, as follows:</p>

<pre class="color-example">
app = Flask(__name__)
app.config['SECRET_KEY'] = 'a random string'  <span class="color-comment"># Used for CSRF</span></pre>

<p>You can generate a random hex string via:</p>
<pre class="color-example">
import os; os.urandom(24).encode('hex')</pre>

<h5>Example 1: Creating a Login Form</h5>

<p>Create a project directory, e.g., <code>test-flask-wtf</code>.</p>

<p><code>forms1.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(forms1.py) Flask-WTF Example 1: Login Form"""</span>
from flask_wtf import Form  
      <span class="color-comment"># import from flask_wtf, NOT wtforms</span>
from wtforms import StringField, PasswordField  
      <span class="color-comment"># import fields from wtforms</span>
from wtforms.validators import InputRequired, Length
      <span class="color-comment"># import field input validators from wtforms</span>

<span class="color-comment"># Define the LoginRorm class by sub-classing Form</span>
class LoginForm(Form):
   <span class="color-comment"># This form contains two fields with validators</span>
   username = StringField(u'User Name:', validators=[InputRequired(), Length(max=20)])
   passwd = PasswordField(u'Password:', validators=[Length(min=4, max=16)])</pre>

<ol>
<li>You need to import <code>Form</code> from <code>flask_wtf</code>, instead of <code>wtforms</code> (unlike the previous section).</li>
<li>I separated the forms from the app controller below, for better software engineering.</li>
</ol>

<p><code>controller1.py.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(controller1.py) Flask-WTF Example 1: app controller"""</span>
from flask import Flask, render_template
from forms1 import LoginForm

<span class="color-comment"># Initialize Flask app</span>
app = Flask(__name__)
app.config['SECRET_KEY'] = 'YOUR-SECRET'  # Flask-WTF: Needed for CSRF

@app.route('/')
def index():
   <span class="color-comment"># Construct an instance of LoginForm</span>
   form = LoginForm()

   <span class="color-comment"># Render an HTML page, with the login form instance created</span>
   return render_template('login1.html', form=form)

if __name__ == '__main__':
   app.run(debug=True)</pre>

<p><code>templates/login1.html</code></p>

<pre class="color-example">
&lt;form method="POST" action="/"&gt;
  {{ form.hidden_tag() }}<span class="color-comment">{# Renders ALL hidden fields, including the CSRF #}</span>
  {{ form.username.label }} {{ form.username(size=15) }}
  {{ form.passwd.label }} {{ form.passwd(class='passwd') }}
  &lt;input type="submit" value="Go"&gt;
&lt;/form&gt;</pre>

<p>The rendered HTML page is as follows:</p>

<pre class="color-example">
&lt;form method="POST" action="/"&gt;
  &lt;div style="display:none;"&gt;&lt;input id="csrf_token" name="csrf_token" type="hidden" value="xxxx"&gt;&lt;/div&gt;  
  &lt;label for="username"&gt;User Name:&lt;/label&gt; &lt;input id="username" name="username" size="15" type="text" value=""&gt;
  &lt;label for="passwd"&gt;Password:&lt;/label&gt; &lt;input class="passwd" id="passwd" name="passwd" type="password" value=""&gt;
  &lt;input type="submit" value="Go"&gt;
&lt;/form&gt;</pre>

<ol>
<li>As mention, Flask-WTF provides CSRF protection for all pages by default. CSRF protection is carried out via a secret random token in a hidden field called <code>csrf_token</code>, generated automatically by Flask-WTF - you can find this hidden field in the rendered output. However, in your HTML <code>form</code>, you need to include <code>{{ form.hidden_tag() }}</code> or <code>{{ form.csrf_token }}</code> to generate this hidden field. The <code>{{ form.hidden_tag() }}</code> is recommended, as it places all hidden fields, including <code>csrf_token</code> hidden field, inside a hidden <code>&lt;div&gt;</code>, to ensure a valid HTML/XML document.</li>
</ol>


<h5>Example 2: Processing the Login Form</h5>

<p><code>forms2.py</code>: same as <code>forms1.py</code></p>

<p><code>controller2.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(controller2.py) Flask-WTF Example 2: Processing the Login Form"""</span>
from flask import Flask, render_template, request, flash, redirect, url_for
from forms2 import LoginForm

<span class="color-comment"># Initialize Flask app</span>
app = Flask(__name__)
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Flask-WTF: Needed for CSRF</span>

@app.route('/', methods=['get', 'post'])  <span class="color-comment"># Initial request via GET, subsequently POST</span>
def index():
   form = LoginForm()  <span class="color-comment"># Construct an instance of LoginForm</span>

   if form.validate_on_submit():  <span class="color-comment"># POST request with valid input?</span>
      <span class="color-comment"># Verify username and passwd</span>
      if (form.username.data == 'Peter' and form.passwd.data == 'xxxx'):
         return redirect(url_for('start_app'))
      else:
         <span class="color-comment"># Using Flask's flash to output an error message</span>
         flash(u'Username or password incorrect')

   <span class="color-comment"># For the initial GET request, and subsequent invalid POST request,
   # render an HTML page, with the login form instance created</span>
   return render_template('login2.html', form=form)

@app.route('/start_app')
def start_app():
   return 'The app starts here!'

if __name__ == '__main__':
   app.run(debug=True)</pre>
   
<ol>
<li>The initial access to <code>'/'</code> triggers a GET request (default HTTP protocol for a URL access), with <code>form.validate_on_submit()</code> returns <code>False</code>. The <code>form.validate_on_submit()</code> returns True only if the request is POST, and all input data validated by the validators.</li>

<li>Subsequently, user submits the login form via POST request, as stipulated in <code>&lt;form method='POST'&gt;</code> in the HTML <code>form</code>.</li>

<li>If username/password is incorrect, we output a message via <code>flash()</code> using Flask's flashing message facility. This message is available to the next request only.</li>
</ol>

<p><code>templates/base2.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;title&gt;My Application&lt;/title&gt;
  &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="color-comment">{# Display flash messages, if any, for all pages #}</span>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    &lt;ul class='flashes'&gt;
    {% for message in messages %}&lt;li&gt;{{ message }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
  {% endif %}
{% endwith %}

<span class="color-comment">{# The body contents here #}</span>
{% block body %}{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre>

<ol>
<li>We use layer template (or template inheritance) in this example. The base template handles the display of flash messages, applicable to all pages.</li>

<li>The base template displays the flash messages, retrieved via <code>get_flashed_messages()</code>, if any, for ALL the pages.</li>

<li>It defines a block called <code>body</code> for the body contents, to be extended by the sub-templates.</li>
</ol>

<p><code>templates/login2.html</code></p>

<pre class="color-example">
{% extends "base2.html" %}
{% block body %}
&lt;h1&gt;Login&lt;/h1&gt;
&lt;form method="POST"&gt; <span class="color-comment">{# Default action to the same page #}</span>
  {{ form.hidden_tag() }} <span class="color-comment">{# Renders any hidden fields, including the CSRF #}</span>
  {% for field in form if field.widget.input_type != 'hidden' %}
    <span class="color-comment">{# Display filed #}</span>
    &lt;div class="field"&gt;
      {{ field.label }} {{ field }}
    &lt;/div&gt;
    <span class="color-comment">{# Display filed's validation error messages, if any #}</span>
    {% if field.errors %}
      {% for error in field.errors %}
        &lt;div class="field_error"&gt;{{ error }}&lt;/div&gt;
      {% endfor %}
    {% endif %}
  {% endfor %}
  &lt;input type="submit" value="Go"&gt;
&lt;/form&gt;
{% endblock %}</pre>

<ol>
<li>The inherited template first displays the hidden fields, including <code>csrf_token</code>.</li>
<li>It then display ALL the field (except hidden fields) together with the field-errors, via a for-loop.</li>
</ol>

<p>Start the Flask webapp. Issue URL <code>http://localhost:5000</code> and try:</p>
<ol>
<li>Filling in invalid input. Observe the validation error messages.</li>
<li>Filling in valid input, but incorrect username/password. Observe the flash message.</li>
<li>Filling in correct username/password. Observe the redirection.</li>
</ol>

<h5>Message Flashing</h5>
<p>Reference: Message Flashing @ <a href="http://flask.pocoo.org/docs/0.10/patterns/flashing/">http://flask.pocoo.org/docs/0.10/patterns/flashing/</a>.</p>

<p>Good UIUX should provide enough feedback to the users. Flask provides a simple way to give feedback with the flashing system, which records a message at the end of a request and make it available for the next request and only next request.</p>

<p>You can include a category when flashing a message, e.g., error or warning (default is called message), and display or filter messages based on this category. For example,</p>

<pre class="color-example">
flash('This is an error', 'error')</pre>

<p>You can use the category in your template for CSS:</p>
<pre class="color-example">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    &lt;ul class=flashes&gt;
    {% for category, message in messages %}
      &lt;li class="{{ category }}"&gt;{{ message }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
  {% endif %}
{% endwith %}</pre>

<p>You can also filter the flashed message by category, e.g.,</p>

<pre class="color-example">
{% with messages = get_flashed_messages(category_filter=["error"]) %}
  ......
{% endwith %}</pre>


<h5>Custom Validator</h5>
<p>See <a href="https://wtforms.readthedocs.org/en/latest/validators.html#custom-validators">https://wtforms.readthedocs.org/en/latest/validators.html#custom-validators</a>.</p>


<h3>More on Flask</h3>

<h4>Custom Error Pages</h4>
<p>You can provide consistent custom error pages via <code>@app.errorhandler(<em>http-status-code</em>)</code>. For example,</p>

<pre class="color-example">
<strong>@app.errorhandler(404)</strong>
def page_not_found(e):
    return render_template('404.html'), 404

<strong>@app.errorhandler(500)</strong>
def internal_server_error(e):
    return render_template('500.html'), 500</pre>
    
<ol>
<li>The error handlers return a response page, and a numeric error code.</li>
</ol>



<h4>Flask's <code>request</code> object</h4>

<ul>
<li><code>request.method</code>: The request method, such as GET or POST.</li>
<li><code>request.args</code>: a key-value dictionary containing the GET parameters in the URL. For example, in <code>http://localhost/?page=10</code>, the <code>request.args['page']</code> (or <code>request.args.get('page')]</code>) returns 10.</li>
<li><code>request.form</code> dictionary: a dictionary containing the POST parameters sent in the request body as in the above example.</li>
<li><code>request.values</code>: a dictionary containing both GET and POST parameters.</li>
</ul>

<h4>The <code>flask</code>'s <code>session</code> object</h4>

<p>If you need to keep some data from one request to another request for a particular user, but no need to persist them in the database (such as authentication, user information, or shopping cart), use session.</p>

<p><code>flask</code>'s <code>session</code> object is implemented on top of cookies, and encrypts the session values before they are used in cookies. To use <code>session</code>, you need to set a secret key in <code>app.config['SECRET_KEY']</code>. (This value is also used in Flask-WTF for CSRF protection).</p>

<h5>Example: Using <code>flask</code>'s <code>session</code> object</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(app.py) Testing Flask's session"""</span>
from flask import Flask, session, redirect, url_for, escape, request

app = Flask(__name__)
app.config['SECRET_KEY'] = 'Your Secret Key'

@app.route('/')
def index():
   if 'username' in session:
      return 'You are already logged in as %s' % escape(session['username'])
            <span class="color-comment"># Escape special HTML characters (such as &lt;, &gt;) in echoing to prevent XSS</span>
   return (redirect(url_for('login')))

@app.route('/login', methods=['GET', 'POST'])
def login():
   <span class="color-comment"># for the initial GET request</span>
   if request.method == 'POST':
      username = request.form['username']
      session['username'] = username   <span class="color-comment"># Save in session</span>
      return 'Logined in as %s' % escape(username)

   <span class="color-comment"># for subsequent POST request</span>
   return '''
      &lt;form method='POST'&gt;
         &lt;input type='text' name='username'&gt;
         &lt;input type='submit' value='Login'&gt;
      &lt;/form&gt;'''

@app.route('/logout')
def logout():
    <span class="color-comment"># Remove the username from the session if it exists</span>
    session.pop('username', None)
    return redirect(url_for('index'))

if __name__ == '__main__':
   app.run(debug=True)</pre>
   
<ol>
<li>If you are not using template engine, use <code>escape()</code> to escape special HTML characters (such as &lt;, &gt;) to prevent XSS.  Templates ending in <code>.html</code>, etc, provide auto-escape when echoing variables in their rendered output.</li>

<li>You can generate a secret key via &quot;<code>import os; os.urandom(24)</code>&quot;.</li>

</ol>

<p>[TODO] Shopping Cart Example</p>

<h4><code>flask</code>'s <code>g</code> object</h4>

<p>Recall that the <code>session</code> object can be used to store data for a user (thread) that are passed from one request to the next request, in a multi-thread environment.  The <code>g</code> object allows you to store data that is valid for one request only (for a user), i.e., request-global. <code>g</code> is used to pass information from one function into another. You cannot use an ordinary global variable, as it would break in a multi-thread environment.</p>

<p>For example, to check the time taken for a request:</p>

<pre class="color-example">
@app.before_request
def before_request():
   g.start_time = time.time()  <span class="color-comment"># Store in g, applicable for this request and this user only</span>

@app.teardown_request
def teardown_request(exception=None):
    time_taken = time.time() - g.start_time   <span class="color-comment"># Retrieve from g</span>
    print time_taken</pre>

<p>The decorators <code>@app.before_request</code> and <code>@app.teardown_request</code> mark the functions to be run before and after each user's request.</p>

<h4>Flask's Contexts</h4>

<h5>Context Variables and <code>@app.context_processor</code> Decorator</h5>

<p>You can create a set of variables which are available to all the views in their context, by using the <code>context_processor</code> decorator. The decorated function shall return a dictionary of key-value pairs. For example,</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""Defining Context Variables for all Views"""</span>
from flask import Flask, render_template, session
app = Flask(__name__)

<strong>@app.context_processor</strong>
def template_context():
   <span class="color-comment">'''Return a dictionary of key-value pairs,
      which will be available to all views in the context'''</span>
   if 'username' in session:
      username = session['username']
   else:
      username = 'Peter'

   <strong>return {'version':88, 'username':username}</strong>

@app.route('/')
def index():
   return render_template('index.html')

if __name__ == '__main__':
    app.run(debug=True)</pre>
    
<p>The <code>templates/index.html</code> is:</p>
<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Hello, <strong>{{ username }}</strong>&lt;/h1&gt;
&lt;p&gt;Version <strong>{{ version }}</strong>&lt;p&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>


<h5>Context Locals</h5>

<p>Flask's objects like <code>request</code> and <code>session</code> are special global object, that are actually proxies to objects that are local to a specific context.</p>

<p>[TODO]</p>

<h5><code>test_request_context()</code> and <code>request_context()</code></h5>

<p>[TODO]</p>

<h4>Logging</h4>

<p>Reference: Logging Application Errors @ <a href="http://flask.pocoo.org/docs/0.10/errorhandling/">http://flask.pocoo.org/docs/0.10/errorhandling/</a>.</p>

<p>See <a href="Python1_Basics.html#logging">Python Logging</a> for basics on Python <code>logging</code> module.</p>

<p>Proper Logging is ABSOLUTELY CRITICAL!!! </p>

<p>Flask uses the Python built-in logging system.</p>
<ul>
<li>Flask constructs a <code>Logger</code> instance and attach to the current app as <code>app.logger</code>.</li>
<li>You can use <code>app.logger.addhandler()</code> to add a handler, such as <code>SMTPHandler</code>, <code>RotatingFileHandler</code>, or <code>SysLogHanlder</code> (for Unix syslog).</li>
<li>Use <code>app.logger.debug()</code>,... <code>app.logger.critical()</code> to send log message.</li>
</ul>

<h5>Example: Flask's logging</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(app.py) Testing logging under Flask"""</span>
from flask import Flask
app = Flask(__name__)

<span class="color-comment"># Create a file handler</span>
import logging 
from logging.handlers import RotatingFileHandler
handler = RotatingFileHandler('test.log')
handler.setLevel(logging.INFO)
handler.setFormatter(logging.Formatter(
    "%(asctime)s|%(levelname)s|%(message)s|%(pathname)s:%(lineno)d"))
app.logger.addHandler(handler)
app.logger.setLevel(logging.DEBUG)

app.logger.debug('A debug message')
app.logger.info('An info message')
app.logger.warning('A warning message')
app.logger.error('An error message')
app.logger.critical('A critical message')

@app.route('/')
def index():
   return 'Hello, world!'

if __name__ == '__main__':
   app.run(debug=True)</pre>

<p>To include other libraries' (such as SQLAlchmey):</p>

<pre class="color-example">
from logging import getLogger
loggers = [app.logger,
           getLogger('sqlalchemy'),
           getLogger('otherlibrary')]
for logger in loggers:
   logger.addHandler(mail_handler)
   logger.addHandler(file_handler)</pre>


<h4>Configuration and Flask's <code>app.config</code> object</h4>

<p>Reference: Flask Configuration @ <a href="http://flask.pocoo.org/docs/0.10/config/">http://flask.pocoo.org/docs/0.10/config/</a>.</p>

<h5>The <code>app.config</code> object</h5>

<p>The Flask app maintains its configuration in a <code>app.config</code> dictionary. You can extend with your own configuration settings, e.g.,</p>

<pre class="color-example">
from flask import Flask
app = Flask(__name__)

app.config['DEBUG'] = True  <span class="color-comment"># in uppercase</span>
print(app.config['DEBUG'])
print(app.debug)            <span class="color-comment"># proxy to app.config['DEBUG']</span></pre>

<p>The keys in <code>app.config</code> must be in UPPERCASE, e.g., <code>app.config['DEBUG']</code>, <code>app.config['SECRET_KEY']</code>.</p>

<p>Some <code>app.config</code> values are also forwarded to Flask's object. For example, <code>app.config['DEBUG']</code> is the same as <code>app.debug</code> (in lowercase), <code>app.config['SECRET_KEY']</code> is the same as <code>app.secret_key</code>.</p>

<h5>Configuration File's Format</h5>

<p>There are many options to maintain configuration files:</p>
<ul>
<li><code>INI</code> file with <code>ConfigParser</code>: see <a href="Python1_Basics.html#configparser">Python ConfigParser</a>.</li>

<li>Raw Python Class: See below</li>
<li>JSON</li>
<li>YAML</li>
</ul>

<h5>Using <code>from_object()</code> and <code>from_envvar()</code> to load <code>app.config</code></h5>

<p>You can use <code>app.config.from_object()</code> to load attributes (in uppercase) from a python module or <code>app.config.from_env()</code> to load from a file indicated in an environment variable.</p>

<p>For example,</p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;config.py: Configuration&quot;&quot;&quot;
DEBUG = True
SECRET_KEY = 'your-secret-key'
USERNAME = 'admin'
invalid_key = 'hello'   <span class="color-comment"># lowercase not loaded</span></pre>

<pre class="color-example">
from flask import Flask
 
app = Flask(__name__)
app.config.from_object('config')
     <span class="color-comment"># Load the uppercase variables from config.py into app.config</span>
 
print(app.config['DEBUG'])
print(app.debug)            <span class="color-comment"># 'DEBUG' has a proxy</span>
print(app.config['SECRET_KEY'])
print(app.secret_key)       <span class="color-comment"># 'SECRET_KEY' also has a proxy</span>
print(app.config['USERNAME'])
<span class="color-comment"># print(app.username)       # no attribute 'username'</span>
<span class="color-comment"># print(app.config['invalid_key'])  # KeyError: 'invalid_key'</span></pre>

<p>You can keep a default configuration file, which can be overridden by setting in environment variables. For example,</p>

<pre class="color-example">
from flask import Flask
 
app = Flask(__name__)
 
<span class="color-comment"># Load from a Python module</span>
app.config.from_object('config')   <span class="color-comment"># config.py</span>
 
<span class="color-comment"># Load from an environment variable</span>
<span class="color-comment"># Set the environment variable FLASK_SETTINGS as follows before running the app:</span>
<span class="color-comment"># export FLASK_SETTINGS=more_config.py</span>
app.config.from_envvar('FLASK_SETTINGS', silent=True)
      <span class="color-comment"># Override existing values
      # silent=True: Ignore if no such environment variable exists</span>
print(app.config['USERNAME'])</pre>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;more_config.py: Configuration&quot;&quot;&quot;
USERNAME = 'peter'</pre>



<h3>SQLAlchemy</h3>
<p>Reference: SQLAlchemy @ <a href="http://www.sqlalchemy.org/">http://www.sqlalchemy.org/</a>.</p>
<br />

<p>SQLAlchemy is great for working with relational databases. It is the Python SQL toolkit and Object Relational Mapper (ORM) that gives you the full power and flexibility of SQL. It works with MySQL, PostgreSQL, SQLite, and other relational databases.</p>

<p>SQLAlchemy implements the Model of the MVC architecture for Python-Flask webapps.</p>

<h4>Installing SQLAlchemy</h4>

<pre class="color-command">
$ <strong>sudo pip install sqlalchemy</strong>

$ <strong>pip show --files sqlalchemy</strong>
Name: SQLAlchemy
Version: <strong>1.0.9</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires:</pre>

<h4>Using SQLAlchemy with MySQL</h4>

<h5>Installing MySQL Driver for Python</h5>

<pre class="color-command">
<span class="color-comment"># Need these package to build the MySQL-Python driver</span>
$ <strong>sudo apt-get install python-dev libmysqlclient-dev</strong>

<span class="color-comment"># Install MySQL-Python driver</span>
$ <strong>sudo pip install MySQL-python</strong>

<span class="color-comment"># Verify the installation</span>
$ <strong>sudo pip show --files MySQL-python</strong>
Name: MySQL-python
Version: <strong>1.2.5</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires:</pre>

<h5>Setting up MySQL</h5>

<p>Login to MySQL. Create a test user (called <code>testuser</code>) and a test database (called <code>testdb</code>) as follows:</p>

<pre class="color-command">
$ <strong>mysql -u root -p</strong>
mysql&gt; <strong>create user 'testuser'@'localhost' identified by 'xxxx';</strong>
mysql&gt; <strong>create database if not exists testdb;</strong>
mysql&gt; <strong>grant all on testdb.* to 'testuser'@'localhost';</strong>
mysql&gt; <strong>quit</strong></pre>

<h5>Example 1: Connecting to MySQL and Executing SQL statements</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""(sqlalchemy_app1.py) SQLAlchemy Example 1: Testing with MySQL"""</span>
from sqlalchemy import create_engine
engine = create_engine('mysql://testuser:xxxx@localhost:3306/testdb')

engine.echo = True  <span class="color-comment"># Echo output to console</span>

<span class="color-comment"># Create a database connection</span>
conn = engine.connect()
conn.execute('DROP TABLE IF EXISTS cafe')
conn.execute('''CREATE TABLE IF NOT EXISTS cafe (
                  id INT UNSIGNED NOT NULL AUTO_INCREMENT,
                  category ENUM('tea', 'coffee') NOT NULL,
                  name VARCHAR(50) NOT NULL,
                  price DECIMAL(5,2) NOT NULL,
                  PRIMARY KEY(id)
                )''')

<span class="color-comment"># Insert one record</span>
conn.execute('''INSERT INTO cafe (category, name, price) VALUES
                  ('coffee', 'Espresso', 3.19)''')

<span class="color-comment"># Insert multiple records</span>
conn.execute('''INSERT INTO cafe (category, name, price) VALUES
                  ('coffee', 'Cappuccino', 3.29),
                  ('coffee', 'Caffe Latte', 3.39),
                  ('tea', 'Green Tea', 2.99),
                  ('tea', 'Wulong Tea', 2.89)''')

<span class="color-comment"># Query table</span>
for row in conn.execute('SELECT * FROM cafe'):
   print(row)

<span class="color-comment"># give connection back to the connection pool</span>
conn.close()</pre>

<p>In this example, we issue raw SQL statements through SQLAlchemy, which is NOT the right way of using SQLAlchemy.</p>

<p>Study the console message (enabled via <code>db.echo = True</code>) and the output.  Take note that a COMMIT is issued after the CREATE TABLE and INSERT statements (i.e., in auto-commit mode).</p>

<h4>Using SQLAlchemy ORM (Object-Relational Mapper)</h4>

<p>Reference: Object Relational Tutorial @ <a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html">http://docs.sqlalchemy.org/en/latest/orm/tutorial.html</a>.</p>

<p>Instead of writing raw SQL statements, which are tedious, error-prone, inflexible and hard-to-maintain, we can use an ORM (Object-Relational Mapper).</p>

<p>SQLAlchemy has a built-in ORM, which lets you work with relational database tables as if there were native object instances (having attributes and methods). Furthermore, you can include additional attributes and methods to these objects.</p>

<h5>Example 2: Using ORM to CREATE/DROP TABLE, INSERT, SELECT, and DELETE</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""(sqlalchemy_app2.py) SQLAlchemy Example 2: Using ORM"""</span>
from sqlalchemy import create_engine, Column, Integer, String, Enum, Numeric
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, scoped_session

<span class="color-comment"># Get the base class of our models</span>
Base = declarative_base()

<span class="color-comment"># Define Object Mapper for table `cafe`
# CREATE TABLE cafe (
#    id INTEGER NOT NULL AUTO_INCREMENT, 
#    category ENUM('tea','coffee'), 
#    name VARCHAR(50), 
#    price NUMERIC(5, 2), 
#    PRIMARY KEY (id)
# )</span>
class Cafe(Base):
   __tablename__ = 'cafe'

   id = Column(Integer, primary_key=True, autoincrement=True)
   category = Column(Enum('tea', 'coffee'))
   name = Column(String(50))
   price = Column(Numeric(precision=5, scale=2))

   def __init__(self, category, name, price, id=None):
      <span class="color-comment">"""Constructor"""</span>
      if id:
         self.id = id   <span class="color-comment"># Otherwise, default to auto-increment</span>
      self.category = category
      self.name = name
      self.price = price
      <span class="color-comment"># NOTE: You can use the default constructor,
      #   which accepts all the fields as keyword arguments</span>

   def __repr__(self):
      <span class="color-comment">"""Show this object (database record)"""</span>
      return "&lt;Cafe(%d, %s, %s, %5.2f)&gt;" % (
         self.id, self.category, self.name, self.price)

<span class="color-comment"># Create a database engine</span>
engine = create_engine('mysql://testuser:xxxx@localhost:3306/testdb')
engine.echo = True  <span class="color-comment"># Echo output to console for debugging</span>

<span class="color-comment"># Drop all tables mapped in Base's subclasses</span>
Base.metadata.drop_all(engine)

<span class="color-comment"># Create all tables mapped in Base's subclasses</span>
Base.metadata.create_all(engine)

<span class="color-comment"># Create a database session binded to our engine, which serves as a staging area
# for changes to the objects. To make persistent changes to database, call
# commit(); otherwise, call rollback() to abort.</span>
Session = scoped_session(sessionmaker(bind=engine))
dbsession = Session()

<span class="color-comment"># Insert one row via add(instance) and commit</span>
<span class="color-comment"># Construct a Cafe instance via the constructor</span>
dbsession.add(Cafe('coffee', 'Espresso', 3.19))
<span class="color-comment"># INSERT INTO cafe (category, name, price) VALUES ('coffee', 'Espresso', 3.19)</span>
dbsession.commit()

<span class="color-comment"># Insert multiple rows via add_all(list_of_instances) and commit</span>
dbsession.add_all([Cafe('coffee', 'Cappuccino', 3.29), 
                 Cafe('tea', 'Green Tea', 2.99, id=8)])  <span class="color-comment"># using kwarg for id</span>
dbsession.commit()

<span class="color-comment"># Select all rows. Return a list of Cafe instances</span>
for instance in dbsession.query(Cafe).all():
   print(instance.category, instance.name, instance.price)
<span class="color-comment"># SELECT cafe.id AS cafe_id, cafe.category AS cafe_category, 
#   cafe.name AS cafe_name, cafe.price AS cafe_price FROM cafe
# ('coffee', 'Espresso', Decimal('3.19'))
# ('coffee', 'Cappuccino', Decimal('3.29'))
# ('tea', 'Green Tea', Decimal('2.99'))</span>

<span class="color-comment"># Select the first row with order_by. Return one instance of Cafe</span>
instance = dbsession.query(Cafe).order_by(Cafe.name).first()
print(instance)   <span class="color-comment"># Invoke __repr__()</span>
<span class="color-comment"># SELECT cafe.id AS cafe_id, cafe.category AS cafe_category, 
#   cafe.name AS cafe_name, cafe.price AS cafe_price 
# FROM cafe ORDER BY cafe.name LIMIT (1,)
# &lt;Cafe(2, coffee, Cappuccino,  3.29)&gt;</span>

<span class="color-comment"># Using filter_by on column</span>
for instance in dbsession.query(Cafe).filter_by(category='coffee').all():
   print(instance.__dict__)   <span class="color-comment"># Print object as key-value pairs</span>
<span class="color-comment"># SELECT cafe.id AS cafe_id, cafe.category AS cafe_category, 
#   cafe.name AS cafe_name, cafe.price AS cafe_price 
# FROM cafe WHERE cafe.category = ('coffee',)</span>

<span class="color-comment"># Using filter with criterion</span>
for instance in dbsession.query(Cafe).filter(Cafe.price &lt; 3).all():
   print(instance)
<span class="color-comment"># SELECT cafe.id AS cafe_id, cafe.category AS cafe_category, 
#   cafe.name AS cafe_name, cafe.price AS cafe_price 
# FROM cafe WHERE cafe.price &lt; (3,)</span>

<span class="color-comment"># Delete rows</span>
instances_to_delete = dbsession.query(Cafe).filter_by(name='Cappuccino').all()
for instance in instances_to_delete:
   dbsession.delete(instance)
dbsession.commit()
<span class="color-comment"># DELETE FROM cafe WHERE cafe.id = (2L,)</span>

for instance in dbsession.query(Cafe).all():
   print(instance)</pre>
   
<p>Study the log messages produced. Instead of issuing raw SQL statement (of INSERT, SELECT), we program on the objects. The ORM interacts with the underlying relational database by issuing the appropriate SQL statements. Take note that you can include additional attributes and methods in the <code>Cafe</code> class to facilitate your application.</p>

<p>Executing Query:</p>
<ul>
<li><code>get(<em>primary-key-id</em>)</code>: execute the query with the primary-key identifier, return an object or None.</li>
<li><code>all()</code>: executes the query and return a list of objects.</li>
<li><code>first()</code>: executes the query with LIMIT 1, and returns the result row as tuple, or None if no rows were found.</li>
<li><code>one()</code>: executes the query and raises <code>MultipleResultsFound</code> if more than one row found; <code>NoResultsFound</code> if no rows found. Otherwise, it returns the sole row as tuple.</li>
<li><code>one_or_none()</code>: executes the query and raises <code>MultipleResultsFound</code> if more than one row found. It return None if no rows were found, or the sole row.</li>
<li><code>scaler()</code>: executes the query and raises <code>MultipleResultsFound</code> if more than one row found. It return None if no rows were found, or the &quot;first column&quot; of the sole row.</li>
</ul>

<p>Filtering the Query object, and return a Query object:</p>
<ul>
<li><code>filter(*<em>criterion</em>)</code>: filtering criterion in SQL WHERE expressions, e.g., <code>id > 5</code>.</li>
<li><code>filter_by(**kwargs)</code>: filtered using keyword expressions (in Python), e.g., <code>name = 'some name'</code>.</li>
</ul>

<h5>Example 3: ORM with One-to-Many Relation</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""(sqlalchemy_app3.py) SQLAlemcy Example 3: Using ORM with one-to-many relation"""</span>
from sqlalchemy import create_engine, Column, Integer, String, Enum, Numeric, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from sqlalchemy.orm import sessionmaker, scoped_session

<span class="color-comment"># Get the base class of our models</span>
Base = declarative_base()

<span class="color-comment"># Define Object Mapper for table supplier
# CREATE TABLE supplier (
#    id INTEGER NOT NULL AUTO_INCREMENT, 
#    name VARCHAR(50), 
#    PRIMARY KEY (id)
# )</span>
class Supplier(Base):
   __tablename__ = 'supplier'
   id = Column(Integer, primary_key=True, autoincrement=True)
   name = Column(String(50))
   items = relationship('Cafe', backref='item_supplier')

   def __repr__(self):
      return "&lt;Supplier(%d, %s)&gt;" % (self.id, self.name)

<span class="color-comment"># Define Object Mapper for table cafe
# CREATE TABLE cafe (
#    id INTEGER NOT NULL AUTO_INCREMENT, 
#    category ENUM('tea','coffee'), 
#    name VARCHAR(50), 
#    price NUMERIC(5, 2), 
#    supplier_id INTEGER, 
#    PRIMARY KEY (id), 
#    FOREIGN KEY(supplier_id) REFERENCES supplier (id)
# )</span>
class Cafe(Base):
   __tablename__ = 'cafe'
   id = Column(Integer, primary_key=True, autoincrement=True)
   category = Column(Enum('tea', 'coffee'), default='coffee')
   name = Column(String(50))
   price = Column(Numeric(precision=5, scale=2))
   supplier_id = Column(Integer, ForeignKey('supplier.id'))
   supplier = relationship('Supplier', backref='cafe_items', order_by=id)

   def __repr__(self):
      return "&lt;Cafe(%d, %s, %s, %5.2f, %d)&gt;" % (
             self.id, self.category, self.name, self.price, self.supplier_id)

<span class="color-comment"># Create a database engine</span>
engine = create_engine('mysql://testuser:xxxx@localhost:3306/testdb')
engine.echo = True  <span class="color-comment"># Echo output to console for debugging</span>

<span class="color-comment"># Drop all tables</span> 
Base.metadata.drop_all(engine)

<span class="color-comment"># Create all tables</span>
Base.metadata.create_all(engine)

<span class="color-comment"># Create a database session binded to our engine, which serves as a staging area
# for changes to the objects. To make persistent changes to database, call
# commit() or rollback().</span>
Session = scoped_session(sessionmaker(bind=engine))
dbsession = Session()

<span class="color-comment"># Insert one row via add(instance)</span>
dbsession.add(Supplier(id=501, name='ABC Corp'))
dbsession.add(Supplier(id=502, name='XTZ Corp'))
dbsession.commit()

<span class="color-comment"># Insert multiple rows via add_all(list_of_instances)</span>
dbsession.add_all([Cafe(name='Espresso', price=3.19, supplier_id=501),
                 Cafe(name='Cappuccino', price=3.29, supplier_id=501), 
                 Cafe(category='tea', name='Green Tea', price=2.99, supplier_id=502)])
dbsession.commit()

<span class="color-comment"># Query table with join</span>
for c, s in dbsession.query(Cafe, Supplier).filter(Cafe.supplier_id==Supplier.id).all():
   print(c)
   print(s)
<span class="color-comment"># SELECT cafe.id AS cafe_id, cafe.category AS cafe_category, cafe.name AS cafe_name, 
#   cafe.price AS cafe_price, cafe.supplier_id AS cafe_supplier_id, 
#   supplier.id AS supplier_id, supplier.name AS supplier_name 
# FROM cafe, supplier WHERE cafe.supplier_id = supplier.id
# &lt;Cafe(1, coffee, Espresso,  3.19, 501)&gt;
# &lt;Supplier(501, ABC Corp)&gt;
# &lt;Cafe(2, coffee, Cappuccino,  3.29, 501)&gt;
# &lt;Supplier(501, ABC Corp)&gt;
# &lt;Cafe(3, tea, Green Tea,  2.99, 502)&gt;
# &lt;Supplier(502, XTZ Corp)&gt;</span>

for instance in dbsession.query(Supplier.name, Cafe.name).join(Supplier.items).filter(Cafe.category=='coffee').all():
   print(instance)
<span class="color-comment"># SELECT supplier.name AS supplier_name, cafe.name AS cafe_name 
# FROM supplier INNER JOIN cafe ON supplier.id = cafe.supplier_id 
# WHERE cafe.category = ('coffee',)
# ('ABC Corp', 'Espresso')
# ('ABC Corp', 'Cappuccino')</span></pre>
   
<p>How it Works [TODO]</p>
<ol>
<li>Defining relation via <code>relationship</code>.</li>
<li>Query with JOIN.</li>
</ol>

<h5>Many-to-Many Relationship</h5>

<p>See Flask-SQLAlchemy.</p>

<h5>Transaction and DB session</h5>

<p>See Flask-SQLAlchemy.</p>
   


<h4>Flask-SQLAlchemy</h4>

<p>Reference: Flask-SQLAlchemy @ <a href="http://flask-sqlalchemy.pocoo.org/2.1/">http://flask-sqlalchemy.pocoo.org/2.1/</a>.</p>

<p>Flask-SQLAlchemy is a thin extension that wraps SQLAlchemy around Flask. It
allows you to configure the SQLAlchemy engine through Flask webapp's configuration file and binds a database session to each request for handling transactions.</p>

<p>To install Flask-SQLAlchemy:</p>

<pre class="color-command">
$ <strong>sudo pip install flask-sqlalchemy</strong>

$ <strong>pip show --files flask-sqlalchemy</strong>
Name: Flask-SQLAlchemy
Version: <strong>2.1</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: Flask, SQLAlchemy</pre>

<h5>Example 1: Running SQLAlchemy under Flask Webapp</h5>

<p>In this example, we shall separate the Model from the Controller, as well as the web forms and templates.</p>

<p><code>models1.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[models1] Flask-SQLAlchemy EG 1: Define Models and Database Interfaces.
&quot;&quot;&quot;
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Configure and initialize SQLAlchemy under this Flask webapp.</span>
db = SQLAlchemy()
 
class Cafe(db.Model):
   &quot;&quot;&quot;
   Define the 'Cafe' model mapped to database table 'cafe'.
   &quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), nullable=False, default='coffee')
   name = db.Column(db.String(50), nullable=False)
   price = db.Column(db.Numeric(precision=5, scale=2), nullable=False, default=999.99)
 
   def __repr__(self):
      &quot;&quot;&quot;Describe itself.&quot;&quot;&quot;
      return &quot;&lt;Cafe(%d, %s, %s, %5.2f)&lt;&quot; % (
         self.id, self.category, self.name, self.price)
 
def load_db(db):
   &quot;&quot;&quot;Create database tables and insert records&quot;&quot;&quot;
   <span class="color-comment"># Drop and re-create all the tables.</span>
   db.drop_all()
   db.create_all()
 
   <span class="color-comment"># Insert rows using add_all(list_of_instances).</span>
   <span class="color-comment"># Use the default constructor with keyword arguments.</span>
   db.session.add_all([
         Cafe(name='Espresso', price=3.19),
         Cafe(name='Cappuccino', price=3.29),
         Cafe(name='Green Tea', category='tea', price=2.99)])
   db.session.commit()  <span class="color-comment"># Always commit after insert</span></pre>

<ol>
<li>Flask-SQLAlchemy is simpler than the pure SQLAlchemy! You initialize via <code>db = SQLAlchemy()</code>, and subsequently access all properties via <code>db</code>.</li>

<li>The default tablename is derived from the classname converted to lowercase; or <code>CamelCase</code> converted to <code>camel_case</code>. You can also set via <code>__tablename__</code> property.</li>

<li>Flask-SQLAlchemy's base model class defines a constructor that takes <code>**kwargs</code> and stores all the keyword arguments given. Hence, there is no need to define a constructor.  However, if you need to define a constructor, do it this way:
<pre class="color-example">
def __init__(self, your-args, **kwargs):
   super(User, self).__init__(**kwargs)  <span class="color-comment"># Invoke the superclass keyword constructor</span>
   <span class="color-comment"># your custom initialization here</span></pre></li>

<li>The <code>db.drop_all()</code> and <code>db.create_all()</code> drops and create all tables defined under this <code>db.Model</code>. To create a single table, use <code>ModelName.__table__.create(db.session.bind)</code>. You can include <code>checkfirst=True</code> to add &quot;IF NOT EXISTS&quot;.</li>

</ol>   

<p><code>controller1.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[controllers1] Flask-SQLAlchemy EG 1: Main controller.
&quot;&quot;&quot;
from flask import Flask, render_template, redirect, flash, abort
from models1 import db, Cafe, load_db  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask: Initialize</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask webapp</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
@app.route(&quot;/&quot;)
@app.route(&quot;/&lt;id&gt;&quot;)
def index(id=None):
   if id:
      _item_list = Cafe.query.filter_by(id=id).all()
   else:
      _item_list = Cafe.query.all()
 
   <span class="color-comment"># You can also handle empty list via abort with 404</span>
   <span class="color-comment">#if not item_list: abort(404)</span>
 
   return render_template('list1.html', item_list=_item_list)
 
if __name__ == '__main__':
   app.debug = True  <span class="color-comment"># Turn on auto reloader and debugger</span>
   app.config['SQLALCHEMY_ECHO'] = True  <span class="color-comment"># Show SQL commands created</span>
   app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = True
   app.run()</pre>

<ol>
<li>You need to issue <code>load_db(db)</code> under the <code>test_request_context()</code>, which tells Flask to behaves as if it is handling a request.</li>
</ol>

<p><code>templates/list1.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Cafe List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Cafe List&lt;/h1&gt;
{% if not item_list %}
  &lt;p&gt;No item found&lt;/p&gt;
{% else %}
  &lt;ul&gt;
    {% for item in item_list %}&lt;li&gt;{{ item.name }}, {{ item.category }}, ${{ item.price }}&lt;/li&gt;
    {% endfor %}
  &lt;/ul&gt;
{% endif %}
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>Try:</p>

<ul>
<li><code>http://127.0.0.1:5000</code>: List all (3) items.</li>
<li><code>http://127.0.0.1:5000/1</code>: List item with <code>id=1</code>.</li>
<li><code>http://127.0.0.1:5000/4</code>: No such <code>id</code>.</li>
</ul>

<h5>Example 2: Using One-to-Many Relation</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[models2] Flask-SQLAlchemy EG 2: Define Models and Database Interface
&quot;&quot;&quot;
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
db = SQLAlchemy()
 
class Supplier(db.Model):
   &quot;&quot;&quot;
   Define model 'Supplier' mapped to table 'supplier' (default lowercase).
   &quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   name = db.Column(db.String(50), nullable=False)
   items = db.relationship('Cafe', backref='supplier', lazy='dynamic')
      <span class="color-comment"># Relate to objects in Cafe model</span>
      <span class="color-comment"># backref: In 'Cafe', add a property called 'supplier',</span>
      <span class="color-comment">#    such that this object can be referenced as a_cafe_instance.supplier</span>
      <span class="color-comment"># lazy='dynamic': See notes.</span>
 
   def __repr__(self):
      return &quot;&lt;Supplier(%d, %s)&gt;&quot; % (self.id, self.name)
 
class Cafe(db.Model):
   &quot;&quot;&quot;
   Define model 'Cafe' mapped to table 'cafe' (default lowercase).
   &quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), default='coffee')
   name = db.Column(db.String(50))
   price = db.Column(db.Numeric(precision=5, scale=2), default=999.99)
   supplier_id = db.Column(db.Integer, db.ForeignKey('supplier.id'))
   <span class="color-comment"># A backref called 'supplier' is defined in 'Supplier'</span>
 
   def __repr__(self):
      return &quot;&lt;Cafe(%d, %s, %s, %5.2f, %d)&gt;&quot; % (
             self.id, self.category, self.name, self.price, self.supplier_id)
 
def load_db(db):
   &quot;&quot;&quot;Load the database tables and records&quot;&quot;&quot;
   <span class="color-comment"># Drop and re-create all the tables</span>
   db.drop_all()
   db.create_all()
 
   <span class="color-comment"># Insert single row via add(instance) and commit</span>
   db.session.add(Supplier(name='AAA Corp', id=501))
   db.session.add(Supplier(name='BBB Corp', id=502))
   db.session.commit()
 
   <span class="color-comment"># Insert multiple rows via add_all(list_of_instances) and commit</span>
   db.session.add_all([
         Cafe(name='Espresso', price=3.19, supplier_id=501),
         Cafe(name='Cappuccino', price=3.29, supplier_id=501),
         Cafe(name='Green Tea', category='tea', price=2.99, supplier_id=502)])
   db.session.commit()
 
   <span class="color-comment"># You can also add record thru relationship</span>
   _item = Cafe(name='latte', price=3.99)  <span class="color-comment"># without the supplier_id</span>
   _supplier = Supplier(name='XXX Corp', id=503, items=[_item])
         <span class="color-comment"># OR:</span>
         <span class="color-comment"># _supplier = Supplier(name='XXX Corp', id=503)</span>
         <span class="color-comment"># _supplier.items.append(_item)</span>
   db.session.add(_supplier)  <span class="color-comment"># also add _item</span>
   db.session.commit()</pre>

<ol>
<li>In this example, the <code>Supplier</code> is the parent table; the <code>Cafe</code> is the child table. There is a one-to-many relationship between parent and the child tables.</li>
<li>In <code>Supplier</code> (the parent table), a <code>relationship</code> is defined, with a <code>backref</code> for the child table to reference the parent table.</li>

<li>In <code>Cafe</code> (the child table), you can access the parent via the <code>backref</code> defined in the <code>relationship</code> in the parent table. For example, in '<code>Cafe</code>', we use <code>backref</code> of '<code>supplier</code>' to reference the <code>Supplier</code> object (in <code>list2.html</code>).</li>

<li>Take note that the SQLAlchemy manages the relationship internally! Study the codes in adding objects via relationship, in the above example.</li>

<li>With the use of <code>backref</code> to establish bi-directional relationship, you can also define the <code>relationship</code> in the child class.</li>

<li>The <code>lazy</code> parameter specifies the loading strategy, i.e., controls when the child record is loaded - lazily (loaded during the first access) or eagerly (loaded together with the parent record):
<ul>
<li><code>select</code> (default): lazily loaded using a SQL SELECT statement.</li>
<li><code>immediate</code> (default): eagerly loaded using a SQL SELECT statement.</li>
<li><code>joined</code>: eagerly loaded with a SQL JOIN statement.</li>
<li><code>subquery</code>: eagerly loaded with a SQL subquery.</li>
<li><code>dynamic</code>: lazily loaded by returning a <code>Query</code> object, which you can further refine using filters, before executing the Query.</li>
<li><code>noload</code>: no loading for supporting &quot;write-only&quot; attribute.</li>
</ul>
You can also set the <code>lazy</code> for the <code>backref</code> using the <code>backref()</code> function<br />
You can enable <code>SQLALCHEMY_ECHO</code> to study the various loading strategies.</li>

<li>In ForeignKey(), you can include keywords <code>onupdate</code> and <code>ondelete</code> with values of <code>CASCADE</code>, <code>SET NULL</code></li>

<li>You can use <code>PrimaryKeyConstraint</code> to set the primary key to a combination of columns.</li>

<li>To define a foreign key with multiple columns, use <code>ForeignKeyConstraint</code>.</li>

<li>UNIQUE: You can set a column to unique via <code>unique=True</code>; or a combination of columns via <code>UniqueConstraint()</code>.</li>

<li>INDEX: You can build index on a column via <code>index=True</code>; or a combination of columns via <code>Index()</code>.</li>
</ol>

<p><code>controller2.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[controller2] Flask-SQLAlchemy EG 2: Using one-to-many relation.
&quot;&quot;&quot;
from flask import Flask, render_template, redirect, flash, abort
from models2 import db, Supplier, Cafe, load_db  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask: Initialize</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
@app.route(&quot;/&quot;)
@app.route(&quot;/&lt;id&gt;&quot;)
def index(id=None):
   if id:
      _items = Cafe.query.filter_by(id=id).all()
   else:
      _items = Cafe.query.all()
 
   if not _items:
      abort(404)
 
   return render_template('list2.html', item_list=_items)
 
if __name__ == '__main__':
   app.config['SQLALCHEMY_ECHO'] = True
   app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = True
   app.debug = True
   app.run()</pre>

<p><code>templates/list2.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Cafe List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Cafe List&lt;/h1&gt;
&lt;ul&gt;
  {% for item in item_list %}
  &lt;li&gt;{{ item.name }}, {{ item.category }}, ${{ item.price }}, {{ item.supplier.name }}&lt;/li&gt;
  {% endfor %}
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<h5>Defining <code>relationship</code></h5>

<p>For one-to-many:</p>

<pre class="color-example">
class Parent(db.Model): <span class="color-comment"># default tablename 'parent'.</span>
   id = db.Column(db.Integer, primary_key=True)
   children = db.relationship("Child", backref='parent', lazy='dynamic')

class Child(db.Model):  <span class="color-comment"># default tablename 'child'.</span>
   id = db.Column(db.Integer, primary_key=True)
   parent_id = db.Column(db.Integer, db.ForeignKey('parent.id'))
   <span class="color-comment"># property 'parent' defined via backref.</span></pre>

<p>For many-to-one:</p>

<pre class="color-example">
class Parent(db.Model):  <span class="color-comment"># default tablename 'parent'.</span>
   id = db.Column(db.Integer, primary_key=True)
   child_id = db.Column(db.Integer, db.ForeignKey('child.id'))
   child = db.relationship('Child', backref=db.backref('parents', lazy='dynamic'))

class Child(db.Model):  <span class="color-comment"># default tablename 'child'.</span>
   id = db.Column(db.Integer, primary_key=True)
   <span class="color-comment"># property 'parents' defined via backref.</span></pre>

<p>For one-to-one:</p>

<pre class="color-example">
class Parent(db.Model): <span class="color-comment"># default tablename 'parent'.</span>
   id = db.Column(db.Integer, primary_key=True)
   child = db.relationship("Child", uselist=False, backref=db.backref("parent", uselist=False))
         <span class="color-comment"># uselist=False for one-to-one.</span>

class Child(db.Model):  <span class="color-comment"># default tablename 'child'.</span>
   id = db.Column(db.Integer, primary_key=True)
   parent_id = db.Column(db.Integer, db.ForeignKey('parent.id'))
   <span class="color-comment"># Property 'parent' defined via backref.</span></pre>

<p>For many-to-many:</p>

<pre class="color-example">
joint_table = db.Table('joint_table',
    db.Column('left_id', db.Integer, db.ForeignKey('left.id')),
    db.Column('right_id', db.Integer, db.ForeignKey('right.id')))

class Left(db.Model):
   __tablename__ = 'left'
   id = db.Column(db.Integer, primary_key=True)
   rights = db.relationship('Right', secondary='joint_table', lazy='dynamic', 
         backref=db.backref('lefts', lazy='dynamic'))
         <span class="color-comment"># Relate to 'Right' thru an intermediate secondary table</span>

class Right(db.Model):
   __tablename__ = 'right'
   id = db.Column(db.Integer, primary_key=True)
   <span class="color-comment"># Property 'lefts' defined via backref.</span></pre>

<p>For many-to-many with additional columns in an Association Object</p>

<pre class="color-example">
class Association(db.Model):
   __tablename__ = 'association'
   left_id = db.Column(db.Integer, db.ForeignKey('left.id'), primary_key=True)
   right_id = db.Column(db.Integer, db.ForeignKey('right.id'), primary_key=True)
   extra_column = db.Column(String(50))

class Left(db.Model):
   __tablename__ = 'left'
   id = db.Column(db.Integer, primary_key=True)
   rights = db.relationship("Right", secondary=Association, backref="lefts")

class Right(db.Model):
   __tablename__ = 'right'
   id = db.Column(db.Integer, primary_key=True)
   <span class="color-comment"># property 'lefts' defined via backref.</span></pre>


<h5>Example 3: Using Many-to-Many relation with an Association Table</h5>

<p><code>models3.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[models3] Flask-SQLAlchemy EG 3: Define Models and Database Interface
&quot;&quot;&quot;
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
db = SQLAlchemy()
 
<span class="color-comment"># Define the joint table between 'cafe' and 'supplier'.</span>
cafe_supplier = db.Table('cafe_supplier',
    db.Column('cafe_id', db.Integer, db.ForeignKey('cafe.id')),
    db.Column('supplier_id', db.Integer, db.ForeignKey('supplier.id'))
)
 
class Cafe(db.Model):
   &quot;&quot;&quot;Define model 'Cafe' mapped to table 'cafe' (default lowercase).&quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), default='coffee')
   name = db.Column(db.String(50))
   price = db.Column(db.Numeric(precision=5, scale=2), default=999.99)
   suppliers = db.relationship('Supplier', secondary=cafe_supplier,
         backref=db.backref(&quot;items&quot;, lazy='dynamic'), lazy='dynamic')
 
   def __repr__(self):
      return &quot;&lt;Cafe(%d, %s, %s, %5.2f, %d)&gt;&quot; % (
             self.id, self.category, self.name, self.price, self.supplier_id)
 
class Supplier(db.Model):
   &quot;&quot;&quot;Define model 'Supplier' mapped to table 'supplier' (default lowercase).&quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   name = db.Column(db.String(50), nullable=False)
   <span class="color-comment"># property 'items' is defined in 'Cafe' via backref.</span>
 
   def __repr__(self):
      return &quot;&lt;Supplier(%d, %s)&gt;&quot; % (self.id, self.name)
 
def load_db(db):
   &quot;&quot;&quot;Load the database tables and records&quot;&quot;&quot;
   <span class="color-comment"># Drop and re-create all the tables</span>
   db.drop_all()
   db.create_all()
 
   <span class="color-comment"># Add records thru relationship</span>
   _supplier1 = Supplier(name='AAA Corp', id=501)
   _supplier2 = Supplier(name='BBB Corp', id=502)
   _item1 = Cafe(name='Espresso', price=3.19, suppliers=[_supplier1, _supplier2])
   _item2 = Cafe(name='Cappuccino', price=3.29)
   _supplier2.items.append(_item2)
   _supplier3 = Supplier(name='CCC Corp', id=503, items=[_item2])
   db.session.add(_item1)
   db.session.add(_item2)
   db.session.commit()</pre>

<p><code>controllers3.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[controller3] Flask-SQLAlchemy EG 3: Using one-to-many relation.
&quot;&quot;&quot;
from flask import Flask, render_template, redirect, flash, abort
from models3 import db, Supplier, Cafe, load_db  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask: Initialize</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
@app.route(&quot;/&quot;)
@app.route(&quot;/&lt;id&gt;&quot;)
def index(id=None):
   if id:
      _items = Cafe.query.filter_by(id=id).all()
   else:
      _items = Cafe.query.all()
 
   if not _items:
      abort(404)
 
   return render_template('list3.html', item_list=_items)
 
if __name__ == '__main__':
   app.config['SQLALCHEMY_ECHO'] = True
   app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = True
   app.debug = True
   app.run()</pre>

<p><code>templates/list3.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Cafe List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Cafe List&lt;/h1&gt;
&lt;ul&gt;
  {% for item in item_list %}
  &lt;li&gt;{{ item.name }}, {{ item.category }}, ${{ item.price }}
    &lt;ul&gt;
      {% for supplier in item.suppliers %}&lt;li&gt;{{ supplier.name }}&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;
  &lt;/li&gt;
  {% endfor %}
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>[TODO] Some explanations</p>

<h5>Example 4: Using Many-to-many with additional columns in Association Class</h5>

<p><code>models4.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[models4] Flask-SQLAlchemy EG 4: Many-to-many with extra columns
&quot;&quot;&quot;
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
db = SQLAlchemy()
 
class CafeSupplier(db.Model):
   &quot;&quot;&quot;Association Table with extra column&quot;&quot;&quot;
   item_id = db.Column(db.Integer, db.ForeignKey('cafe.id'), primary_key=True)
   supplier_id = db.Column(db.Integer, db.ForeignKey('supplier.id'), primary_key=True)
   cost = db.Column(db.Numeric(precision=5, scale=2), default=999.99)
 
   item = db.relationship('Cafe', backref=&quot;assoc_suppliers&quot;)
   supplier = db.relationship('Supplier', backref=&quot;assoc_items&quot;)
 
class Cafe(db.Model):
   &quot;&quot;&quot;Define model 'Cafe' mapped to table 'cafe' (default lowercase).&quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), default='coffee')
   name = db.Column(db.String(50))
   price = db.Column(db.Numeric(precision=5, scale=2), default=999.99)
   <span class="color-comment">#suppliers = db.relationship('Supplier', secondary='cafe_supplier',</span>
   <span class="color-comment">#      backref=db.backref(&quot;items&quot;, lazy='dynamic'), lazy='dynamic')</span>
 
   def __repr__(self):
      return &quot;&lt;Cafe(%d, %s, %s, %5.2f, %d)&gt;&quot; % (
             self.id, self.category, self.name, self.price, self.supplier_id)
 
class Supplier(db.Model):
   &quot;&quot;&quot;Define model 'Supplier' mapped to table 'supplier' (default lowercase).&quot;&quot;&quot;
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   name = db.Column(db.String(50), nullable=False)
   <span class="color-comment"># property 'items' is defined in 'Cafe' via backref.</span>
 
   def __repr__(self):
      return &quot;&lt;Supplier(%d, %s)&gt;&quot; % (self.id, self.name)
 
def load_db(db):
   &quot;&quot;&quot;Load the database tables and records&quot;&quot;&quot;
   <span class="color-comment"># Drop and re-create all the tables</span>
   db.drop_all()
   db.create_all()
 
   <span class="color-comment"># Add records thru relationship</span>
   _supplier1 = Supplier(name='AAA Corp', id=501)
   _supplier2 = Supplier(name='BBB Corp', id=502)
   _item1 = Cafe(name='Espresso', price=3.19)
   _item2 = Cafe(name='Cappuccino', price=3.29)
   _assoc1 = CafeSupplier(item=_item1, supplier=_supplier1, cost=1.99)
   _assoc2 = CafeSupplier(item=_item1, supplier=_supplier2, cost=1.88)
   _assoc3 = CafeSupplier(item=_item2, supplier=_supplier1, cost=1.77)
 
<span class="color-comment">#   _supplier2.items.append(_item2)</span>
<span class="color-comment">#   _supplier3 = Supplier(name='CCC Corp', id=503, items=[_item2])</span>
   db.session.add(_assoc1)
   db.session.add(_assoc2)
   db.session.add(_assoc3)
   db.session.commit()</pre>

<p><code>controllers4.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;
[controller4] Flask-SQLAlchemy EG 4: Using one-to-many relation with extra columns
&quot;&quot;&quot;
from flask import Flask, render_template, redirect, flash, abort
from models4 import db, Supplier, Cafe, load_db  <span class="color-comment"># Flask-SQLAlchemy</span>
 
<span class="color-comment"># Flask: Initialize</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
@app.route(&quot;/&quot;)
@app.route(&quot;/&lt;id&gt;&quot;)
def index(id=None):
   if id:
      _items = Cafe.query.filter_by(id=id).all()
   else:
      _items = Cafe.query.all()
 
   if not _items:
      abort(404)
 
   return render_template('list4.html', item_list=_items)
 
if __name__ == '__main__':
   app.config['SQLALCHEMY_ECHO'] = True
   app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = True
   app.debug = True
   app.run()</pre>

<p><code>templates/list4.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;Cafe List&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Cafe List&lt;/h1&gt;
&lt;ul&gt;
  {% for item in item_list %}
  &lt;li&gt;{{ item.name }}, {{ item.category }}, ${{ item.price }}
    &lt;ul&gt;
      {% for assoc_supplier in item.assoc_suppliers %}
      &lt;li&gt;{{ assoc_supplier.cost }}, {{ assoc_supplier.supplier.name }}&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;
  &lt;/li&gt;
  {% endfor %}
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>[TODO] Some explanations</p>

<h5>Cascades</h5>

<p>See <a href="http://docs.sqlalchemy.org/en/latest/orm/cascades.html">http://docs.sqlalchemy.org/en/latest/orm/cascades.html</a>.</p>

<p>You can specify the cascade option when defining a relationship, e.g.,</p>

<pre class="color-example">
suppliers = relationship("Supplier", cascade="all, delete-orphan")</pre>

<p>The various options are:</p>

<ul>
<li><code>save-update</code>: when an object is place into a <code>Session</code> via <code>Session.add()</code>, all objects in <code>relationship()</code> shall also be added to the same <code>Session</code>.</li>

<li><code>merge</code>: The <code>Session.merger()</code> operation shall be propagate to its related objects.</li>

<li><code>delete</code>: When a parent object is marked for deletion, its related child objects should also be marked for deletion. Both object will be deleted during <code>Session.commit()</code>.</li>

<li><code>delete-orphan</code>: Marked the child object for deletion, if it is de-associated from its parent, i.e., its foreign key not longer valid.</li>

<li><code>refresh-expire</code>: The <code>Session.expire()</code> operation shall be propagated to the related objects.</li>

<li><code>expunge</code>: When the parent object is removed from the <code>Session</code> using <code>Session.expunge()</code>, the operation shall be propagated to its related objects.</li>

<li><code>all</code>: <code>save-update</code>, <code>merge</code>, <code>refresh-expire</code>, <code>expunge</code>, <code>delete</code>; exclude <code>delete-orphan</code>.</li>

<li>The defaults are <code>save-update</code> and <code>merge</code>.</li>
</ul>

<p>It can also be defined inside the <code>backref()</code> function for applying to the <code>backref</code> attribute.</p>



<h5>Flask-SQLAlchemy's Query Methods</h5>

<p>To execute a query: You can use the SQLAlchemy's query methods (in the base class). Flask-SQLAlchemy adds more methods (in its subclass):</p>
<ul>
<li><code>all()</code>: return all objects as a list.</li>
<li><code>first()</code>: return the first object, or None.</li>
<li><code>first_or_404()</code>: return the first object, or abort with 404.</li>
<li><code>get(<em>primary-key-id</em>)</code>: return a single object based on the primary-key identifier, or None. If the primary key consists of more than one column, pass in a tuple.</li>
<li><code>get_or_404(<em>primary-key-id</em>)</code>: return a single object based on the primary-key identifier, or abort with 404.</li>
<li><code>paginate(page=None, per_page=None, error_out=True)</code>: return a <code>Pagination</code> object of <code>per_page</code> items for page number of <code>page</code>.<br />
If <code>error_out</code> is True, abort with 404 if a page outside the valid range is requested; otherwise, an empty list of items is returned.</li>
</ul>

<p>To filter a query object:</p>
<ul>
<li><code>order_by(<em>criterion</em>)</code>:</li>
<li><code>limit(<em>limit</em>)</code>:</li>
<li><code>offset(<em>offset</em>)</code>:</li>
<li><code>filter(*<em>criterion</em>)</code>: filtering criterion in SQL WHERE expressions, e.g., <code>id > 5</code>.</li>
<li><code>filter_by(**kwargs)</code>: filtered using keyword expressions (in Python), e.g., <code>name = 'some name'</code>.</li>
</ul>

<h5>Pagination</h5>
<p>You can use the <code>pagination()</code> method to execute a query, which returns a <code>Pagination</code> object.</p>

<p>Example</p>

<pre class="color-example">
<span class="color-comment"># The URL has a GET parameter page=x</span>
page_num = request.args.get('page', 1, type=int)
      <span class="color-comment"># Retrieve the GET param 'page'. Set to 1 if not present. Coerce into 'int'</span>
pagination = Model.query.order_by(...).paginate(page_num, per_page=20, error_out=False)
items = pagination.items
return render_template('xxx.html', form=form, pagination=pagination)</pre>

<p>The <code>Pagination</code> object has these properties/methods:</p>

<ul>
<li><code>items</code>: items for the current page.</li>
<li><code>per_page</code>: number of items per page.</li>
<li><code>total</code>: total number for this query.</li>
<li><code>pages</code>: number of pages.</li>
<li><code>page</code>, <code>next_num</code>, <code>prev_num</code>: the current/next/previous page number.</li>

<li><code>has_next</code>, <code>has_prev</code>: True if a next/previous page exists.</li>

<li><code>next</code>, <code>has_prev</code>: True if a next/previous page exists.</li>

<li><code>next()</code>, <code>prev()</code>: return a <code>Pagination</code> object for the next/previous page.</li>

<li><code>iter_pages(left_edgs=2, left_current=2, right_current=5, right_edge=2)</code>: return a sequence of page numbers (for providing links to these pages). Suppose that the current page number is 50 of 80, this iterator returns this page sequence: 1, 2, None, 48, 49, 50, 51, 52, 53, 54, 55, None, 79, 80.</li>

</ul>


<h3>RESTful Web Services API</h3>

<p>In recent years, there is a tendency to move some business logic to the client side, in a architecture known as Rich Internet Application (RIA). In RIA, the server provides the clients with data retrieval and storage services, becoming a 'web service' or 'remote API'.</p>

<p>An API (Application Programming Interface) is a set of routines, protocols and tools for building software applications. It exposes a software component in terms of its operations, input and output, that are independent of their implementation.  A Web Service is a web application that is available to your application as if it was an API.</p>

<p>There are several protocols that the RIA clients can communicate with a web service or remote API, such as RPC (Remote Procedure Call), SOAP (Simplified Object Access Protocol) and REST (Representational State Transfer).  REST has emerged as the favorite nowadays.</p>

<p>REST specifies a coordinated set of constraints to the design of components in a distributed hypermedia system that leads to higher performance and better maintainability. These constraints are: client-server, stateless, cacheable, layer system, uniform interface and code-on-demand.</p>

<p>If your web services conform to the REST constraints, and can be used in standalone (i.e., does not need an UI), then you have a RESTful Web Service API, or RESTful API in short. RESTful API works like a regular API, but delivers through a web server.</p>

<p>RESTful API is typically accessible through a URI, typically via an HTTP request, for retrieving data from remote server and sending data. The URI shall be consistent, e.g., <code>/api/users/</code> to retrieve all the users (or a collection of users); <code>/api/users/5</code> to retrieve the user with <code>id=5</code>; <code>/api/users/5/followers/</code> to retrieve all the followers of the user with <code>id=5</code>. Collections are identified by a trailing slash to give a directory representation. You can also include a version number in the URI, e.g., <code>/api/v1.0/users</code>, so that a client can choose a suitable version.</p>

<p>RESTful API uses HTTP requests to perform CRUD (Create-Read-Update-Delete) operations:</p>
<ul>
<li>GET: to retrieve an individual item, or a collection of items.</li>
<li>POST: to create a new item and add it into the collection.</li>
<li>PUT: to update (modify) an existing item.</li>
<li>DELETE: to delete an item.</li>
</ul>

<p>Data could use 'transport format' of text, HTML/XML, JSON, or other formats. JSON has become the most common data format, for its simplicity in representing objects (over XML) and its close ties to the client-side JavaScript programming language.</p>

<p>The HTTP requests could be synchronous or asynchronous (AJAX). Again, AJAX is becoming popular for Single-Page Architecture (SPA).</p>

<h4>Flask RESTful API</h4>

<p>Flask can support RESTful API easily, by using URL variable in the route, e.g., <code>@app.route('/api/&lt;version&gt;/users/&lt;user_id&gt;')</code>.</p>

<h5>Example 1: Handling GET Request</h5>

<p>In this example, we shall use Python package marshmallow (@ <a href="https://marshmallow.readthedocs.org/en/latest/">https://marshmallow.readthedocs.org/en/latest/</a>) app-level object serialization. To install marshmallow:</p>

<pre class="color-command">
$ <strong>sudo pip install marshmallow</strong>

$ <strong>pip show --files marshmallow</strong>
Name: marshmallow
Version: <strong>2.3.0</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: </pre>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""rest_get.py: HTTP GET request with JSON response"""</span>
from flask import Flask, jsonify
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
from marshmallow import Schema

app = Flask(__name__)
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Needed for CSRF</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://testuser:xxxx@localhost:3306/testdb'
db = SQLAlchemy(app)

<span class="color-comment"># Define Model mapped to table `cafe`</span>
class Cafe(db.Model):
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), nullable=False, default='coffee')
   name = db.Column(db.String(50), nullable=False)
   price = db.Column(db.Numeric(precision=5, scale=2), nullable=False)

   def __init__(self, category, name, price):
      <span class="color-comment">"""Constructor: id is auto_increment"""</span>
      self.category = category
      self.name = name
      self.price = price

<span class="color-comment"># Drop, re-create all the tables and insert records</span>
db.drop_all()
db.create_all()
db.session.add_all([Cafe('coffee', 'Espresso', 3.19),
                 Cafe('coffee', 'Cappuccino', 3.29),
                 Cafe('coffee', 'Caffe Latte', 3.39), 
                 Cafe('tea', 'Green Tea', 2.99),
                 Cafe('tea', 'Wulong Tea', 2.89)])
db.session.commit()

<span class="color-comment"># We use marshmallow Schema to serialize our database records</span>
class CafeSchema(Schema):
   class Meta:
      fields = ('id', 'category', 'name', 'price')  <span class="color-comment"># Serialize these fields</span>

item_schema = CafeSchema()            <span class="color-comment"># Single object</span>
items_schema = CafeSchema(many=True)  <span class="color-comment"># List of objects</span>

@app.route("/query/", methods=["GET"])
@app.route("/query/&lt;int:id&gt;", methods=["GET"])
def query(id = None):
   if id:
      item = Cafe.query.get(id)

      if item is None:
         return jsonify({"msgs": ['We could not find the item']}), 404
      else:
         result = item_schema.dump(item)   <span class="color-comment"># Serialize object</span>
         return jsonify({'item': result})  <span class="color-comment"># or result.data</span>

   else:
      items = Cafe.query.limit(3)  <span class="color-comment"># don't return the whole set</span>
      result = items_schema.dump(items)  <span class="color-comment"># Serialize list of objects</span>
      return jsonify({"items": result.data})

if __name__ == '__main__':
   <span class="color-comment"># Turn on debug only if launch from command-line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>

<p>Try these URLs and observe the JSON data returned:</p>
<ol>
<li><code>http://localhost:5000/query/</code></li>
<li><code>http://localhost:5000/query/1</code></li>
<li><code>http://localhost:5000/query/6</code></li>
</ol>

<h5>Example 2: AJAX/JSON</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""rest_ajax.py: AJAX request with JSON response"""</span>
from flask import Flask, jsonify, request, render_template, abort
from flask.ext.sqlalchemy import SQLAlchemy
from marshmallow import Schema

app = Flask(__name__)
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Needed for CSRF</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://testuser:xxxx@localhost:3306/testdb'
db = SQLAlchemy(app)

<span class="color-comment"># Define Model mapped to table `cafe`</span>
class Cafe(db.Model):
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), nullable=False, default='coffee')
   name = db.Column(db.String(50), nullable=False)
   price = db.Column(db.Numeric(precision=5, scale=2), nullable=False)

   def __init__(self, category, name, price):
      <span class="color-comment">"""Constructor: id is auto_increment"""</span>
      self.category = category
      self.name = name
      self.price = price

<span class="color-comment"># Drop, re-create all the tables and insert records</span>
db.drop_all()
db.create_all()
db.session.add_all([Cafe('coffee', 'Espresso', 3.19),
                 Cafe('coffee', 'Cappuccino', 3.29),
                 Cafe('coffee', 'Caffe Latte', 3.39), 
                 Cafe('tea', 'Green Tea', 2.99),
                 Cafe('tea', 'Wulong Tea', 2.89)])
db.session.commit()

<span class="color-comment"># We use marshmallow Schema to serialize our database records</span>
class CafeSchema(Schema):
   class Meta:
      fields = ('id', 'category', 'name', 'price')  <span class="color-comment"># Serialize these fields</span>

item_schema = CafeSchema()            <span class="color-comment"># Single object</span>
items_schema = CafeSchema(many=True)  <span class="color-comment"># List of objects</span>

@app.route("/query/", methods=["GET"])
@app.route("/query/&lt;int:id&gt;", methods=["GET"])
def query(id = None):
   if id:
      item = Cafe.query.get(id)

      if request.is_xhr:  <span class="color-comment"># AJAX?</span>
         <span class="color-comment"># Return JSON</span>
         if item is None:
            return jsonify({"msgs": ['We could not find the item']}), 404
         else:
            result = item_schema.dump(item)
            return jsonify({'result': result.data})

      else:
         <span class="color-comment"># Return a web page</span>
         if item is None:
            abort(404)
         else:
            return render_template('query.html')

   else:  <span class="color-comment"># if id</span>
      items = Cafe.query.limit(3)  <span class="color-comment"># don't return the whole set</span>

      if request.is_xhr:
         <span class="color-comment"># Return JSON</span>
         result = items_schema.dump(items)
         return jsonify({"result": result.data})
      else:
         <span class="color-comment"># Return a web page</span>
         return render_template('query.html')

if __name__ == '__main__':
   <span class="color-comment"># Debug only if running through command line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.run(debug=True)</pre>

<p><code>templates/query.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Cafe Query&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Cafe Query&lt;/h1&gt;
  &lt;ul id="items"&gt;&lt;/ul&gt;

&lt;script src="https://code.jquery.com/jquery-1.11.2.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
<span class="color-comment">// Send AJAX request after document is fully loaded</span>
$(document).ready(function() {
   $.ajax({
      <span class="color-comment">// default url of current page and method of GET</span>
   })
      .done( function(response) {  
         <span class="color-comment">// response['result'] is a list of Cafe objects</span>
         $(response['result']).each(function(idx, elm) {
            $("#items").append("&lt;li&gt;" + elm['category'] + ", " 
                  + elm['name'] + ", $" + elm['price'] + "&lt;/li&gt;");
         })
      });
});      
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>There are two requests for each URL. The initial request is a regular HTTP GET request, which renders the template, including the AJAX codes, but without any items. When the page is fully loaded, an AJAX request is sent again to request for the items, and placed inside the document.</p>

<p>Turn on the firebug (or Web developer Tools) to trace the JavaScript.</p>

<h4>Flask-RESTful</h4>

<p>Reference: Flask-RESTful @ <a href="http://flask-restful-cn.readthedocs.org/en/0.3.4/">http://flask-restful-cn.readthedocs.org/en/0.3.4/</a>.</p>

<p>Flask-RESTful is an extension for building REST APIs for Flask app, which works with your existing ORM.</p>

<h5>Installing Flask-RESTful</h5>

<pre class="color-command">
$ <strong>sudo pip install flask-restful</strong>

$ <strong>pip show flask-restful</strong>
Name: Flask-RESTful
Version: 0.3.5
Summary: Simple framework for creating REST APIs
Requires: Flask, aniso8601, pytz, six</pre>

<h5>Example 1: Using Flask-Restful</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;[controllers1] Flask-Restful Example 1: Using Flask-Restful&quot;&quot;&quot;
from flask import Flask, abort
from flask.ext.restful import Api, Resource
 
class Post(Resource):
   &quot;&quot;&quot;
   For get, update, delete of a particular post via URL /api/post/&lt;int:post_id&gt;.
   &quot;&quot;&quot;
   def get(self, post_id):
      return 'reading post %s' % post_id
 
   def delete(self, post_id):
      return 'delete post %s' % post_id
 
   def put(self, post_id):
      &quot;&quot;&quot;Request data needed for update&quot;&quot;&quot;
      return 'update post %s' % post_id
 
class Posts(Resource):
   &quot;&quot;&quot;
   For get, post via URL /api/post/, meant for list-all and create new.
   &quot;&quot;&quot;
   def get(self):
      return 'list all posts'
 
   def post(self):
      &quot;&quot;&quot;Request data needed for create&quot;&quot;&quot;
      return 'create a new post'
 
app = Flask(__name__)
api_manager = Api(app)
 
<span class="color-comment"># NOTE: cannot use:</span>
<span class="color-comment">#api_manager = Api()</span>
<span class="color-comment">#api_manager.init_app(app)</span>
 
api_manager.add_resource(Post, '/api/post/&lt;post_id&gt;')
api_manager.add_resource(Posts, '/api/post/')
 
if __name__ == '__main__':
   app.run(debug=True)</pre>

<ol>
<li>We define two URLs: <code>/api/post/</code> for get-all and create via GET and POST methods; and <code>/api/post/&lt;post_id&gt;</code> for get, update, delete via GET, PUT, and DELETE methods.</li>

<li>We extend the <code>Resource</code> class to support all these methods.</li>

<li>In this example, we did not use an actual data models; supply data for POST and PUT requests with input data validation.</li>

<li>To send POST/PUT/DELETE requests, you can use the command-line <code>curl</code> (which is rather hard to use); or browser's extension such as Firefox's HttpRequester, or Chrome's Advanced REST client.</li>
</ol>

<h5>Example 2: Argument Parsing</h5>

<p>[TODO]</p>

<h4>Flask-Restless</h4>

<p>Flask-Restless is an extension capable of auto-generating a whole RESTful API for
your SQLAlchemy models with support for GET, POST, PUT, and DELETE.</p>

<p>To install Flask-Restless:</p>

<pre class="color-command">
$ <strong>sudo pip install Flask-Restless</strong>

$ <strong>pip show Flask-Restless</strong>
Name: Flask-Restless
Version: <strong>0.17.0</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: flask, sqlalchemy, python-dateutil, mimerender</pre>

<h5>Example: Flask-Restless</h5>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""flask_restless_test.py: Testing Flask-Restless to generate RESTful API"""</span>
from flask import Flask, url_for
from flask.ext.sqlalchemy import SQLAlchemy  <span class="color-comment"># Flask-SQLAlchemy</span>
from flask.ext.restless import APIManager    <span class="color-comment"># Flask-Restless</span>

app = Flask(__name__)
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Needed for CSRF</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://testuser:xxxx@localhost:3306/testdb'
db = SQLAlchemy(app)

<span class="color-comment"># Define Model mapped to table `cafe`</span>
class Cafe(db.Model):
   id = db.Column(db.Integer, primary_key=True, autoincrement=True)
   category = db.Column(db.Enum('tea', 'coffee'), nullable=False, default='coffee')
   name = db.Column(db.String(50), nullable=False)
   price = db.Column(db.Numeric(precision=5, scale=2), nullable=False)

   def __init__(self, category, name, price):
      <span class="color-comment">"""Constructor: id is auto_increment"""</span>
      self.category = category
      self.name = name
      self.price = price

<span class="color-comment"># Drop, re-create all the tables and insert records</span>
db.drop_all()
db.create_all()
db.session.add_all([Cafe('coffee', 'Espresso', 3.19),
                 Cafe('coffee', 'Cappuccino', 3.29),
                 Cafe('coffee', 'Caffe Latte', 3.39), 
                 Cafe('tea', 'Green Tea', 2.99),
                 Cafe('tea', 'Wulong Tea', 2.89)])
db.session.commit()

<span class="color-comment"># Create the Flask-Restless API manager</span>
manager = APIManager(app, flask_sqlalchemy_db=db)

<span class="color-comment"># Create API endpoints, which will be available at /api/&lt;tablename&gt;,
# by default. Allowed HTTP methods can be specified as well.</span>
manager.create_api(Cafe, methods=['GET', 'POST', 'PUT', 'DELETE'])

if __name__ == '__main__':
   <span class="color-comment"># Turn on debug only if launch from command-line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>


<p>To send POST/PUT/DELETE requests, you can use the command-line <code>curl</code> (which is rather hard to use); or browser's extension such as Firefox's HttpRequester, or Chrome's Advanced REST client.</p>
   
<p>You can use <code>curl</code> to try the RESTful API (See <a href="http://flask-restless.readthedocs.org/en/latest/requestformat.html">http://flask-restless.readthedocs.org/en/latest/requestformat.html</a> on the request format):</p>

<pre class="color-command">
<span class="color-comment"># GET request to list all the items</span>
$ <strong>curl --include --header "Accept: application/json" --header "Content-Type: application/json" --request GET http://127.0.0.1:5000/api/cafe</strong>
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 901
Link: &lt;http://127.0.0.1:5000/api/cafe?page=1&amp;results_per_page=10&gt;; rel="last"
Link: &lt;http://127.0.0.1:5000/api/cafe?page=1&amp;results_per_page=10&gt;; rel="last"
Vary: Accept
Content-Type: application/json
Server: Werkzeug/0.11.2 Python/2.7.6
{
  "num_results": 5,
  "objects": [
    {
      "category": "coffee",
      "id": 1,
      "name": "Espresso",
      "price": 3.19
    },
    .....
  ],
  "page": 1,
  "total_pages": 1
}    

<span class="color-comment"># GET request for one item</span>
$ <strong>curl --include --header "Accept: application/json" --header "Content-Type: application/json" --request GET http://127.0.0.1:5000/api/cafe/3</strong>
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 79
Vary: Accept
Content-Type: application/json
Server: Werkzeug/0.11.2 Python/2.7.6
Date: Thu, 03 Dec 2015 18:55:24 GMT

{
  "category": "coffee",
  "id": 3,
  "name": "Caffe Latte",
  "price": 3.39
}

<span class="color-comment"># POST request to add one item</span>
$ <strong>curl --include --header "Accept: application/json" --header "Content-Type: application/json" --request POST --data '{"category":"coffee", "name":"coffee xxx", "price":1.01}' http://127.0.0.1:5000/api/cafe</strong>
HTTP/1.0 201 CREATED
Content-Type: application/json
Content-Length: 78
Location: http://127.0.0.1:5000/api/cafe/6
Vary: Accept
Content-Type: application/json
Server: Werkzeug/0.11.2 Python/2.7.6
Date: Thu, 03 Dec 2015 18:53:48 GMT

{
  "category": "coffee",
  "id": 6,
  "name": "coffee xxx",
  "price": 1.01
}

<span class="color-comment"># DELETE request to remove one item</span>
$ <strong>curl --include --header "Accept: application/json" --header "Content-Type: application/json" --request DELETE http://127.0.0.1:5000/api/cafe/9</strong>
HTTP/1.0 204 NO CONTENT
Content-Type: application/json
Content-Length: 0
Vary: Accept
Content-Type: application/json
Server: Werkzeug/0.11.2 Python/2.7.6
Date: Thu, 03 Dec 2015 18:57:32 GMT

<span class="color-comment"># PUT (or PATCH) request to update one item</span>
$ <strong>curl --include --header "Accept: application/json" --header "Content-Type: application/json" --request PUT --data '{"price":9.99}' http://127.0.0.1:5000/api/cafe/1</strong>
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 76
Vary: Accept
Content-Type: application/json
Server: Werkzeug/0.11.2 Python/2.7.6
Date: Thu, 03 Dec 2015 19:09:36 GMT

{
  "category": "coffee",
  "id": 1,
  "name": "Espresso",
  "price": 9.99
}</pre>


<p>[TODO] Authentication for POST, PUT and DELETE?</p>

<p>Flask-Restless generates web services that are RESTful API. They are client-server (HTTP), stateless (HTTP is stateless), cacheable (browser), uniform interface (JSON input, JSON output, consistent URLs for GET (read), POST (insert or create), PUT (update), DELETE (delete), supporting CRUD (create-read-update-delete) operations).</p>


<h3>Unit Testing and Acceptance Testing for Flask Apps</h3>

<h4>Unit Testing</h4>

<p>Read <a href="Python1_Basics.html#unittest">Python Unit Testing</a> for the basics.</p>

<p>To test a Flask app under the web, we need to simulate the requests and retrieve the responses. Flask provides a test-client tools (created via <code>test_client()</code>) for sending HTTP requests and retrieving the responses.</p>

<h5>Example</h5>

<p><code>controllers.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
'''controllers.py: controller for main app'''
from flask import Flask, render_template
 
def setup_app(app):
   '''Register the routes and view functions for the given app'''
   @app.route('/')
   @app.route('/&lt;name&gt;')
   def hello(name=None):
      return render_template('hello.html', name=name)
 
def app_factory(name=__name__, debug=False):
   '''Generate an instance of the app'''
   app = Flask(name)
   app.debug = debug
   setup_app(app)
   return app
 
if __name__ == '__main__':
   <span class="color-comment"># Run the app</span>
   app = app_factory(debug=True)
   app.run()</pre>

<p><code>templates/hello.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;title&gt;Hello&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, {% if name %}{{ name }}{% else %}world{% endif %}&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>Try running the application, with URL <code>http://localhost:5000</code> and <code>http://localhost:5000/peter</code>.</p>

<p>The unit test module for testing the <code>hello()</code> view function is as follows:</p>

<p><code>test_view_hello.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
'''test_view_hello.py: Test the hello view functions'''
from flask import url_for, request
import unittest
from controllers import app_factory
 
class TestWebApp(unittest.TestCase):
   '''Unit Test'''
   def setUp(self):
      '''Called before each test method'''
      self.app = app_factory(debug=True)  <span class="color-comment"># Generate a Flask app instance</span>
      <span class="color-comment"># Create a clean client for each test</span>
      self.client = self.app.test_client()
 
   def tearDown(self):
      '''Called after each test method'''
      pass
 
   def test_hello_no_name(self):
      '''Test hello()'''
      with self.app.test_request_context():  <span class="color-comment"># Simulate a request</span>
         path = url_for('hello')
         assert request.path == '/'  <span class="color-comment"># For illustration, as path could change</span>
         response = self.client.get(path)  <span class="color-comment"># Send GET request</span>
         assert 'Hello, world' in response.data
 
   def test_hello_with_name(self):
      '''Test hello(name)'''
      with self.app.test_request_context():
         name = 'Peter'
         path = url_for('hello', name=name)
         response = self.client.get(path)
         assert 'Hello, ' + name in response.data
 
   def test_hello_with_name_escape(self):
      '''Test hello(name) with special characters in name'''
      with self.app.test_request_context():
         name = '&lt;peter&gt;'  <span class="color-comment"># Contains special HTML characters</span>
         path = url_for('hello', name=name)
         response = self.client.get(path)
         escaped_name = name.replace('&lt;', '&amp;lt;')
         escaped_name = escaped_name.replace('&gt;', '&amp;gt;')
         assert 'Hello, ' + escaped_name in response.data
 
if __name__ == '__main__':
   <span class="color-comment"># Run unit test</span>
   unittest.main()</pre>

<ol>
<li>In <code>setup</code>, which is run before running each test method, we define two instance variables <code>self.app</code> and <code>self.client</code>, to be used by the test method.</li>

<li>There are 3 tests in the above test scripts. Run the test script and check the test results:

<pre class="color-command">
$ <strong>python test_view_hello.py</strong> 
...
----------------------------------------------------------------------
Ran 3 tests in 0.020s

OK</pre></li>

</ol>

<h4>Unit Testing with Flask-Testing Extension</h4>

<p>Reference: Flask-Testing @ <a href="https://pythonhosted.org/Flask-Testing/">https://pythonhosted.org/Flask-Testing/</a>.</p>

<p>The Flask-Testing extension provides unit testing utilities for Flask, in particular, handling request to Flask app.</p>

<h5>Installing Flask Testing</h5>

<pre class="color-command">
$ <strong>sudo pip install Flask-Testing</strong>

$ <strong>pip show Flask-Testing</strong>
Metadata-Version: 2.0
Name: Flask-Testing
Version: 0.4.2
Summary: Unit testing for Flask
Location: /usr/local/lib/python2.7/site-packages
Requires: Flask</pre>

<h5>Example: Using Flask Testing</h5>

<pre class="color-example">
from flask import url_for
from flask.ext.testing import TestCase  <span class="color-comment"># Flask-Testing extension</span>
import unittest
from app_main import app

class Test(TestCase):
   """Unit Test"""

   def create_app(self):
      app.config['TESTING'] = True
      app.config['WTF_CSRF_ENABLED'] = False   <span class="color-comment"># Disable Flask-WTF CSRF protection</span>
      return app
     
   def test_login_logout(self):
      '''Test login and logout with correct credential'''
      <span class="color-comment"># login</span>
      response = self.client.post(url_for('mod_core.login'),
            data={'username':'user1', 'passwd':'xxxx'}, 
            follow_redirects=True)
      assert 'LOGOUT' in response.data

      <span class="color-comment"># logout</span>
      response = self.client.get(url_for('mod_core.logout'),
            follow_redirects=True)
      assert 'You have logged out. Thank you.' in response.data

if __name__ == "__main__":
   unittest.main()</pre>

<ol>
<li>Create your test class by sub-classing <code>flask.ext.testing.TestCase</code> class, instead of <code>unittest.TestCase</code>.</li>

<li>Specify a <code>create_app()</code> method in your test class, which should return a <code>Flask</code> instance.</li>

<li>Use <code>self.client.get()</code> and <code>self.client.post()</code> methods to send GET and POST request, respectively.</li>

<li>You can run the test using <code>unittest.main()</code> function, which will discover all your test methods in your <code>TestCase</code> classes. The test methods must begin with <code>test</code>.</li>

<li>The available assert methods (in Flask-Testing) are:
<ul>
<li><code>assertXxx(<em>response</em>, <em>message</em>=None)</code>: where <code><em>response</em></code> is the Flask's <code><em>response</em></code>; <code><em>message</em></code> is an optional message to be displayed if test fails; <code>Xxx</code> is the response status code, including 200, 400, 401, 403, 404, 405 and 500.</li>

<li><code> assertStatus(<em>response</em>, <em>status_code</em>, <em>message</em>=None)</code>:</li>

<li><code> assertContext(<em>name</em>, <em>value</em>)</code>: Check if <code><em>name</em></code> exists in the template context and equals to the given <code><em>value</em></code>.</li>

<li><code> assertRedirect(<em>response</em>, <em>location</em>)</code>: Check if the <code><em>response</em></code> is a redirect to the given <code><em>location</em></code>.</li>

<li><code> assertTemplateUsed(<em>template_name</em>)</code>: Check if the given template is used in the request.</li>
</ul></li>
</ol>



<h4>Acceptance Test with Selenium</h4>

<p>[TODO]</p>



<h3>Some Useful Flask Extensions</h3>

<p>Reference: Flask Extension @ <a href="http://flask.pocoo.org/extensions/">http://flask.pocoo.org/extensions/</a>.</p>

<p>So far, we have discussed:</p>
<ul>
<li>Flask-WTF for web forms</li>
<li>Flask-SQLAlchemy for database queries</li>
<li>Flask-Restless for generating RESTful API</li>
</ul>

<p>There are many more extensions in the Flask Ecosystem. We shall cover these in this section:</p>
<ul>
<li>Flask-Login for User Session Management</li>
<li>Flask-Principal for permissions</li>
<li>Flask-Admin for building admin interfaces</li>
</ul>

<p>There are many more:</p>
<ul>
<li>Flask-Security for authentication</li>
<li>Flask-Assets for asset management</li>
<li>Flask-DebugToolbar for debugging and profiling</li>
<li>Flask-Markdown for forum posts</li>
<li>Flask-Script for basic commands</li>
</ul>

<h4>Flask-Login for User Session Management</h4>

<p>Reference: Flask-Login @ <a href="https://flask-login.readthedocs.org/en/latest/">https://flask-login.readthedocs.org/en/latest/</a>.</p>

<p>Flask-Login is an authentication and session manager. It handles common tasks of logging in, logging out, and keep track of your users' sessions over extended periods of time.</p>

<p>To install Flask-Login</p>
<pre class="color-command">
$ <strong>sudo pip install Flask-Login</strong>

$ <strong>pip show Flask-Login</strong>
Name: Flask-Login
Version: <strong>0.3.2</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: Flask</pre>


<h5>Hashing Password</h5>

<p>In the example, we also use passlib to hash the password. To install:</p>

<p>To install passlib</p>

<pre class="color-command">
$ <strong>sudo pip install passlib</strong>

$ <strong>pip show passlib</strong>
Name: passlib
Version: <strong>1.6.5</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires:</pre>

<p>We also need to install bcrypt:</p>
<pre class="color-command">
<span class="color-comment"># Need these:</span>
$ <strong>sudo apt-get install build-essential libssl-dev libffi-dev python-dev</strong>

<span class="color-comment"># Also need these:</span>
$ <strong>sudo pip install cffi</strong>
Successfully installed cffi pycparser

<span class="color-comment"># Now, you can install bcrypt</span>
$ <strong>sudo pip install bcrypt</strong>
$ <strong>sudo pip show bcrypt</strong>
Name: bcrypt
Version: 2.0.0
Location: /usr/local/lib/python2.7/dist-packages
Requires: cffi, six</pre>

<p>To use bcrypt for hashing password:</p>
<pre class="color-example">
from passlib.hash import bcrypt

<span class="color-comment"># To hash</span>
passwd_hash= bcrypt.encrypt(password)

<span class="color-comment"># To verify</span>
if bcrypt.verify(password, passwd_hash):
   ......</pre>


<h5>Password Hashing with Flask-Bcrypt</h5>

<p>Reference: Flask-Bcrypt @ <a href="http://flask-bcrypt.readthedocs.org/en/latest/">http://flask-bcrypt.readthedocs.org/en/latest/</a>.</p>

<p>Flask-Bcrypt is a Flask extension that provides bcrypt hashing utilities. Unlike hashing algorithm such as MD5 and SHA1, which are optimized for speed, bcrypt is intentionally &quot;de-optimized&quot; to be slow, so as to protect against cracking with powerful hardware.</p>

<p>To install Flask-Bcrypt:</p>

<pre class="color-example">
$ <strong>sudo pip install flask-bcrypt</strong>

$ <strong>pip show flask-bcrypt</strong>
Name: Flask-Bcrypt
Version: 0.7.1
Location: /usr/local/lib/python2.7/dist-packages
Requires: Flask, bcrypt</pre>

<p>Take note that Flask-Bcrypt requires bcrypt.</p>

<p>To use Flask-Bcrypt:</p>

<pre class="color-example">
from flask import Flask
from flask.ext.bcrypt import Bcrypt

<span class="color-comment"># Construct an instance and bind to Flask app</span>
app = Flask(__name__)
bcrypt = Bcrypt(app)
      <span class="color-comment"># You can also use: 
      #    bcrypt = Bcrypt()
      #    bcrypt.init_app(app)</span>

<span class="color-comment"># To hash</span>
pw_hash = bcrypt.generate_password_hash('xxxx')

<span class="color-comment"># To verify against the hash</span>
bcrypt.check_password_hash(pw_hash, 'xxxx')</pre>

<p>NOTES: I use bcrypt directly in the following example, instead of Flask-Bcrypt.</p>

<h5>Example: Using Flask-Login for Login, Logout and User Session Management</h5>

<p><code>models.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
<span class="color-comment">"""(models.py) Flask-Login Example: Define Models and Database Interface"""</span>
from flask.ext.sqlalchemy import SQLAlchemy
from passlib.hash import bcrypt  <span class="color-comment"># For hashing password</span>

<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
db = SQLAlchemy()

<span class="color-comment"># Flask-SQLAlchemy: Define a 'User' model mapped to table 'user' (default to lowercase).
# Flask-Login: needs 4 properties (You could also use default implementations in UserMixin)</span>
class User(db.Model):
   username = db.Column(db.String(30), primary_key=True)
   pwhash = db.Column(db.String(300), nullable=False)  <span class="color-comment"># Store password hash</span> 
   active   = db.Column(db.Boolean, nullable=False, default=False)

   def __init__(self, username, password, active=False):
      <span class="color-comment">"""Constructor"""</span>
      self.pwhash = bcrypt.encrypt(password)  <span class="color-comment"># hash submitted password</span>
      self.username = username
      self.active = active

   @property  <span class="color-comment"># Convert method to property (instance variable)</span>
   def is_authenticated(self):
      <span class="color-comment">"""Flask-Login: return True if the user's credential is authenticated."""</span>
      return True

   @property
   def is_active(self):
      <span class="color-comment">"""Flask-Login: return True if the user is active."""</span>
      return self.active

   @property
   def is_anonymous(self):
      <span class="color-comment">"""Flask-Login: return True for anonymous user."""</span>
      return False

   def get_id(self):  <span class="color-comment"># This is method. No @property</span>
      <span class="color-comment">"""Flask-Login: return a unique ID in unicode."""</span>
      return unicode(self.username)

   def verify_password(self, in_password):
      <span class="color-comment">"""Verify the given password with the stored password hash"""</span>
      return bcrypt.verify(in_password, self.pwhash)

def load_db(db):
   <span class="color-comment">"""Create database tables and records"""</span>
   db.drop_all()
   db.create_all()
   db.session.add_all(
         [User('user1', 'xxxx', True),
          User('user2', 'yyyy')])  <span class="color-comment"># inactive</span>
   db.session.commit()</pre>

<ol>
<li>We included the password hashing and verification in the <code>User</code> model. This shows the power and flexibility of ORM, which cannot be done in relational database.</li>

<li>Flask-Login requires a <code>User</code> model with the following properties/methods:
<ul>
<li>an <code>is_authenticated</code> property that returns True if the user has provided valid credentials.</li>
<li>an <code>is_active</code> property that returns True if the user's account is active.</li>
<li>a <code>is_anonymous</code> property that returns True if the current user is an anonymous user.</li>
<li>a <code>get_id()</code> method that returns the unique ID for that object.</li>
</ul>
You could implement these yourself, or use the default implementation in <code>UserMixin</code> class (see source code @ <a href="https://flask-login.readthedocs.org/en/latest/_modules/flask_login.html#UserMixin">https://flask-login.readthedocs.org/en/latest/_modules/flask_login.html#UserMixin</a>).<br />
Take note that we decorate <code>is_authenticated</code>, <code>is_active</code> and <code>is_anonymous</code> with <code>@property</code>, to turn the method into property. Without this decorator, they won't work (it took me a few hours to find out)!
</li>
</ol>

<p><code>forms.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(forms.py) Flask-Login Example: Login Form"""</span>
from flask_wtf import Form  # import from flask_wtf, NOT wtforms
from wtforms import StringField, PasswordField  
from wtforms.validators import InputRequired, Length

<span class="color-comment"># Define the LoginRorm class by sub-classing Form</span>
class LoginForm(Form):
   <span class="color-comment"># This form contains two fields with validators</span>
   username = StringField(u'User Name:', validators=[InputRequired(), Length(max=20)])
   passwd = PasswordField(u'Password:', validators=[Length(min=4, max=16)])</pre>

<p><code>controller.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(controller.py) Flask-Login Example: Using Flask-Login for User Session Management"""</span>
from flask import Flask, render_template, redirect, flash, abort, url_for
from flask.ext.login import LoginManager, login_user, logout_user, current_user, login_required
from models import db, User, load_db  <span class="color-comment"># Our models</span>
from forms import LoginForm           <span class="color-comment"># Our web forms</span>

<span class="color-comment"># Flask: --- Setup ----------------------------------------------</span>
app = Flask(__name__)

<span class="color-comment"># Flask-WTF: ---  Setup -----------------------------------------</span>
app.config['SECRET_KEY'] = 'YOUR-SECRET'  # Flask-WTF: needed for CSRF

<span class="color-comment"># Flask-SQLAlchemy: ---  Setup ----------------------------------</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://testuser:xxxx@localhost:3306/testdb'
db.init_app(app)   # Bind SQLAlchemy to this Flask app

<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)

<span class="color-comment"># Flask-Login: ---  Setup ---------------------------------------</span>
login_manager = LoginManager()
login_manager.init_app(app)

@login_manager.user_loader
def user_loader(username):
   <span class="color-comment">"""Flask-Login: Given an ID, return the associated User object, or None"""</span>
   return User.query.get(username)

<span class="color-comment"># Flask: --- Routes ---------------------------------------------</span>
@app.route("/login", methods=['GET', 'POST'])
def login():
   form = LoginForm()  <span class="color-comment"># Construct a LoginForm</span>

   if form.validate_on_submit():  <span class="color-comment"># POST request with valid data?</span>
      <span class="color-comment"># Retrieve POST parameters (alternately via request.form)</span>
      username = form.username.data
      passwd = form.passwd.data
      <span class="color-comment"># Query 'user' table with 'username'. Get first row only</span>
      user = User.query.filter_by(username=username).first()

      <span class="color-comment"># Check if username presents?</span>
      if user is None:  
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect username</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Check if user is active? (We are not using Flask-Login inactive check!)</span>
      if not user.active:
         flash(u'Your account is inactive')  <span class="color-comment"># to log inactive user</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Verify password</span>
      if not user.verify_password(passwd):
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect password</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Flask-Login: establish session for this user</span>
      login_user(user)
      return redirect(url_for('start_app'))

   <span class="color-comment"># Initial GET request, and POST request with invalid data</span>
   return render_template('login.html', form=form)

@app.route("/start_app")
@login_required  <span class="color-comment"># Flask-Login: Check if user session exists</span>
def start_app():
   return render_template('start_app.html')

@app.route("/logout")
@login_required
def logout():
   <span class="color-comment"># Flask-Login: clear this user session</span>
   logout_user()
   return redirect(url_for('login'))

if __name__ == '__main__':
   <span class="color-comment"># Debug only if running through command line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>

<ol>
<li>Flask-Login also requires you to define a <code>user_loader()</code> method which, given a user ID, returns the associated <code>User</code> object.</li>

<li>You can use <code>user_login(<em>anUserInstance</em>)</code> to login and establish a user session; and <code>user_logout()</code> to logout the current user and clear the session.</li>

<li>Use <code>@login_required</code> decorator to mark those routes, that require login.</li>

<li>The property <code>current_user</code>, a proxy for the current user, is available to all views (see the templates below).</li>

<li>Flask-Login issues &quot;401 Unauthorized&quot; for inactive user, same as incorrect credential. I decided to do my own check for inactive user, so as to issue (and log) different messages.</li>
</ol>

<p><code>templates/base.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;title&gt;My Application&lt;/title&gt;
  &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="color-comment">{# Display flash messages, if any, for all pages #}</span>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    &lt;ul class='flashes'&gt;
    {% for message in messages %}&lt;li&gt;{{ message }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
  {% endif %}
{% endwith %}

<span class="color-comment">{# The body contents here #}</span>
{% block body %}{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre>

<ol>
<li>The <code>base.html</code> template displays all the flash message, and define a <code>body</code> block.</li>
</ol>

<p><code>templates/login.html</code></p>

<pre class="color-example">
{% extends "base.html" %}
{% block body %}
&lt;h1&gt;Login&lt;/h1&gt;
&lt;form method="POST"&gt;
  {{ form.hidden_tag() }}  <span class="color-comment">{# Renders any hidden fields, including the CSRF #}</span>
  {% for field in form if field.widget.input_type != 'hidden' %}
    &lt;div class="field"&gt;
      {{ field.label }} {{ field }}
    &lt;/div&gt;
    {% if field.errors %}
      {% for error in field.errors %}
        &lt;div class="field_error"&gt;{{ error }}&lt;/div&gt;
      {% endfor %}
    {% endif %}
  {% endfor %}
  &lt;input type="submit" value="Go"&gt;
&lt;/form&gt;
{% endblock %}</pre>

<ol>
<li>The <code>login.html</code> template extends the <code>base.html</code>, and displays the <code>LoginForm</code>.</li>
</ol>

<p><code>templates/start_app.html</code></p>

<pre class="color-example">
{% extends "base.html" %}
{% block body %}

{% if current_user.is_authenticated %}
  &lt;h1&gt;Hello, {{ current_user.username }}!&lt;/h1&gt;
{% endif %}

&lt;a href="{{ url_for('logout') }}"&gt;LOGOUT&lt;/a&gt;
{% endblock %}</pre>

<ol>
<li>The <code>start_app.html</code> template extends the <code>base.html</code>, and uses the <code>current_user</code> property to display the <code>username</code>.</li>
</ol>


<p>Try:</p>
<ol>
<li>Login with invalid data to trigger form data validation. Observe the error messages.</li>
<li>Login with incorrect username or password. Check the flash message.</li>
<li>Login with correct username/password. (Redirect to <code>start_app.html</code>)</li>
<li>Login with inactive user. Check the flash message.</li>
<li>Access /start_app and /logout pages with logging in (Error: 401 Unauthorized).</li>
</ol>

<h5>More on Flask-Login</h5>

<p>When a user attempts to access a <code>login_required</code> view within logging in, Flask-Login will flash a message and redirect him to <code>LoginManager.login_view</code> (with a URL appending with <code>?next=page-trying-to-access</code>); or abort with 401 if it is not set. You can also customize the flash message in <code>LoginManager.login_message</code> and <code>Login_manager.login_message_category</code>.</p>


<h4>Python-LDAP</h4>

<p>The Lightweight Directory Access Protocol (LDAP) is a distributed directory service protocol that runs on top of TCP/IP. LDAP is based on a subset of X.500 standard. A common usage of LDAP is to provide a single-sign-on where a user can use a common password to access many services.</p>

<p>LDAP provides a mechanism for connecting to, searching and modifying Internet directories. A client may request for the following operations:</p>

<ol>
<li>StartTLS: Use TLS (or SSL) for secure connection.</li>
<li>Bind/Unbind: to the server.</li>
<li>Search: search and retrieve directory entries.</li>
<li>Add, delete, modify, compare an entry.</li>
</ol>

<p>A directory entry contains a set of attributes, e.g.,</p>
<pre class="color-example">
dn: cn=Peter Smith,ou=IT Dept,dc=example,dc=com
cn: Peter Smith
givenName: Peter
sn: Smith
......
</pre>

<ol>
<li><code>dn</code>: the <em>Distinguish Name</em> of the entry. &quot;<code>cn=Peter Smith</code>&quot; is the RDN (Relative Distinguish Name); &quot;<code>dc=example,dc=com</code>&quot; is the DN (Domain Name), where <code>dc</code> denotes Domain Component.</li>
<li><code>cn</code>: <em>Common Name</em></li>
<li><code>sn</code>: <em>Surname</em></li>
</ol>

<p>Python-LDAP provides utilities to access LDAP directory servers using OpenLDAP.</p>

<h5>Installing Python-LDAP</h5>

<pre class="color-command">
<span class="color-comment"># These Python packages are needed</span>
$ <strong>sudo apt-get install python-dev libldap2-dev libsasl2-dev</strong>

$ <strong>sudo pip install python-ldap</strong>

$ <strong>pip show python-ldap</strong>
Name: python-ldap
Version: 2.4.22
Location: /usr/local/lib/python2.7/dist-packages
Requires: setuptools</pre>

<h5>Example: Authenticate a User</h5>

<pre class="color-example">
import ldap

<span class="color-comment"># Connect to the LDAP server</span>
conn = ldap.initialize('ldap://server-name')

<span class="color-comment"># Set LDAP options, if needed</span>
conn.set_option(ldap.OPT_X_TLS_DEMAND, True)

<span class="color-comment"># Start a secure connection</span>
conn.start_tls_s()  <span class="color-comment"># s for synchronous operation</span>

<span class="color-comment"># Authenticate a user by binding to the directory
# dn: user's distinguish name
# pw: password
# Raise LDAPError if bind fails</span>
try:
   conn.bind_s(dn, pw)   <span class="color-comment"># You need to figure out the DN</span>
   print('Authentication Succeeds')   
except ldap.LDAPError as e:
   print(e)
   print('Authentication Fails')</pre>


<h4>Flask-Principal</h4>

<p>Reference: Flask-Principal @ <a href="http://pythonhosted.org/Flask-Principal/">http://pythonhosted.org/Flask-Principal/</a>.</p>

<h5>Installing Flask-Principal</h5>

<pre class="color-command">
$ <strong>sudo pip install flask-principal</strong>

$ <strong>pip show flask-principal</strong>
Name: Flask-Principal
Version: <strong>0.4.0</strong>
Requires: Flask, blinker</pre>

<h5>Using Flask-Principal</h5>

<p>Flask-Principal is a permission extension, which manages who can access what and to what extent. It is often used together with Flask-Login, which handles login, logout and user session.</p>

<p>Flask-Principal handles permissions through these objects:</p>
<ol>
<li><code>Permission</code> and <code>Need</code>: A <code>Permission</code> object contains a list of <code>Need</code>s that must be satisfied in order to do something (e.g., accessing a link). A <code>Need</code> object is simply a <code>namedtuple</code> (in <code>collections</code> module), e.g., <code>RoleNeed('admin')</code>, <code>UserNeed('root')</code>. You could define your own needs, or use pre-defined needs such as <code>RoleNeed(<em>role_name</em>)</code>, <code>UserNeed<em>username</em></code> or <code>ItemNeed</code>.<br />

To create a <code>Permission</code>, invoke <code>Permission(*Needs)</code> constructor, e.g.,
<pre class="color-example">
<span class="color-comment"># Create a 'Permission' with a single 'Need', in this case a 'RoleNeed'.</span>
admin_permission = Permission(RoleNeed('admin'))

<span class="color-comment"># Create a 'Permission' with a set of 'Need's.</span>
root_admin_permission = Permission(RoleNeed('admin'), UserNeed('root'))</pre></li>

<li><code>Identity</code>: An <code>Identity</code> instance identifies a user. This instance shall be created immediately after logging in to represent the current user, via constructor <code>Identity(<em>id</em>)</code> where <code><em>id</em></code> is a unique ID.<br />
An <code>Identity</code> instance possesses a list of <code>Need</code>s that it can satisfy (kept in attribute <code>provides</code>). To add a <code>Need</code> to an <code>Identity</code>:
<pre class="color-example">
identity.provides.add(RoleNeed('admin'))
identity.provides.add(UserNeed('root'))</pre>
There is a pre-defined <code>AnonymousIdentity</code>, which provides no <code>Need</code>s, to be used after a user has logged out.</li>

<li><code>IdentityContext(<em>permission</em>)</code>: The <code>IdentityContext</code> object is used to test an <code>Identity</code> against a <code>Permission</code>. Recall that an <code>Identity</code> has a set of <code>Need</code>s it can provides; while a protected resource has a <code>Permission</code> which is also a set of <code>Need</code>s. These two sets are compared to determine whether access could be granted.<br />

You can test an <code>IdentityContext</code> (against a <code>Permission</code>) as a decorator, or under a context manager in a <code>with</code>-statement, e.g.,
<pre class="color-example">
admin_permission = Permission(RoleNeed('admin'))

<span class="color-comment"># Protect a view via a 'decorator'</span>
@app.route('/admin')
@admin_permission.require()  <span class="color-comment"># Does the current Identify provide RoleNeed('admin')?</span>
def do_admin():
   return 'Only if you have role of admin'

<span class="color-comment"># Protect under a context manager in with-statement</span>
@app.route('/admin1')
def do_admin1():
   with admin_permission.require():  <span class="color-comment"># Does the current Identify provide RoleNeed('admin')?</span>
      return 'Only if you have role of admin'</pre></li></ol>

<h5>Example 1: Using Flask-Principal for Permissions with Flask-Login for Authentication</h5>

<p><code>models1.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;[models1] Flask-Principal Example: Define Models and Database Interface&quot;&quot;&quot;
from flask.ext.login import UserMixin
from flask.ext.sqlalchemy import SQLAlchemy
from passlib.hash import bcrypt
 
db = SQLAlchemy()
 
class User(db.Model, UserMixin):
   &quot;&quot;&quot;
   Flask-SQLAlchemy: Define a 'User' model mapped to table 'user'.
   Flask-Login: Needs 4 properties/method. Use default implementation in UserMixin.
   &quot;&quot;&quot;
   username = db.Column(db.String(30), primary_key=True)
   pwhash   = db.Column(db.String(300), nullable=False)
   active   = db.Column(db.Boolean, nullable=False, default=False)
   roles    = db.relationship('Role', backref='user', lazy='dynamic')
         <span class="color-comment"># A user can have zero or more roles</span>
 
   def __init__(self, username, password, active=False):
      &quot;&quot;&quot;Constructor&quot;&quot;&quot;
      self.pwhash = bcrypt.encrypt(password)  <span class="color-comment"># hash password</span>
      self.username = username
      self.active = active
 
   @property  <span class="color-comment"># Override UserMixin</span>
   def is_active(self):
      &quot;&quot;&quot;Flask-Login: return True if the user is active.&quot;&quot;&quot;
      return self.active
 
   def get_id(self):  <span class="color-comment"># Override UserMixin</span>
      &quot;&quot;&quot;Flask-Login: return a unique ID in unicode.&quot;&quot;&quot;
      return unicode(self.username)
 
   def verify_password(self, in_password):
      &quot;&quot;&quot;Verify given password with stored hash password&quot;&quot;&quot;
      return bcrypt.verify(in_password, self.pwhash)
 
class Role(db.Model):
   &quot;&quot;&quot;
   Define the 'Role' model mapped to table 'role'
   &quot;&quot;&quot;
   rolename = db.Column(db.String(60), primary_key=True)
   username = db.Column(db.String(30), db.ForeignKey('user.username'), primary_key=True)
 
def load_db(db):
   &quot;&quot;&quot;Initialize the database tables and records&quot;&quot;&quot;
   db.drop_all()
   db.create_all()
   db.session.add_all(
         [User('user1', 'xxxx', True),
          User('user2', 'yyyy', True)])
   db.session.commit()
   db.session.add_all(
         [Role(rolename='admin', username='user1'),
          Role(rolename='user', username='user1'),  <span class="color-comment"># multiple roles</span>
          Role(rolename='user', username='user2')])
   db.session.commit()</pre>

<ol>
<li>We added a <code>Role</code> model with roles of <code>'admin'</code> and <code>'user'</code>. We intend to use the pre-defined <code>RoleNeed(<em>rolename</em>)</code>.</li>
<li>In this example, a user could have one or more roles, which can be retrieved via the relationship <code>roles</code>.</li>
</ol>

<p><code>forms1.py</code>: Same as Flask-Login example.</p>

<p><code>controller1.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;[controllers1] Flask-Principal Example: Testing Flask-Principal for managing permissions with Flask-Login&quot;&quot;&quot;
from flask import Flask, render_template, redirect, flash, abort, url_for, session
from flask.ext.login import LoginManager, login_user, logout_user, current_user, login_required
from flask.ext.principal import Principal, Permission, Identity, AnonymousIdentity
from flask.ext.principal import RoleNeed, UserNeed, identity_loaded, identity_changed
from models1 import db, User, Role, load_db   <span class="color-comment"># Our models</span>
from forms1 import LoginForm                  <span class="color-comment"># Our web forms</span>
 
<span class="color-comment"># Flask: --- Setup ----------------------------------------------</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-WTF: ---  Setup -----------------------------------------</span>
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Flask-WTF: needed for CSRF</span>
 
<span class="color-comment"># Flask-SQLAlchemy: ---  Setup ----------------------------------</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
<span class="color-comment"># Flask-Login: ---  Setup ---------------------------------------</span>
login_manager = LoginManager()
login_manager.init_app(app)
 
@login_manager.user_loader
def user_loader(username):
   &quot;&quot;&quot;For Flask-Login. Given an ID, return the associated User object, or None&quot;&quot;&quot;
   return User.query.get(username)
 
<span class="color-comment"># Flask-Principal: ---  Setup ------------------------------------</span>
principal = Principal()
principal.init_app(app)
 
<span class="color-comment"># Flask-Principal: Create a permission with a single RoleNeed</span>
admin_permission = Permission(RoleNeed('admin'))
 
<span class="color-comment"># Flask-Principal: Add the Needs that this user can satisfy</span>
@identity_loaded.connect_via(app)
def on_identity_loaded(sender, identity):
   <span class="color-comment"># Set the identity user object</span>
   identity.user = current_user
 
   <span class="color-comment"># Add the UserNeed to the identity (We are not using UserNeed here)</span>
   if hasattr(current_user, 'username'):
      identity.provides.add(UserNeed(current_user.username))
 
   <span class="color-comment"># Assuming the User model has a list of roles, update the</span>
   <span class="color-comment"># identity with the roles that the user provides</span>
   if hasattr(current_user, 'roles'):
      for role in current_user.roles:
         identity.provides.add(RoleNeed(role.rolename))
 
<span class="color-comment"># Flask: --- Routes ---------------------------------------------</span>
@app.route(&quot;/login&quot;, methods=['GET', 'POST'])
def login():
   form = LoginForm()
 
   if form.validate_on_submit():  <span class="color-comment"># POST request with valid data?</span>
      <span class="color-comment"># Retrieve POST parameters (alternately via request.form)</span>
      _username = form.username.data
      _passwd = form.passwd.data
      <span class="color-comment"># Query 'user' table with 'username'. Get first row only</span>
      user = User.query.filter_by(username=_username).first()
 
      <span class="color-comment"># Check if username presents?</span>
      if user is None:
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect username</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Check if user is active? (We are not using Flask-Login inactive check!)</span>
      if not user.active:
         flash(u'Your account is inactive')  <span class="color-comment"># to log inactive user</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Verify password</span>
      if not user.verify_password(_passwd):
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect password</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Flask-Login: establish session for this user</span>
      login_user(user)
 
      <span class="color-comment"># Flask-Principal: Create an Identity object and</span>
      <span class="color-comment">#   signal that the identity has changed,</span>
      <span class="color-comment">#    which triggers on_identify_changed() and on_identify_loaded()</span>
      <span class="color-comment"># The Identity() takes a unique ID</span>
      identity_changed.send(app, identity=Identity(user.username))
 
      return redirect(url_for('main'))
 
   <span class="color-comment"># Initial GET request, and POST request with invalid data</span>
   return render_template('login1.html', form=form)
 
@app.route(&quot;/main&quot;)
@login_required              <span class="color-comment"># Flask-Login: Check if user session exists</span>
@admin_permission.require()  <span class="color-comment"># Flask-Principal: Check if user having RoleNeed('admin')</span>
def main():
   return render_template('main1.html')
 
@app.route(&quot;/logout&quot;)
@login_required
def logout():
   <span class="color-comment"># Flask-Login: Clear this user session</span>
   logout_user()
 
   <span class="color-comment"># Flask-Principal: Remove session keys</span>
   for key in ('identity.name', 'identity.auth_type'):
      session.pop(key, None)
   <span class="color-comment"># Flask-Principal: the user is now anonymous</span>
   identity_changed.send(app, identity=AnonymousIdentity())
 
   return redirect(url_for('login'))
 
if __name__ == '__main__':
   <span class="color-comment"># Debug only if running through command line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>

<ol>
<li>Immediately after the user has logged in, an <code>Identity</code> object is created, and <code>identity_changed</code> signal sent. This signal triggers <code>on_identity_changed()</code> (not implemented), and in turn <code>on_identity_loaded()</code>.</li>

<li>In <code>on_identity_loaded()</code>, we update the <code>RoleNeed</code> and <code>UserNeed</code> for which this user can provide, based on information about this user (<code>roles</code> and <code>username</code>).</li>

<li>The view <code>main</code> is protected with decorator <code>@admin_permission.require()</code>. In other words, only users who can provide <code>RoleNeed('admin')</code> are granted access.</li>

<li>After the user has logged out, we remove the current identity, set the identity to <code>AnonymousIdentity</code>, and signal <code>identity_changed</code> which updates the <code>RoleNeed</code> and <code>UserNeed</code> (to nothing).</li>
</ol>

<p><code>templates</code>: Same as Flask-Login example.</p>

<p>Try:</p>

<ol>
<li>Login with <code>user1</code>, who has <code>admin</code> role. The app redirects to <code>start_app.html</code>, which requires <code>admin</code> role.</li>
<li>Login with <code>user2</code>, who does not have <code>admin</code> role. The Flask-Principal raises <code>PermissionDenied</code>.</li>
</ol>

<p>In the above example, if the permission test fails, a <code>PermissionDenied</code> is raised. You can tell Flask-Principal that you want to raise a specific HTTP error code instead:</p>

<pre class="color-example">
@app.route("/start_app")
@login_required
@admin_permission.require(<strong>http_exception=403</strong>)
def start_app():
   ......</pre>

<p>The 403 is the response status code for &quot;No Permissions&quot; or &quot;Forbidden&quot; (401 for &quot;Unauthorized&quot;). Now, <code>flask.abort(403)</code> will be called. You can also register an error handler for 403 as follows:</p>

<pre class="color-example">
@app.errorhandler(403)
def unauthorized(e):
    session['redirected_from'] = request.url
    flash('You have no permissions to access this page')
       <span class="color-comment"># Google &quot;Flask message flashing fails across redirects&quot; to fix this</span>
    return redirect(url_for('login'))</pre>

<h5>Example 2: Granular Resource Protection</h5>

<p><code>models2.py</code>: Add a model called <code>Post</code>, for the post written by users.</p>

<pre class="color-example">
......
class Post(db.Model):
   post_id = db.Column(db.Integer, primary_key=True, autoincrement=True)  
   username = db.Column(db.String(30), db.ForeignKey('user.username'))
   data = db.Column(db.Text)

def load_db(db):
   ......
   db.session.add_all([
         Post(post_id=1, username='user1', data='This is post 1'),
         Post(post_id=2, username='user1', data='This is post 2'),
         Post(post_id=3, username='user2', data='This is post 3')
      ])
   db.session.commit()</pre>

<p><code>forms2.py</code>: same as previous example.</p>

<p><code>controllers2.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
&quot;&quot;&quot;[controller2] Flask-Principal Example: Granular Resource Protection&quot;&quot;&quot;
from collections import namedtuple
from flask import Flask, render_template, redirect, flash, abort, url_for, session, request
from flask.ext.login import LoginManager, login_user, logout_user, current_user, login_required
from flask.ext.principal import Principal, Permission, Identity, AnonymousIdentity
from flask.ext.principal import RoleNeed, UserNeed, identity_loaded, identity_changed
from models2 import db, User, Role, load_db   <span class="color-comment"># Our models</span>
from forms2 import LoginForm                  <span class="color-comment"># Our web forms</span>
 
<span class="color-comment"># Flask: --- Setup ----------------------------------------------</span>
app = Flask(__name__)
 
<span class="color-comment"># Flask-WTF: ---  Setup -----------------------------------------</span>
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Flask-WTF: needed for CSRF</span>
 
<span class="color-comment"># Flask-SQLAlchemy: ---  Setup ----------------------------------</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql:<span class="color-comment">//testuser:xxxx@localhost:3306/testdb'</span>
db.init_app(app)   <span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
 
<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)
 
<span class="color-comment"># Flask-Login: ---  Setup ---------------------------------------</span>
login_manager = LoginManager()
login_manager.init_app(app)
 
@login_manager.user_loader
def user_loader(username):
   &quot;&quot;&quot;For Flask-Login. Given an ID, return the associated User object, or None&quot;&quot;&quot;
   return User.query.get(username)
 
<span class="color-comment"># Flask-Principal: ---  Setup ------------------------------------</span>
principal = Principal()
principal.init_app(app)
 
<span class="color-comment"># Flask-Principal: Create a permission with a single RoleNeed</span>
admin_permission = Permission(RoleNeed('admin'))
 
PostNeed = namedtuple('PostNeed', ['action', 'post_id'])
      <span class="color-comment"># e.g., PostNeed['get', '123'], PostNeed['update', '123'], PostNeed['delete', '123'],</span>
      <span class="color-comment">#       PostNeed['create'], PostNeed['list']</span>
 
class PostPermission(Permission):
   &quot;&quot;&quot;Extend Permission to take a post_id and action as arguments&quot;&quot;&quot;
   def __init__(self, action, post_id=None):
      need = PostNeed(action, post_id)
      super(PostPermission, self).__init__(need)
 
<span class="color-comment"># Flask-Principal: Add the Needs that this user can satisfy</span>
@identity_loaded.connect_via(app)
def on_identity_loaded(sender, identity):
   <span class="color-comment"># Set the identity user object</span>
   identity.user = current_user
 
   <span class="color-comment"># Add the UserNeed to the identity (We are not using UserNeed here)</span>
   if hasattr(current_user, 'username'):
      identity.provides.add(UserNeed(current_user.username))
 
   <span class="color-comment"># The User model has a list of roles, update the identity with</span>
   <span class="color-comment"># the roles that the user provides</span>
   if hasattr(current_user, 'roles'):
      for role in current_user.roles:
         identity.provides.add(RoleNeed(role.rolename))
 
   <span class="color-comment"># The User model has a list of posts the user has authored,</span>
   <span class="color-comment"># add the needs to the identity</span>
   if hasattr(current_user, 'posts'):
      identity.provides.add(PostNeed('list', None))
      identity.provides.add(PostNeed('create', None))
      for post in current_user.posts:
         identity.provides.add(PostNeed('get', unicode(post.post_id)))
         identity.provides.add(PostNeed('update', unicode(post.post_id)))
         identity.provides.add(PostNeed('delete', unicode(post.post_id)))
 
<span class="color-comment"># Flask: --- Routes ---------------------------------------------</span>
@app.route(&quot;/login&quot;, methods=['GET', 'POST'])
def login():
   form = LoginForm()
 
   if form.validate_on_submit():  <span class="color-comment"># POST request with valid data?</span>
      <span class="color-comment"># Retrieve POST parameters (alternately via request.form)</span>
      _username = form.username.data
      _passwd = form.passwd.data
      <span class="color-comment"># Query 'user' table with 'username'. Get first row only</span>
      user = User.query.filter_by(username=_username).first()
 
      <span class="color-comment"># Check if username presents?</span>
      if user is None:
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect username</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Check if user is active? (We are not using Flask-Login inactive check!)</span>
      if not user.active:
         flash(u'Your account is inactive')  <span class="color-comment"># to log inactive user</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Verify password</span>
      if not user.verify_password(_passwd):
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect password</span>
         return redirect(url_for('login'))
 
      <span class="color-comment"># Flask-Login: establish session for this user</span>
      login_user(user)
 
      <span class="color-comment"># Flask-Principal: Create an Identity object and</span>
      <span class="color-comment">#   signal that the identity has changed,</span>
      <span class="color-comment">#    which triggers on_identify_changed() and on_identify_loaded()</span>
      <span class="color-comment"># The Identity() takes a unique ID</span>
      identity_changed.send(app, identity=Identity(user.username))
 
      return redirect(url_for('main'))
 
   <span class="color-comment"># Initial GET request, and POST request with invalid data</span>
   return render_template('login2.html', form=form)
 
@app.route(&quot;/main&quot;)
@login_required              <span class="color-comment"># Flask-Login: Check if user session exists</span>
@admin_permission.require()  <span class="color-comment"># Flask-Principal: Check if user having RoleNeed('admin')</span>
def main():
   return render_template('main2.html')
 
@app.route(&quot;/logout&quot;)
@login_required
def logout():
   <span class="color-comment"># Flask-Login: Clear this user session</span>
   logout_user()
 
   <span class="color-comment"># Flask-Principal: Remove session keys</span>
   for key in ('identity.name', 'identity.auth_type'):
      session.pop(key, None)
 
   <span class="color-comment"># Flask-Principal: the user is now anonymous</span>
   identity_changed.send(app, identity=AnonymousIdentity())
 
   return redirect(url_for('login'))
 
@app.route('/post/', methods=['GET', 'POST'])
def posts():
   if request.method == 'GET':
      permission = PostPermission('list')
      if not permission.can():
         abort(403)  <span class="color-comment"># Forbidden</span>
      return &quot;You can list all the posts!&quot;
 
   if request.method == 'POST':
      permission = PostPermission('create')
      if not permission.can():
         abort(403)  <span class="color-comment"># Forbidden</span>
      return &quot;You can create new post!&quot;
 
   abort(405)  <span class="color-comment"># method not supported</span>
 
@app.route('/post/&lt;post_id&gt;', methods=['GET', 'PUT', 'DELETE'])
def post(post_id):
   if request.method == 'GET':
      permission = PostPermission('get', unicode(post_id))
      if not permission.can():
         abort(403)  <span class="color-comment"># Forbidden</span>
      return &quot;You can read this post!&quot;
 
   if request.method == 'POST':
      permission = PostPermission('update', unicode(post_id))
      if not permission.can():
         abort(403)  <span class="color-comment"># Forbidden</span>
      return &quot;You can edit this post!&quot;
 
   if request.method == 'DELETE':
      permission = PostPermission('delete', unicode(post_id))
      if not permission.can():
         abort(403)  <span class="color-comment"># Forbidden</span>
      return &quot;You can delete this post!&quot;
 
   abort(405)  <span class="color-comment"># method not supported</span>
 
if __name__ == '__main__':
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>

<p><code>/templates</code>: Same as previous example.</p>

<ol>
<li>We define our custom <code>Need</code> called <code>PostNeed</code>, which takes two parameters, <code>action</code> an optional <code>post_id</code>. For example, <code>PostNeed['get', '123']</code>, <code>PostNeed['update', '123']</code>, <code>PostNeed['delete', '123']</code>, <code>PostNeed['create']</code>, <code>PostNeed['list']</code>, followed the conventions used in RESTful API.</li>

<li>We also define our custom <code>Permission</code> called <code>PostPermission</code>, which contains a <code>PostNeed</code>, which also takes two arguments, <code>action</code> an optional <code>post_id</code>.</li>

<li>In <code>on_identity_loaded</code>, we added the <code>PostNeed</code> that the user can provide.</li>

<li>We use two routes: <code>/post/</code> for get-all and create, <code>/post/&lt;post-id&gt;</code> for get, update, and delete for a particular post, followed the conventions in RESTful API.</li>

<li>Inside the view function, we create the required permission and verify if the current user can provide via <code>can()</code> method, before processing the request.</li>
</ol>


<h4>Flask-Admin</h4>

<p>Reference: Flask-Admin @ <a href="https://flask-admin.readthedocs.org/en/latest/">https://flask-admin.readthedocs.org/en/latest/</a>.</p>

<p>Flask-Admin helps you build an admin interface on top of an existing data model, and lets you manage your web service's data through a user-friendly interface.</p>

<h5>Install Flask-Admin</h5>

<pre class="color-command">
$ <strong>sudo pip install flask-admin</strong>

$ <strong>pip show flask-admin</strong>
Name: Flask-Admin
Version: 1.3.0
Location: /usr/local/lib/python2.7/dist-packages
Requires: Flask, wtforms</pre>

<h5>Example: Using Flask-Admin</h5>

<p><code>models.py</code>: same as Flask-Principal example.</p>

<p><code>forms.py</code>: same as Flask-Principal example.</p>

<p><code>controller.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(controller.py) Flask-Admin: Testing Flask-Admin"""</span>
from flask import Flask, render_template, redirect, flash, abort, request, url_for, session
from flask.ext.admin import Admin
from flask.ext.admin.contrib.sqla import ModelView
from flask.ext.login import LoginManager, login_user, logout_user, current_user, login_required
from flask.ext.principal import Principal, Permission, Identity, AnonymousIdentity
from flask.ext.principal import RoleNeed, UserNeed, identity_loaded, identity_changed
from models import db, User, Role, load_db   <span class="color-comment"># Our models</span>
from forms import LoginForm                  <span class="color-comment"># Our web forms</span>

<span class="color-comment"># Flask: --- Setup ----------------------------------------------</span>
app = Flask(__name__)

<span class="color-comment"># Flask-WTF: ---  Setup -----------------------------------------</span>
app.config['SECRET_KEY'] = 'YOUR-SECRET'  <span class="color-comment"># Flask-WTF: needed for CSRF</span>

<span class="color-comment"># Flask-SQLAlchemy: ---  Setup ----------------------------------</span>
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://testuser:xxxx@localhost:3306/testdb'
db.init_app(app)   # Bind Flask-SQLAlchemy to this Flask app

<span class="color-comment"># Create the database tables and records inside a temporary test context</span>
with app.test_request_context():
   load_db(db)

<span class="color-comment"># Flask-Login: ---  Setup ---------------------------------------</span>
login_manager = LoginManager()
login_manager.init_app(app)

@login_manager.user_loader
def user_loader(username):
   <span class="color-comment">"""For Flask-Login. Given an ID, return the associated User object, or None"""</span>
   return User.query.get(username)

<span class="color-comment"># Flask-Principal: ---  Setup ------------------------------------</span>
principal = Principal()
principal.init_app(app)

<span class="color-comment"># Flask-Principal: Create a permission with a single RoleNeed</span>
admin_permission = Permission(RoleNeed('admin'))

<span class="color-comment"># Flask-Principal: Add the Needs that this user can satisfy</span>
@identity_loaded.connect_via(app)
def on_identity_loaded(sender, identity):
   <span class="color-comment"># Set the identity user object</span>
   identity.user = current_user

   <span class="color-comment"># Add the UserNeed to the identity</span>
   if hasattr(current_user, 'username'):
      identity.provides.add(UserNeed(current_user.username))

   <span class="color-comment"># Assuming the User model has a list of roles, update the
   # identity with the roles that the user provides</span>
   if hasattr(current_user, 'roles'):
      for role in current_user.roles:
         identity.provides.add(RoleNeed(role.name))

<span class="color-comment"># Flask-Admin: ---  Setup ----------------------------------------</span>
<strong>admin = Admin(name='Admin')
admin.add_view(ModelView(User, db.session, category='Database'))
admin.add_view(ModelView(Role, db.session, category='Database'))
admin.init_app(app)</strong>  <span class="color-comment"># Bind Flask-Admin to this Flask app</span>

<span class="color-comment"># Flask: --- Routes ---------------------------------------------</span>
@app.route("/login", methods=['GET', 'POST'])
def login():
   form = LoginForm()

   if form.validate_on_submit():  <span class="color-comment"># POST request with valid data?</span>
      <span class="color-comment"># Retrieve POST parameters (alternately via request.form)</span>
      username = form.username.data
      passwd = form.passwd.data
      <span class="color-comment"># Query 'user' table with 'username'. Get first row only</span>
      user = User.query.filter_by(username=username).first()

      <span class="color-comment"># Check if username presents?</span>
      if user is None:  
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect username</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Check if user is active? (We are not using Flask-Login inactive check!)</span>
      if not user.active:
         flash(u'Your account is inactive')  <span class="color-comment"># to log inactive user</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Verify password</span>
      if not user.verify_password(passwd):
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect password</span>
         return redirect(url_for('login'))

      <span class="color-comment"># Flask-Login: establish session for this user</span>
      login_user(user)

      <span class="color-comment"># Flask-Principal: signal that the identity has changed.
      #   Trigger on_identify_changed() and on_identify_loaded()
      # The Identity() takes a unique ID</span>
      identity_changed.send(app, identity=Identity(user.username))

      return redirect(url_for('start_app'))

   <span class="color-comment"># Initial GET request, and POST request with invalid data</span>
   return render_template('login.html', form=form)

@app.route("/start_app")
@login_required              <span class="color-comment"># Flask-Login: Check if user session exists</span>
@admin_permission.require(http_exception=403)  <span class="color-comment"># Flask-Principal: Check if user having RoleNeed('admin')</span>
def start_app():
   return render_template('start_app.html')

@app.route("/logout")
@login_required
def logout():
   <span class="color-comment"># Flask-Login: Clear this user session</span>
   logout_user()

   <span class="color-comment"># Flask-Principal: Remove session keys</span>
   for key in ('identity.name', 'identity.auth_type'):
      session.pop(key, None)

   <span class="color-comment"># Flask-Principal: the user is now anonymous</span>
   identity_changed.send(app, identity=AnonymousIdentity())

   return redirect(url_for('login'))

if __name__ == '__main__':
   <span class="color-comment"># Debug only if running through command line</span>
   app.config['SQLALCHEMY_ECHO'] = True
   app.debug = True
   app.run()</pre>
   
<p><code>templates</code>: same as Flask-Principal example.</p>

<p>Try:</p>

<ol>
<li>login as <code>user1</code> (who has <code>admin</code> role), and switch URL to <code>http://127.0.0.1/admin</code>. Test out the admin pages, which can CRUD our data models.</li>
</ol>

<p>How it Works</p>

<ol>
<li>We only added these 4 lines to enable the Flask-Admin (together with the necessary imports)!!!
<pre class="color-example">
admin = Admin(name='Admin')
admin.add_view(ModelView(User, db.session, category='Database'))
admin.add_view(ModelView(Role, db.session, category='Database'))
admin.init_app(app)</pre></li>

<li>Line 1 constructs an <code>Admin</code> object, with a <code>name</code> shown as the header for the admin pages.  Line 4 binds the Flask-Admin to the Flask app.</li>

<li>[TODO] Line 2 and 3</li>
</ol>

<h5>Apply Permissions to Admin Pages</h5>

<p>In the previous example, the Admin pages are not protection via permissions. Try login with <code>user2</code>, who has no <code>admin</code> role, and switch the URL to <code>http://127.0.0.1:5000/admin</code>.</p>

<p>To protect the admin pages, add the followings into <code>controller.py</code>:</p>

<pre class="color-example">
from flask import g
from flask.ext.admin import expose, AdminIndexView
......
......
<span class="color-comment"># Flask-Admin: Initialize</span>
class AuthMixinView(object):
   def is_accessible(self):
      has_auth = current_user.is_authenticated
      has_perm = admin_permission.allows(g.identity)
      return has_auth and has_perm

class AuthModelView(AuthMixinView, ModelView):
   @expose()
   @login_required
   def index_view(self):
      return super(ModelView, self).index_view()

class AuthAdminIndexView(AuthMixinView, AdminIndexView):
   @expose()
   @login_required
   def index_view(self):
      return super(AdminIndexView, self).index_view()

admin = Admin(name='Admin', index_view=AuthAdminIndexView())</pre>

<p>Now, only users with <code>admin</code> role can access the admin pages.</p>

<p>How it Works</p>

<ol>
<li>We extend both <code>ModelView</code> and <code>AdminIndexView</code> in a design pattern called <code>mixin</code>. We override the <code>is_accessible()</code> method, so that users without permission will receive a 403; and overwrite the <code>index_
view()</code> for <code>AdminIndexView</code> and <code>ModelView</code>, adding the <code>login_required</code> decorator.</li>
<li>[TODO] customization on CRUD.</li>
</ol>

<p>[TODO] MORE</p>

<h4>Flask-Mail</h4>

<p>Reference: Flask-Mail @ <a href="https://pythonhosted.org/Flask-Mail/">https://pythonhosted.org/Flask-Mail/</a>.</p>

<p>The Flask-Mail extension provides a simple interface to set up SMTP inside Flask app, and to send emails from your views and scripts.</p>

<h5>Installing Flask-Mail</h5>

<pre class="color-command">
$ <strong>sudo pip install Flask-Mail</strong>

$ <strong>pip show flask-mail</strong>
Name: Flask-Mail
Version: <strong>0.9.1</strong>
Location: /usr/local/lib/python2.7/dist-packages
Requires: Flask, blinker</pre>

<h5>Example: Using Flask-Mail to Send Mail in Flask App</h5>

<pre class="color-example">
from flask import Flask
from flask_mail import Mail, Message

app = Flask(__name__)

mail = Mail()
mail.init_app(app)
      <span class="color-comment"># Or: mail = Mail(app)</span>

@app.route("/")
def index():
   msg = Message("Hello", sender="from@example.com", recipients=["to@example.com"])
         <span class="color-comment"># Create a Message instance with a 'subject'
         # You can set the MAIL_DEFAULT_SENDER and omit 'sender'
         # The 'recipients' is a list</span>
   msg.body = "testing"
         <span class="color-comment"># Add body</span>
   mail.send(msg)
         <span class="color-comment"># Send</span>
   return "Email Sent"

if __name__ == '__main__':
   app.run(debug=True)</pre>

<p>These configuration options (to be set in <code>app.config</code>) are available:</p>
<ul>
<li><code>MAIL_SERVER</code>: default <code>'localhost'</code></li>
<li><code>MAIL_PORT</code>: default <code>25</code></li>
<li><code>MAIL_DEFAULT_SENDER</code>: default <code>None</code></li>
<li>more</li>
</ul>

<h3>Structuring Large Application with Blueprints</h3>

<p>As you app grows, Flask Blueprints allow you to modularize, structure and organize you large project.</p>


<h5>Python Modules, Packages and Import - Recap</h5>

<p>Recall that a Python module is any <code>.py</code> file. You can import a module, or an attribute inside a module.</p>

<p>A Python package is a directory containing an <code>__init__.py</code> file. This <code>__init__.py</code> is analogous to the class-constructor, i.e., whenever a package is imported, its <code>__init__.py</code> will be executed. You can import a package, a module inside a package, an attribute inside a module of a package.</p>

<p>[TODO] Relative import</p>

<h5>Example 1: Using Blueprints</h5>

<p>A blueprint defines a collection of views, templates, static files and other resources that can be applied to an application. It allows us to organize our application into components.</p>

<p><code>component1.py</code></p>

<pre class="color-example">
<span class="color-comment">"""component1.py"""</span>
from flask import Blueprint, render_template

<span class="color-comment"># Construct a blueprint for component1, given its name and import-name
# We also specify its template and static directories</span>
component1 = Blueprint('c1', __name__, 
      template_folder='templates', static_folder='static')

@component1.route('/')
@component1.route('/&lt;name&gt;')
def index(name=None):
   if not name:
      name = 'world'

   return render_template('index.html', name=name)</pre>
   
<ol>
<li>We construct a <code>Blueprint</code> object, and set its <code>name</code> to <code>c1</code>. The functions such as <code>index()</code> will be referenced as <code>c1.index()</code>.</li>

<li>A <code>Blueprint</code> can have its own <code>templates</code> and <code>static</code> directories. In the above example, we set them to their default.</li>
</ol>

<p><code>app.py</code></p>

<pre class="color-example">
<span class="color-comment">"""app.py: main entry point"""</span>
from flask import Flask
from component1 import component1  <span class="color-comment"># Module component1.py -&gt; attribute component1</span>  

app = Flask(__name__)
app.register_blueprint(component1)  <span class="color-comment"># Register a Blueprint</span>

if __name__ == '__main__':
   app.debug = True
   app.run()</pre>

<p><code>templates/index.html</code></p>
<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;Main Entry Page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
   &lt;h1&gt;Hello, {{ name }}&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>You can now access the app via <code>http://localhost:5000</code> or <code>http://localhost:5000/&lt;name&gt;</code></p>

<p>You can also specify a <code>url_prefix</code> to all the routes in a blueprint, using keyword argument <code>url_prefix</code> in <code>register_blueprint()</code>, e.g.,</p>

<pre class="color-example">
app.register_blueprint(component1, url_prefix='/c1path')</pre>

<p>Now, you access the app via <code>http://localhost:5000/c1path</code> or <code>http://localhost:5000/c1path/&lt;name&gt;</code></p>

<h5>Organizing Large App using Blueprints</h5>

<pre class="color-example">
myapp
    |-- run.py            <span class="color-comment"># or start.py to run the flask app</span>
    |-- config.ini        <span class="color-comment"># or config.py or /config folder</span>
    |__ /env              <span class="color-comment"># Virtual Environment</span>
    |__ /test             <span class="color-comment"># unit tests and acceptance tests</span>
    |__ /app_main         <span class="color-comment"># Our App and its Components</span>
         |-- __init__.py
         |-- models.py    <span class="color-comment"># Data Models for all components</span>
         |-- /component1  <span class="color-comment"># or application module</span>
             |-- __init__.py
             |-- controllers.py
             |-- forms.py                
         |-- /component2
             |-- __init__.py
             |-- controllers.py
             |-- forms.py
         |......
         |......
         |__ /templates
             |-- 404.html   <span class="color-comment"># Also 401, 403, 500, 503</span>
             |-- base.html  <span class="color-comment"># Base templates to be extended</span>
             |__ /component1
                 |-- extended.html
         |__ /static
             |-- css/
             |-- js/
             |-- images/</pre>
         
<ol>
<li>The <code>run.py</code> (or <code>start.py</code>) starts the Flask app.</li>
<li>The <code>config.ini</code> keeps all the configuration parameters organized in sections such as <code>[app]</code>, <code>[db]</code>, <code>[email]</code>, etc., to be parsed by <code>ConfigParser</code>. [After Note] It is a lot more convenience to use a Python module for configuration!</li>
<li>The common HTTP error codes are:
<ul>
<li>400 Bad Request</li>
<li>401 Unauthorized (wrong username/password, inactive)</li>
<li>403 Forbidden or No Permission (wrong role, no access permission)</li>
<li>404 Not Found</li>
<li>405 Method Not Allowed</li>
<li>500 Internal Server Error</li>
<li>503 Service Unavailable</li>
</ul>
</li>
<li>Some designers prefer to keep the <code>templates</code> and <code>static</code> folders under each component.</li>
</ol>

<h5>Example</h5>
<p>Follow the above structure, with a component called <code>mod_auth</code> for User authentication (the same example from Flask-Login).</p>

<p><code>run.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(run.py) Start Flask built-in development web server"""</span>
from app_main import app  <span class="color-comment"># from package app_main's __init__.py import app</span>

if __name__ == '__main__':
   <span class="color-comment"># for local loopback only, on dev machine</span>
   app.run(host='127.0.0.1', port=5000, debug=True)

   <span class="color-comment"># listening on all IPs, on server</span>
   #app.run(host='0.0.0.0', port=8080, debug=True)</pre>

<p><code>config.ini</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
# (config.ini) Configuration Parameters for the app</span>

[app]
DEBUG: True
SECRET_KEY: YOUR-SECRET

[db]
SQLALCHEMY_DATABASE_URI: mysql://testuser:xxxx@localhost:3306/testdb

[DEFAULT]</pre>

<ol>
<li>We shall use <code>ConfigParser</code> to parse this configuration file.</li>
<li>The format is &quot;<code>key: value</code>&quot;.</li>
<li>After Note: More convenience to use a Python module for config, and load via <code>from_object()</code>, instead of <code>.ini</code> file.</li>
</ol>

<p><code>app_main/models.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(models.py) Data Models for the app, using Flask-SQLAlchemy"""</span>
from flask.ext.sqlalchemy import SQLAlchemy
from flask.ext.login import UserMixin
from passlib.hash import bcrypt  <span class="color-comment"># For hashing password</span>

<span class="color-comment"># Flask-SQLAlchemy: Initialize</span>
db = SQLAlchemy()

<span class="color-comment"># Define a 'Base' model for other database tables to inherit</span>
class Base(db.Model):
   __abstract__  = True
   date_created  = db.Column(db.DateTime,
         default=db.func.current_timestamp())
   date_modified = db.Column(db.DateTime,
         default=db.func.current_timestamp(),
         onupdate=db.func.current_timestamp())

<span class="color-comment"># Define a 'User' model mapped to table 'user' (default to lowercase).
# Flask-Login: Use default implementations in UserMixin</span>
class User(Base, UserMixin):
   username = db.Column(db.String(30), primary_key=True)
   pwhash   = db.Column(db.String(300), nullable=False)  <span class="color-comment"># Store password hash</span>
   active   = db.Column(db.Boolean, nullable=False, default=False)

   def __init__(self, username, password, active=False):
      <span class="color-comment">"""Constructor: to hash password"""</span>
      self.pwhash = bcrypt.encrypt(password)  <span class="color-comment"># hash submitted password</span>
      self.username = username
      self.active = active

   @property   <span class="color-comment"># Convert from method to property (instance variable)</span>
   def is_active(self):
      <span class="color-comment">"""Flask-Login: return True if the user is active."""</span>
      return self.active

   def get_id(self):  <span class="color-comment"># This is method. No @property</span>
      <span class="color-comment">"""Flask-Login: return a unique ID in unicode."""</span>
      return unicode(self.username)

   def verify_password(self, in_password):
      <span class="color-comment">"""Verify the given password with the stored password hash"""</span>
      return bcrypt.verify(in_password, self.pwhash)

def load_db(db):
   <span class="color-comment">"""Create database tables and records"""</span>
   db.drop_all()
   db.create_all()
   db.session.add_all(
         [User('user1', 'xxxx', True),
          User('user2', 'yyyy')])  <span class="color-comment"># inactive</span>
   db.session.commit()</pre>


<p><code>app_main/mod_auth/__init__.py</code>: an empty file</p>

<p><code>app_main/mod_auth/forms.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(forms.py) Web Forms for this module"""</span>
from flask_wtf import Form  <span class="color-comment"># import from flask_wtf, NOT wtforms</span>
from wtforms import StringField, PasswordField  
from wtforms.validators import InputRequired, Length

<span class="color-comment"># Define the LoginRorm class by sub-classing Form</span>
class LoginForm(Form):
   <span class="color-comment"># This form contains two fields with validators</span>
   username = StringField(u'User Name:', validators=[InputRequired(), Length(max=20)])
   passwd = PasswordField(u'Password:', validators=[Length(min=4, max=16)])</pre>

<p><code>app_main/mod_auth/controllers.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(controllers.py) Using Flask-Login for User Session Management"""</span>
from flask import Blueprint, render_template, redirect, flash, abort, url_for
from flask.ext.login import LoginManager, login_user, logout_user, current_user, login_required
from ..models import User     <span class="color-comment"># Our models</span>
from .forms import LoginForm  <span class="color-comment"># Our web forms</span>

<span class="color-comment"># Define a blueprint for this module ----------------------------
# All function endpoints are prefixed with "auth", i.e., auth.fn_name</span>
mod_auth = Blueprint('auth', __name__, 
      template_folder='../templates/mod_auth',
      static_folder='../static')

<span class="color-comment"># Flask-Login ----------------------------------------------------</span>
login_manager = LoginManager()

@login_manager.user_loader
def user_loader(username):
   <span class="color-comment">"""Flask-Login: Given an ID, return the associated User object, or None"""</span>
   return User.query.get(username)

<span class="color-comment"># Define routes for this module -----------------------------------</span>
@mod_auth.route("/login", methods=['GET', 'POST'])
def login():
   form = LoginForm()  <span class="color-comment"># Construct a LoginForm</span>

   if form.validate_on_submit():  <span class="color-comment"># POST request with valid data?</span>
      <span class="color-comment"># Retrieve POST parameters (alternately via request.form)</span>
      username = form.username.data
      passwd = form.passwd.data
      <span class="color-comment"># Query 'user' table with 'username'. Get first row only</span>
      user = User.query.filter_by(username=username).first()

      <span class="color-comment"># Check if username presents?</span>
      if user is None:  
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect username</span>
         return redirect(url_for('.login'))  <span class="color-comment"># Prefix endpoint with this blueprint name</span>

      <span class="color-comment"># Check if user is active? (We are not using Flask-Login inactive check!)</span>
      if not user.active:
         flash(u'Your account is inactive')  <span class="color-comment"># to log inactive user</span>
         return redirect(url_for('.login'))

      <span class="color-comment"># Verify password</span>
      if not user.verify_password(passwd):
         flash(u'Username or Password is incorrect')  <span class="color-comment"># to log incorrect password</span>
         return redirect(url_for('.login'))

      <span class="color-comment"># Flask-Login: establish session for this user</span>
      login_user(user)
      return redirect(url_for('.start_app'))

   <span class="color-comment"># Initial GET request, and POST request with invalid data</span>
   return render_template('login.html', form=form)

@mod_auth.route("/start_app")
@login_required  <span class="color-comment"># Flask-Login: Check if user session exists</span>
def start_app():
   return render_template('start_app.html')

@mod_auth.route("/logout")
@login_required
def logout():
   <span class="color-comment"># Flask-Login: clear this user session</span>
   logout_user()
   return redirect(url_for('.login'))</pre>

<ol>
<li>We construct a <code>Blueprint</code> for this webapp component called <code>mod_auth</code>. The first argument specifies the prefix of the endpoint of the functions in the blueprint. For example, function <code>login()</code> is now <code>auth.login()</code>. We also specify the templates and static folder, relative to this module.</li>
<li>In <code>url_for()</code>, you can refer to function as <code>auth.login</code> or simply <code>.login</code> for functions in this module.</li>
</ol>


<p><code>app_main/__init__.py</code></p>

<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-
"""(__init__.py) app_main package initialization file"""</span>
from flask import Flask, render_template

<span class="color-comment"># Configurations --------------------------------------</span>
import ConfigParser
config = ConfigParser.SafeConfigParser()
config.read('myapp.ini')  <span class="color-comment"># Relative to run.py</span>

<span class="color-comment"># Define the WSGI application object ------------------</span>
app = Flask(__name__)
app.config['SECRET_KEY'] = config.get('app', 'SECRET_KEY')

<span class="color-comment"># Flask-SQLAlchemy -------------------------------------</span>
from flask.ext.sqlalchemy import SQLAlchemy
from models import db, load_db

app.config['SQLALCHEMY_DATABASE_URI'] = config.get('db', 'SQLALCHEMY_DATABASE_URI')
<span class="color-comment"># Bind SQLAlchemy to this Flask app</span>
db.init_app(app)   

<span class="color-comment"># Build the database</span>
with app.test_request_context():
   load_db(db)

<span class="color-comment"># Error Handlers ---------------------------------------</span>
@app.errorhandler(404)
def not_found(error):
    return render_template('404.html'), 404

<span class="color-comment"># Blueprints -------------------------------------------
# Import mod_auth and register blueprint</span>
from app.mod_auth.controllers import mod_auth, login_manager
app.register_blueprint(mod_auth, url_prefix='/auth')
      <span class="color-comment"># URL is /auth/login</span>

<span class="color-comment"># Initialize Flask-Login for this module</span>
login_manager.init_app(app)</pre>


<p><code>app_main/templates/base.html</code></p>

<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;title&gt;My Application&lt;/title&gt;
  &lt;meta charset="utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="color-comment">{# The body-section contents here #}</span>
{% block body_section %}{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre>

<p><code>app_main/templates/base_flash.html</code></p>

<pre class="color-example">
{% extends &quot;base.html&quot; %}
{% block body_section %}
{<span class="color-comment"># Display flash messages, if any, for all pages #}</span>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    &lt;ul class='flashes'&gt;
    {% for message in messages %}&lt;li&gt;{{ message }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
  {% endif %}
{% endwith %}
 
{<span class="color-comment"># The body contents here #}</span>
{% block body %}{% endblock %}
{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre>


<p><code>app_main/templates/404.html</code></p>

<pre class="color-example">
{% extends "base.html" %}
{% block body_section %}
&lt;h1&gt;Sorry, I can't find the item&lt;/h1&gt;
{% endblock %}</pre>

<p><code>app_main/templates/mod_auth/login.html</code></p>

<pre class="color-example">
{% extends "base_flash.html" %}<span class="color-comment">{# in app_main's templates folder #}</span>
{% block body %}
&lt;h1&gt;Login&lt;/h1&gt;
&lt;form method="POST"&gt;
  {{ form.hidden_tag() }} <span class="color-comment">{# Renders any hidden fields, including the CSRF #}</span>
  {% for field in form if field.widget.input_type != 'hidden' %}
    &lt;div class="field"&gt;
      {{ field.label }} {{ field }}
    &lt;/div&gt;
    {% if field.errors %}
      {% for error in field.errors %}
        &lt;div class="field_error"&gt;{{ error }}&lt;/div&gt;
      {% endfor %}
    {% endif %}
  {% endfor %}
  &lt;input type="submit" value="Go"&gt;
&lt;/form&gt;
{% endblock %}</pre>

<ol>
<li>Flask finds the base template from app_main's templates folder and then in blueprint's templates folder.</li>
</ol>

<p><code>app_main/templates/mod_auth/start_app.html</code></p>

<pre class="color-example">
{% extends "base_flash.html" %}<span class="color-comment">{# in app_main's templates folder #}</span>
{% block body %}

{% if current_user.is_authenticated %}
  &lt;h1&gt;Hello, {{ current_user.username }}!&lt;/h1&gt;
{% endif %}

&lt;a href="{{ url_for('.logout') }}"&gt;LOGOUT&lt;/a&gt;
{% endblock %}</pre>

<h3>Deploying Your Flask Webapp</h3>

<h4>On Apache Web Server with <code>mod_wsgi</code></h4>

<p>Reference: Deployment with mod_wsgi (Apache) @ <a href="http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/">http://flask.pocoo.org/docs/0.10/deploying/mod_wsgi/</a>.</p>

<h5>Step 1: Install and Enable Apache Module <code>mod_wsgi</code></h5>

<p>Firstly, check if Apache module <code>mod_wsgi</code> is installed. Goto <code>/etc/apache2/mods-available</code> and look for <code>wsgi.conf</code> to check if it is installed. If <code>mod_wsgi</code> is not installed:</p>

<pre class="color-command">
$ <strong>sudo apt-get install libapache2-mod-wsgi</strong>
......
Setting up libapache2-mod-wsgi (3.4-4ubuntu2.1.14.04.2) ...
apache2_invoke: Enable module wsgi
......

<span class="color-comment"># Verify installation</span>
$ <strong>ll /etc/apache2/mods-available/wsgi*</strong>
-rw-r--r-- 1 root root 5055 Nov 19  2014 /etc/apache2/mods-available/wsgi.conf
-rw-r--r-- 1 root root   60 Nov 19  2014 /etc/apache2/mods-available/wsgi.load
$ <strong>ll /etc/apache2/mods-enabled/wsgi*</strong>
lrwxrwxrwx 1 root root 27 Nov 17 16:55 /etc/apache2/mods-enabled/wsgi.conf -> ../mods-available/wsgi.conf
lrwxrwxrwx 1 root root 27 Nov 17 16:55 /etc/apache2/mods-enabled/wsgi.load -> ../mods-available/wsgi.load
$ <strong>dpkg --list libapache2-mod-wsgi</strong>
||/ Name           Version      Architecture Description
+++-==============-============-============-=================================
ii  libapache2-mod 3.4-4ubuntu2 amd64        Python WSGI adapter module for Ap</pre>

<p>If <code>mod_wsgi</code> is installed but not enabled (<code>wsgi.conf</code> is present in <code>/etc/apache2/mods-available/</code> but not in <code>/etc/apache2/mods-enabled/</code>), you can enable the module via <code>a2enmod</code> utility:</p>
<pre class="color-command">
$ <strong>sudo a2enmod wsgi</strong>
$ <strong>sudo service apache2 reload</strong></pre>

<h5>Step 2: Write your Python-Flask Webapp</h5>
<p>As an example, let me write a hello-world Python-Flask webapp. Suppose that our document base directory is <code>/var/www/myflaskapp</code>.</p>

<p>As an illustration,</p>
<ol>
<li>We shall create a package called <code>mypack</code>, by creating a sub-directory <code>mypack</code> under the project directory.</li>

<li>Write the package init module <code>__init__.py</code> (at <code>/var/www/myflaskapp/mypack</code>) as follows:
<pre class="color-example">
<span class="color-comment"># -*- coding: UTF-8 -*-</span>
from flask import Flask, render_template
app = Flask(__name__)
app.debug = True   <span class="color-comment"># Not for production</span>

@app.route('/')
def hello():
    return render_template('index.html', username='Peter')</pre>
</li>

<li>Write the template <code>index.html</code> (at <code>/var/www/myflaskapp/mypack/templates</code>) as follows:
<pre class="color-example">
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Main Page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, {{ username }}&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
Notes: The sub-directory <code>template</code> are to be placed inside the package <code>mypack</code>.</li>
</ol>


<h5>Step 3: No <code>app.run()</code></h5>
<p>Take note that the <code>app.run()</code> must be removed from <code>if __name__ == '__main__':</code> block, so as not to launch the Flask built-in developmental web server.</p>

<h5>Step 4: Creating a <code>.wsgi</code> file</h5>
<p>Create a <code>.wsgi</code> file called <code>start.wsgi</code>, as follows. This file contains the codes <code>mod_wsgi</code> is executing on startup to get the Flask application instance.</p>

<pre class="color-example">
import sys, os

<span class="color-comment"># To include the application's path in the Python search path</span>
sys.path.insert(1, os.path.dirname(__file__))
# print(sys.path)

<span class="color-comment"># Construct a Flask instance &quot;app&quot; via package mypack's __init__.py</span>
from mypack import app as application</pre>

<h5>Step 5: Configuring Apache</h5>
<p>Create an Apache configuration file for our webapp <code>/etc/apache2/sites-available/myflaskapp.conf</code>, as follows:</p>

<pre class="color-example">
<span class="color-comment"># This directive must be place outside VirtualHost</span>
WSGISocketPrefix /var/run/wsgi

&lt;VirtualHost *:8000&gt;
    WSGIDaemonProcess myflaskapp user=flaskuser group=www-data threads=5
    WSGIScriptAlias / /var/www/myflaskapp/start.wsgi

    &lt;Directory /var/www/myflaskapp&gt;
        WSGIProcessGroup myflaskapp
        WSGIApplicationGroup %{GLOBAL}
        <span class="color-comment"># For Apache 2.4</span>
        Require all granted
        <span class="color-comment"># For Apache 2.2</span>
        # Order deny,allow
        # Allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>

<p>Notes:</p>
<ol>
<li>An alias is defined such that the root URL <code>/</code> is mapped to <code>start.wsgi</code> to start the Python-Flask app.</li>
<li>The <code>WSGISocketPrefix</code> directive is added to resolve this error:
<pre>
(13)Permission denied: [client 127.0.0.1:39863] mod_wsgi (pid=29035): Unable to 
connect to WSGI daemon process 'myflaskapp' on '/var/run/apache2/wsgi.18612.1.1.sock' 
after multiple attempts.</pre>
The WSGI process (flaskuser:www-data) does not have write permission on <code>/var/run/apache2/</code> for writing sockets. We change it to <code>/var/run</code>.<br />
This directive must be placed outside <code>&lt;VirtualHost&gt;</code>.</li>

<li>[TODO]</li>
</ol>

<p>Next, edit <code>/etc/apache2/ports.conf</code> to add &quot;<code>Listen 8000</code>&quot;.</p>

<p>In the above configuration, we run the application under a special non-login system user (called <code>flaskuser</code>) for security reasons.  You can create this non-login user as follows:</p>
<pre class="color-command">
$ <strong>sudo adduser --system --group --disabled-login flaskuser</strong>
Adding system user `flaskuser' (UID 119) ...
Adding new group `flaskuser' (GID 127) ...
Adding new user `flaskuser' (UID 119) with group `flaskuser' ...
Creating home directory `/home/flaskuser' ...</pre>

<p>[TO CHECK] Home directory is needed for this user to run wsgi application?! A login user needs a home directory to set as current working directory.</p>

<p>This user <code>flaskuser</code> and Apache's user <code>www-data</code> shall have permissions to all the resources. We make <code>flaskuser</code> as the user-owner and <code>www-data</code> as the group-owner with at least <code>'r'</code> permission for files and <code>'r-x'</code> for directories. <code>'w'</code> is needed for <code>flaskuser</code> too [TO CHECK].</p>

<pre class="color-command">
$ <strong>cd /var/www/myflaskapp</strong>
$ <strong>sudo chown -R flaskuser:www-data .</strong>
$ <strong>sudo chmod -R 750 .</strong></pre>

<p>Enable our web site and reload the Apache:</p>
<pre class="color-command">
$ <strong>sudo a2ensite myflaskapp</strong>
$ <strong>sudo service apache2 reload</strong></pre>

<h5>Step 6: Run</h5>

<p>You can now access the webapp via <code>http://localhost:8000</code>.</p>

<p>Check the <code>/var/log/Apache2/error.log</code>, in case of error such as <code>50x</code>.</p>

<h5>Debugging - IMPORTANT</h5>

<p>Read &quot;Debugging Python-Flask Webapp Remotely&quot; under <a href="#EclipsePyDev">Eclipse PyDev Section</a>.</p>


<h4>On Cloud</h4>

<p>[TODO]</p>


<!-- @@ start change in v1 -->
<p class="references">REFERENCES &amp; RESOURCES</p>


<ol>
<li>[TODO]</li>
</ol>

</div> <!-- End the content-main division -->

<div id="content-footer">
<p>Latest version tested: Python (Ubuntu) 2.7.6, Flask 0.10.1<br />
Last modified: December, 2015</p>
</div>

</div>  <!-- End the wrap-inner division -->

<!-- footer filled by JavaScript -->
<div id="footer" class="header-footer"><p>&nbsp;</p></div>

</div>  <!-- End the wrap-outer division -->
<!-- @@ end change in v1 -->
</body>
</html>
