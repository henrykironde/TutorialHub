<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>A Java Servlet E-Shop Case Study</title>
<link href="../css/programming_notes_v1.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../scripts/programming_notes_v1.js"></script>
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" /></head>

<body>

<div id="wrap-outer">

<!-- header filled by JavaScript -->
<div id="header" class="header-footer"><p>&nbsp;</p></div>

<div id="wrap-inner">

<div id="wrap-toc">
<h5>TABLE OF CONTENTS <a id="show-toc" href="#show-toc">(HIDE)</a></h5>
<div id="toc"></div>  <!-- for showing the "Table of Content" -->
</div>

<div id="content-header">
<h1>Java Server-side Programming</h1>
<h2>A Java Servlet E-Shop Case Study</h2>
</div>

<div id="content-main">

<h3>Introduction</h3>
<p>In this case study, we shall develop an &quot;e-shop&quot; based on the Java Servlet Technology. This e-shop is a typical Internet <em>business-to-consumer</em> (B2C) <em>3-tier client/server database application</em>, as illustrated below.</p>

<img class="image-center image-border" src="../howto/images/HTTP_ClientServerSystem.png" alt="HTTP_ClientServerSystem.png" />

<p>A typical <em>3-tier client/server web database application </em>consists of 5 components:</p>

<ol>

<li>A <strong>HTTP Server</strong> (or commonly known as <strong>Web Server</strong>), such as Apache HTTP Server, Apache Tomcat Server, Microsoft Internet Information Server (IIS), nginx, or Google Web Server (GWS).</li>

<li>A <strong>HTTP Client</strong>, typically a <strong>Web Browser</strong>, such as FireFox, Chrome, IE or Safari.</li>

<li>A <strong>Relational Database</strong>, such as MySQL, Oracle, IBM DB2, MS SQL Server, MS Access, SAP SyBase.</li>

<li><strong>Client-side programs</strong>, running inside the browser, which send requests to the server and process server's response. Client-side programs can be written in many technologies, e.g., HTML form, JavaScript, VBScript, Java Applet, Flash, ActiveX Control, and others.</li>

<li><strong>Server-side programs</strong>, running inside the HTTP server, which process clients' request. The server-side programs extract the query parameters submitted by the client-side programs and query the database. Server-side programs can also be written in many ways, e.g., CGI Peal, Java Servlet/JSP/JSF, ASP, PHP, and many others.</li>
</ol>

<p>The client and server interact with each other by <em>exchanging messages </em>using a protocol called HTTP (HyperText Transfer Protocol). HTTP is an <em>asymmetric request-response protocol</em>. A client sends a <em>request message </em>to the server. The server processes the request and returns a <em>response message</em>. In other words, in HTTP, the client <em>pulls</em> information from the server, instead of server <em>pushes</em> information to the client. An HTTP server typically runs over TCP/IP, with a server IP address and on a TCP port number.</p>

<p>A typical sequence of operations for a webapp is as follows:</p>

<ol>
<li>A client requests and downloads an HTML page containing an HTML form (or other client-side programs).</li>

<li>The client enters information into the form (such as search criteria), and submits these query parameters back to a server-side program for processing.</li>

<li>The server-side program extracts the query parameters, performs the database query, and returns the query results back to the requesting client.</li>

<li>The client displays the query results, and repeats the above steps for further request-response exchange.</li>
</ol>

<p>Since this course is about Java, we shall build our webapp in Java. We shall write our server-side programs in <em>Java servlets</em>. We shall write our client-side programs in <em>HTML forms</em> and Java Applet.</p>

<h3 id="ServletCS_SetupDB">Setting up  Database</h3>

<p>The first step in building our e-shop is to setup a database. We shall call our database &quot;<code>ebookshop</code>&quot; which contains  one table &quot;<code>books</code>&quot;. The table &quot;<code>books</code>&quot; has 5 columns: <code>id</code>, <code>title</code>, <code>author</code>, <code>price</code> and <code>qty</code>. The <code>id</code> column is the <em>primary key</em> of the table.</p>

<pre class="color-example">
Database: <strong>ebookshop</strong>
Table: <strong>books</strong>
+-------+----------------------------+---------------+---------+-------+
| <strong>id  </strong>  | <strong>title</strong>                      | <strong>author</strong>        | <strong>price</strong>   | <strong>qty  </strong> |
| (INT) | (VARCHAR(50))              | (VARCHAR(50)) | (FLOAT) | (INT) |
+-------+----------------------------+---------------+---------+-------+
| 1001  | Java for dummies           | Tan Ah Teck   | 11.11   | 11    |
| 1002  | More Java for dummies      | Tan Ah Teck   | 22.22   | 22    |
| 1003  | More Java for more dummies | Mohammad Ali  | 33.33   | 33    |
| 1004  | A Cup of Java              | Kumar         | 44.44   | 44    |
| 1005  | A Teaspoon of Java         | Kevin Jones   | 55.55   | 55    |
+-------+----------------------------+---------------+---------+-------+</pre>

<h4>MySQL</h4>

<p>If you are new to MySQL, read &quot;<a href="../sql/MySQL_HowTo.html">How to Set Up MySQL and Get Started</a>&quot;.</p>

<p>Start the MySQL server. Take note of the server's TCP port number. I shall assume that MySQL server is running on port 3306. The default TCP port number for MySQL server is 3306.</p>
<pre class="color-command">
<span class="color-comment">// For Windows</span>
<strong>cd {<em>path-to-mysql-bin</em>}</strong>   <span class="color-comment">// Check your MySQL bin path</span>
<strong>mysqld --console</strong>
 
<span class="color-comment">// For Mac
// Use graphical control at &quot;System Preferences&quot; -> MySQL</span>
</pre>


<p>Start a MySQL client. I shall also assume that there is an authorized user called &quot;<code>myuser</code>&quot; with password &quot;<code>xxxx</code>&quot;.</p>
<pre class="color-command">
<span class="color-comment">// For Windows</span>
<strong>cd {<em>path-to-mysql-bin</em>}</strong>   <span class="color-comment">// Check your MySQL bin path</span>
<strong>mysql -u <em>myuser</em> -p</strong>
 
<span class="color-comment">// For Mac</span>
<span class="color-syntax"><strong>cd /usr/local/mysql/bin</strong>
<strong>./mysql -u <em>myuser</em> -p</strong></span></pre>

<p> You can run the following SQL script to set up the database:</p>

<pre class="color-example">
create database if not exists <strong>ebookshop</strong>;
 
use ebookshop;
 
drop table if exists books;
create table <strong>books</strong> (
  <strong>id</strong>     int,
 <strong> title</strong>  varchar(50),
 <strong> author</strong> varchar(50),
 <strong> price</strong>  float,
 <strong> qty</strong>    int,
  primary key (id));
 
insert into books values (1001, 'Java for dummies', 'Tan Ah Teck', 11.11, 11);
insert into books values (1002, 'More Java for dummies', 'Tan Ah Teck', 22.22, 22);
insert into books values (1003, 'More Java for more dummies', 'Mohammad Ali', 33.33, 33);
insert into books values (1004, 'A Cup of Java', 'Kumar', 44.44, 44);
insert into books values (1005, 'A Teaspoon of Java', 'Kevin Jones', 55.55, 55);
 
select * from books;</pre>

<h3>Apache Tomcat HTTP Server</h3>

<p>Next, we have to setup an HTTP server to host our webapp. In this case study, we shall use Apache Tomcat Server as our HTTP server. Read &quot;<a href="../howto/Tomcat_HowTo.html">How to install Apache Tomcat server</a>&quot;. I shall assume that our Tomcat is running under TCP port number 9999.</p>

<h3>Setting up the E-Shop Webapp</h3>

<h5>Step 1: Create the Directory Structure for a new Webapp &quot;<span class="font-code">ebookshop</span>&quot;</h5>

<img class="image-float-right" src="images/ServletCS_Directory.png" alt="ServletCS_Directory.png" />

<p>First of all, choose a name for your webapp. In this case study, we shall call it &quot;ebookshop&quot;. Navigate to Tomcat's &quot;<code>webapps</code>&quot; directory, and create the following directory structure:</p>

<ol>
<li>Under Tomcat's &quot;<code>webapps</code>&quot; directory, create you web application <em>root</em> directory &quot;<code>ebookshop</code>&quot;.</li>
<li>Under &quot;<code>ebookshop</code>&quot;, create a sub-directory &quot;<code>WEB-INF</code>&quot; (case sensitive, uppercase, a dash not underscore).</li>
<li>Under &quot;<code>WEB-INF</code>&quot;, create a sub-directory &quot;<code>classes</code>&quot; (case sensitive, lowercase, plural).</li>
</ol>

<p>You need to keep your web resources in the proper directories:</p>

<ol>
<li>&quot;<code>ebookshop</code>&quot;: The is called the <em>context root</em> (or <em>document base directory</em>) of your webapp. You should keep all your HTML files and resources visible to the web users (e.g., CSS, images, scripts) here.</li>

<li>&quot;<code>ebookshop\WEB-INF</code>&quot;: This directory, although under the context root, is not visible to the web users. This is where you keep your application's configuration files &quot;<code>web.xml</code>&quot;.</li>

<li>&quot;<code>ebookshop\WEB-INF\classes</code>&quot;: This is where you keep all the Java source files and classes.</li>
</ol>

<h5>Step 2: Start the Tomcat Server</h5>

<p>To start the Tomcat server:</p>
<ul>
<li>For Windows: start a CMD shell and run the batch file &quot;<code>startup.bat</code>&quot; under Tomcat's &quot;<code>bin</code>&quot; directory. Tomcat will be started in a new console window. </li>
<li>For Mac OS X and Linux: start a Terminal and run &quot;<code>./catalina.sh run</code>&quot;under Tomcat's &quot;<code>bin</code>&quot; directory.</li>
</ul>

<p>Monitor the Tomcat console, as the information and error messages, and <code>System.out.println()</code> issued by your programs will be sent to this console. Observe the Tomcat's TCP port number.</p>

<pre class="color-example">
.....
INFO: Initializing ProtocolHandler [&quot;<strong>http-bio-9999</strong>&quot;]
......
INFO: Deploying web application directory <strong>ebookshop</strong>
......
INFO: Starting ProtocolHandler [&quot;<strong>http-bio-9999</strong>&quot;]
......
INFO: <strong>Server startup</strong> in 699 ms</pre>

<h5>Step 3: Access the Tomcat Server</h5>

<p>The Tomcat Server has been started on TCP port 9999. The default TCP port number for HTTP protocol is 80. To access an HTTP server not running on the default TCP port 80, the port number must be explicitly specified in the URL.</p>

<p>To access your Tomcat Server, start a web browser (e.g., FireFox, IE, Chrome or Safari) and issue the following URL:</p>

<pre class="color-command">
http://localhost:9999</pre>

<p>The &quot;localhost&quot; is a special <em>hostname</em> (with IP address of 127.0.0.1) meant for <em>local loop-back</em> testing.</p>

<p>You could also use the IP address to access your HTTP server. You can find out your IP address by running program such as &quot;<code>ipconfig</code>&quot;, &quot;<code>winipcfg</code>&quot;, &quot;<code>ping</code>&quot;, and etc.</p>

<p>You shall see the <em>welcome page </em>of Tomcat Server.</p>

<img class="image-left image-border" src="../howto/images/TomcatHomePage.png" alt="TomcatHomePage.png" />

<h5>Step 5: Shutting down the Tomcat Server.</h5>

<p>To orderly shutdown the Tomcat web server, press <em>control-c</em> from the Tomcat's console; or run the script &quot;<code>shutdown.bat</code>&quot; (Windows) or &quot;<code>./shutdown.sh</code>&quot; (Mac OS/Linux) under Tomcat's &quot;<code>bin</code>&quot; directory.</p>

<h3>Writing a Client-Side HTML Form</h3>

<p>Let's write an HTML script to create a query <em>form</em> using checkboxes. Save the HTML file as &quot;<code>querybook.html</code>&quot; in your application root directory &quot;<code>ebookshop</code>&quot;.</p>

<pre class="color-example">
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Yet Another e-Bookshop&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h2&gt;Yet Another e-Bookshop&lt;/h2&gt;
  &lt;form method=&quot;get&quot; <strong>action=&quot;http://localhost:9999/ebookshop/query&quot;</strong>&gt;
    Choose an author:&lt;br /&gt;&lt;br /&gt;
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Tan Ah Teck&quot;</strong> /&gt;Ah Teck
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Mohammad Ali&quot;</strong> /&gt;Ali
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Kumar&quot;</strong> /&gt;Kumar
    &lt;input type=&quot;submit&quot; value=&quot;Search&quot; /&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
 
<p>Browse the HTML page by issuing the URL:</p>

<pre class="color-command">
http://localhost:9999/ebookshop/<strong>querybook.html</strong></pre>

<img class="image-center image-border" src="images/ServletCS_Form.png" alt="ServletCS_Form.png" />

<p>Check a box (e.g., Ah Teck) and click the &quot;Search&quot; button. A request will be issued to the URL specified in the <code>&lt;form&gt;</code>'s <code>action</code> attribute. You are expected to receive an Error &quot;404 Page Not Found&quot; at this stage as you have yet to write the server-side program (i.e., &quot;<code>query</code>&quot;). </p>
<p>But observe the URL generated:</p>

<p><img class="image-center image-border" src="images/ServletCS_URL.png" alt="ServletCS_URL.png" /></p>

<p>The query parameter, in the form of <code>name=value</code> pair, are extracted from the <code>&lt;input&gt;</code> tag (e.g., <code>author=Tan+Ah+Tack</code>). It is appended behind the URL, separated by a <code>'?'</code>.</p>

<p> Check two boxes (e.g., &quot;Ah Teck&quot; and &quot;Ali&quot;) and submit the request, the URL is:</p>

<pre class="color-command">
http://localhost:9999/ebookshop/query?<strong>author=Tan+Ah+Teck&amp;author=Mohammad+Ali</strong></pre>

<p>Two <code>name=value</code> pairs are sent to the server, separated by an <code>'&amp;'</code>.</p>

<p>Also take note that blank is replaced by <code>'+'</code>. This is because special characters are not permitted in the URL. They are encoded as <code>%<em>xx</em></code> where <em><code>xx</code></em> is the hex code in ASCII. For example, <code>'~'</code> is encoded as <code>%7e</code>; blank is encoded as <code>%20</code> or <code>'+'</code>.</p>

<h3>Writing Database Query Servlet</h3>

<p>The next step is to write the server-side program, which responses to the client's request by querying the database and returns the query results. We shall use Java servlet technology in our servlet-side programming.</p>

<h4>Java Database Programming</h4>
<p>The steps involved in Java database programs are:</p>
<ol>
<li>Allocate a <code>Connection</code> object.</li>

<li>Allocate a <code>Statement</code> object, under the <code>Connection</code> object created.</li>

<li>Query database:

<ol>
<li>Execute a SQL <code>SELECT</code> query by calling the <code>executeQuery()</code> method of the <code>Statement</code> object, which returns the query results in a <code>ResultSet</code> object; or</li>
<li>Execute a SQL <code>INSERT|UPDATE|DELETE</code> command by calling the <code>executeUpdate()</code> method of the <code>Statement</code> object, which returns an <code>int</code> indicating the number of rows affected.</li></ol></li>

<li>Process the query result.</li>
<li>Free the resources by closing the <code>Statement</code> and <code>Connection</code>.</li>
</ol>

<h4>Database Servlet</h4>

<p>Let write a servlet that queries the database based on the client's request.</p>

<h5>Step 1: Write the Servlet &quot;<span class="font-code">QueryServlet.java</span>&quot;</h5>

<p>Enter the following codes and save as &quot;<code>QueryServlet.java</code>&quot; under your web application &quot;<code>classes</code>&quot; directory, i.e., &quot;<span class="highlight"><strong><code>ebookshop\WEB-INF\classes\</code></strong></span>&quot;. <strong>You must keep all your servlets in &quot;<code>ebookshop\WEB-INF\classes</code></strong>&quot;, because that is where Tomcat picks up the servlets.</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre>
</td>
<td>
<pre>
<span class="color-comment">// Saved as &quot;<span class="color-new">ebookshop\WEB-INF\<span class="highlight">classes</span>\QueryServlet.java</span>&quot;.</span>
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
 
public class <strong>QueryServlet</strong> extends HttpServlet {  <span class="color-comment">// JDK 6 and above only</span>
 
   <span class="color-comment">// The doGet() runs once per HTTP GET request to this servlet.</span>
   @Override
   public void doGet(HttpServletRequest request, HttpServletResponse response)
                     throws ServletException, IOException {
      <span class="color-comment">// Set the MIME type for the response message</span>
      response.setContentType(&quot;text/html&quot;);
 <span class="color-comment">     // Get a output writer to write the response message into the network socket</span>
      PrintWriter out = response.getWriter();
 
      Connection conn = null;
      Statement stmt = null;
      try {
         <span class="color-comment">// <strong>Step 1</strong>: Create a database &quot;Connection&quot; object</span>
         <span class="color-comment">// For MySQL</span>
         <strong>conn = DriverManager.getConnection(
            <span class="highlight"><span class="color-new">&quot;jdbc:mysql://localhost:3306/ebookshop&quot;, &quot;myuser&quot;, &quot;xxxx&quot;</span></span>);</strong> <span class="color-comment"> // &lt;&lt;== Check</span>
         <span class="color-comment">// For MS Access</span>
         <span class="color-comment">// conn = DriverManager.getConnection(&quot;jdbc:odbc:ebookshopODBC&quot;);</span>
 
         <span class="color-comment">// <strong>Step 2</strong>: Create a &quot;Statement&quot; object inside the &quot;Connection&quot;</span>
         <strong>stmt = conn.createStatement();</strong>
 
         <span class="color-comment">// <strong>Step 3</strong>: Execute a SQL SELECT query</span>
         String sqlStr = &quot;SELECT * FROM books WHERE author = &quot;
               + <span class="highlight">&quot;'&quot; + <strong>request.getParameter(&quot;author&quot;)</strong> + &quot;'&quot;</span>
               + &quot; AND qty &gt; 0 ORDER BY author ASC, title ASC&quot;;
 
         <span class="color-comment">// Print an HTML page as output of query</span>
         out.println(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Query Results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;);
         out.println(&quot;&lt;h2&gt;Thank you for your query.&lt;/h2&gt;&quot;);
         out.println(&quot;&lt;p&gt;You query is: &quot; + sqlStr + &quot;&lt;/p&gt;&quot;); <span class="color-comment">// Echo for debugging</span>
         <strong>ResultSet rset = stmt.executeQuery(sqlStr);</strong> <span class="color-comment">// Send the query to the server</span>
 
         <span class="color-comment">// Step 4: Process the query result</span>
         int count = 0;
         while(<strong>rset.next()</strong>) {
            <span class="color-comment">// Print a paragraph &lt;p&gt;...&lt;/p&gt; for each row</span>
            out.println(&quot;&lt;p&gt;&quot; + <strong>rset.getString(&quot;author&quot;)</strong>
                  + &quot;, &quot; + <strong>rset.getString(&quot;title&quot;)</strong>
                  + &quot;, $&quot; + <strong>rset.getDouble(&quot;price&quot;)</strong> + &quot;&lt;/p&gt;&quot;);
            ++count;
         }
         out.println(&quot;&lt;p&gt;==== &quot; + count + &quot; records found ====&lt;/p&gt;&quot;);
         out.println(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);
      } catch (SQLException ex) {
         ex.printStackTrace();
      } finally {
         out.close();
         try {
            <span class="color-comment">// Step 5: Close the Statement and Connection</span>
            if (stmt != null) <strong>stmt.close()</strong>;
            if (conn != null) <strong>conn.close()</strong>;
         } catch (SQLException ex) {
            ex.printStackTrace();
         }
      }
   }
}</pre>
</td>
</tr>
</tbody>
</table>

<p>Recall that the HTML form that we created earlier submits query parameters in the form of <code><em>name=value</em></code> pairs, (e.g., <code>author=Tan+Ah+Teck</code>), as part of the request. In the processing servlet, we need to extract the author name (e.g., <code>&quot;Tan Ah Teck&quot;</code>) from the request to form a SQL SELECT query (e.g., <code>SELECT * FROM books WHERE author='Tan Ah Teck'</code>). This is done via the method <code>request.getParameter(<em>name</em>)</code>, which returns the <em><code>value</code></em> of the <code><em>name=value</em></code> pair.</p>

<p>For example, suppose that the URL is:</p>

<pre class="color-command">
http://localhost:9999/ebookshop/query<strong>?author=Tan+Ah+Teck</strong></pre>

<p>The method <code>request.getParameter(&quot;author&quot;)</code> returns a <code>String</code> <code>&quot;Tan Ah Teck&quot;</code>. The resultant &quot;<code>sqlStr</code>&quot; becomes:</p>

<pre class="color-command">
SELECT * FROM books WHERE author='<strong>Tan Ah Teck</strong>' AND qty &gt; 0 ORDER BY author ASC, title ASC</pre>

<p>Note that you do not have to handle encoded characters such as <code>'+'</code>, <code>%20</code>, <code>'?'</code> and <code>'&amp;'</code>. They will be properly decoded by the <code>getParameter()</code> method.</p>
<h5>Step 2: Compile</h5>

<p>Compile the source code &quot;<code>QueryServlet.java</code>&quot; into &quot;<code>QueryServlet.class</code>&quot;.</p>

<pre class="color-command">
<strong>(For Windows)</strong>
<span class="color-comment">// Assume that Tomcat is installed in d:\myProject\tomcat</span>
<strong>d:</strong>
<strong>cd \myProject\tomcat\ebookshop\WEB-INF\classes</strong>
<strong>javac -cp .;d:\myProject\tomcat\lib\servlet-api.jar QueryServlet.java</strong>
 
<strong>(For Mac OS X)</strong>
<span class="color-comment">// Assume that Tomcat is installed in /Applications/tomcat</span>
<strong>cd /Applications/tomcat/webapps/ebookshop/WEB-INF/classes</strong>
<strong>javac -cp .:/Applications/tomcat/lib/servlet-api.jar QueryServlet.java</strong></pre>

<h5>Step 3: Configure the Servlet</h5>

<p>Configure the servlet by creating a configuration file called &quot;<code>web.xml</code>&quot;, and save it under the &quot;<span class="highlight"><code>ebookshop\WEB-INF</code></span>&quot; directory.</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre>
</td>
<td>
<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;web-app version=&quot;3.0&quot;
    xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
    metadata-complete=&quot;true&quot;&gt;
 
  <span class="color-comment">&lt;!-- To save as &quot;ebookshop\WEB-INF\web.xml&quot; --&gt;</span>
 
  &lt;servlet&gt;
    &lt;servlet-name&gt;<strong>EBookShopQuery</strong>&lt;/servlet-name&gt;
    &lt;servlet-class&gt;<span class="highlight"><strong>QueryServlet</strong></span>&lt;/servlet-class&gt;
  &lt;/servlet&gt;
 
  <span class="color-comment">&lt;!-- Note: All &lt;servlet&gt; elements must be placed
       in front of &lt;servlet-mapping&gt; elements --&gt;</span>
 
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;<strong>EBookShopQuery</strong>&lt;/servlet-name&gt;
    &lt;url-pattern&gt;<span class="highlight"><strong>/query</strong></span>&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
 
&lt;/web-app&gt;</pre>
</td>
</tr>
</tbody>
</table>

<p>In the above configuration, we map &quot;<code>QueryServlet.class</code>&quot; to request URL &quot;<code>/query</code>&quot; (thru an arbitrary but unique <code>&lt;servlet-name&gt;</code> called &quot;<code>EBookShopQuery</code>&quot;), under this webapp &quot;<code>ebookshop</code>&quot;. In other words, the full request URL for this servlet is <code>http://<em>hostname</em>:<em>port</em><strong>/ebookshop/query</strong></code>. This is exactly what we have written in our HTML <code>&lt;form&gt;</code>'s <code>action</code> attribute.</p>

<div class="side-note">
<p><span class="line-heading">(For Advanced Users)</span> For Tomcat 7, which supports Servlet 3.0, you can use the <code>@WebServlet</code> annotation in the &quot;<code>QueryServlet.java</code>&quot; to deploy the servlet, instead of writing the &quot;<code>web.xml</code>&quot;, as follows:</p>

<pre>
<strong>@WebServlet(&quot;/query&quot;)</strong>
public class <strong>QueryServlet</strong> extends HttpServlet { ...... }</pre>
</div>

<h5>Step 4: Test the Servlet</h5>

<p>You can now try to invoke the servlet by issuing a request URL with proper query parameter:</p>

<pre class="color-command">
http://localhost:9999<strong>/ebookshop/query?author=Tan+Ah+Teck</strong></pre>

<img class="image-center" src="images/ServletCS_QueryOutput.png" alt="ServletCS_QueryOutput.png" />
 
<p>The request URL &quot;<code>/query</code>&quot; is mapped to the servlet &quot;<code>QueryServlet.class</code>&quot;, as configured in the application &quot;<code>web.xml</code>&quot;, as follows:</p>
 
<img class="image-center image-border" src="images/ServletCS_QueryMapping.png" alt="ServletCS_QueryMapping.png" />
 
<p>Try &quot;View Source&quot; (or &quot;View Page Source&quot;) in your browser to study the output produced by the servlet. It is important to note that the client has no access to the servlet's program codes, but merely the outputs produced by the servlet.</p>

<pre class="output">
&lt;html&gt;&lt;head&gt;&lt;title&gt;Query Results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;
&lt;h3&gt;Thank you for your query.&lt;/h3&gt;
&lt;p&gt;You query is: SELECT * FROM books WHERE author = 'Tan Ah Teck' AND qty &gt; 0 ORDER BY author ASC, title ASC&lt;/p&gt;
&lt;p&gt;Tan Ah Teck, Java for dummies, $11.11&lt;/p&gt;
&lt;p&gt;Tan Ah Teck, More Java for dummies, $22.22&lt;/p&gt;
&lt;p&gt;==== 2 records found ====&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;</pre>

<h5>Step 5: Invoke the Servlet from the HTML Form</h5>

<p>Use the HTML form that you have created earlier (i.e., &quot;<code>querybook.html</code>&quot;) to trigger this servlet. Take note that the request URL is coded in the <code>&lt;form&gt;</code>'s <code>action</code> attribute.</p>

<h3>More Java Servlet</h3>

<h4>Exercise 1: Relative URL vs. Absolute URL</h4>

<p>In the &quot;<code>querybook.html</code>&quot;, the request URL in the <code>&lt;form&gt;</code>'s <code>action</code> attribute (i.e., <code>http://localhost:9999/ebookshop/query</code>) is called an <em>absolute URL</em>. The hostname, port number and path are all hard-coded in an absolute URL. This will cause problem if you decide to relocate your program to another host (e.g., from the testing host into the production host), or another webapp.</p>

<p>Instead of using an absolute URL, we would use a <em>relative URL</em> (in &quot;<code>querybook.html</code>&quot;) as follows:</p>

<pre class="color-command">
&lt;form method=&quot;get&quot; <strong>action=&quot;query&quot;</strong>&gt;</pre>
 
<p>A relative URL is <em>relative</em> to the <em>currently displayed page</em>. Since the current page &quot;<code>querybook.html</code>&quot; is located at <em>directory</em> &quot;<code>http://localhost:9999/ebookshop/</code>&quot;, the <em>relative</em> URL of &quot;<code>query</code>&quot; resolves into an <em>absolute</em> reference of &quot;<code><span class="underline">http://localhost:9999/ebookshop/</span>query</code>&quot;.</p>
<p>Relative URLs should be used (instead of absolute URLs) in your HTML pages whenever possible, so that the HTML pages can be easily relocated from one webapp to another webapp, or to another server, under difference base directory. You should only use absolute URL for referencing resources from other servers.</p>

<p>Try it out! Use relative URL from this point onwards.</p>

<h4>Exercise 2: Multi-Value Query Parameter - &quot;<span class="font-code">QueryMultiValueServlet.java</span>&quot;</h4>

<p>If you check more than one boxes in the &quot;<code>querybook.html</code>&quot;, the resultant URL contains multiple <code>author=<em>value</em></code> parameters separated by an <code>'&amp;'</code>. For example, if you check all three boxes, the resultant URL is:</p>

<pre class="color-command">
http://localhost:9999/ebookshop/<strong>query</strong>?<strong>author=Tan+Ah+Teck</strong>&amp;<strong>author=Mohammad+Ali</strong>&amp;<strong>author=Kumar</strong></pre>


<p>However, If you check more than one authors and submit your request to the <code>QueryServlet</code>, the query result shows only the first author. This is because the method <code>request.getParameter(<em>name</em>)</code> returns only the first <em><code>value</code></em>, if there are more than one values for that particular parameter <em><code>name</code></em>.</p>

<p>We have to use the method <code>request.getParameter<span class="underline">Values</span>(<em>name</em>)</code> (instead of <code>request.getParameter(<em>name</em>)</code>) to handle multi-value parameters. The <code>request.getParameterValues(<em>name</em>)</code> returns an <em>array</em> of <code>String</code> containing all the values of that parameter; whereas <code>request.getParameter(<em>name</em>)</code> returns a single <code>String</code>.</p>

<p>In the SQL SELECT command, we could use the <code>IN</code> predicate in the <code>WHERE</code> clause to select from a set of values. For example,</p>

<pre class="color-command">
SELECT * FROM books WHERE author <strong>IN</strong> ('Tan Ah Teck', 'Mohammad Ali', 'Kumar')</pre>

<p>The above SQL command is the same but  simpler than:</p>
<pre class="color-command">
SELECT * FROM books WHERE author='Tan Ah Teck' <strong>OR</strong> author='Mohammad Ali' <strong>OR</strong> author='Kumar'</pre>
 
<p>Let us write a new servlet &quot;<code>QueryMultiValueServlet.java</code>&quot; (modified from &quot;<code>QueryServlet.java</code>&quot;) to handle query parameter with multiple values. We shall map this new servlet &quot;<code>QueryMultiValueServlet.class</code>&quot; to request URL &quot;<code>/querymv</code>&quot;  in the &quot;<code>web.xml</code>&quot;. We shall also create a new HTML page (called &quot;<code>querybookmv.html</code>&quot;) to trigger URL &quot;<code>/querymv</code>&quot;. For example,  if all the three checkboxes are checked, the URL triggered shall be:</p>

<pre class="color-command">
http://localhost:9999/ebookshop/<strong><span class="highlight">querymv</span></strong>?<strong>author=Tan+Ah+Teck</strong>&amp;<strong>author=Mohammad+Ali</strong>&amp;<strong>author=Kumar</strong></pre>

<h5>Step 1: Write the &quot;<span class="font-code">QueryMultiValueServlet.java</span>&quot;</h5>


<p>Copy &quot;<code>QueryServlet.java</code>&quot; to &quot;<code>QueryMultiValueServlet.java</code>&quot;.</p>
<ol>
<li> Change the classname from <code>QueryServlet</code> to <code>QueryMultiValueServlet</code>.</li>
<li>We can include all the selected authors in the servlet's <code>sqlstr</code> as follows:

<pre class="color-example">
<span class="color-comment">// Step 3: Execute a SQL SELECT query</span>
<strong>String[] authors = request.getParameterValues(&quot;author&quot;);</strong>  <span class="color-comment">// Returns an array</span>
String sqlStr = &quot;SELECT * FROM books WHERE author <strong>IN (</strong>&quot;;
sqlStr += <strong>&quot;'&quot; + authors[0] + &quot;'&quot;</strong>;  <span class="color-comment">// First author</span>
for (int i = 1; i &lt; authors.length; ++i) {
   sqlStr += <strong>&quot;, '&quot; + authors[i] + &quot;'&quot;</strong>;  <span class="color-comment">// Subsequent authors need a leading commas</span>
}
sqlStr += &quot;<strong>)</strong> AND qty &gt; 0 ORDER BY author ASC, title ASC&quot;;</pre>
 
The <code>getParameterValues(<em>name</em>)</code> returns <code>null</code> if the query string does not contain parameter <em><code>name</code></em> (i.e., the user did not check any box). This will trigger an exception in &quot;<code>authors.length</code>&quot; in the above codes. You can use the following expression to check for the existence of a parameter:

<pre class="color-example">
String[] authors = request.getParameterValues(&quot;author&quot;);
if (<strong>authors == null</strong>) {
   out.println(&quot;&lt;h2&gt;Please go back and select an author&lt;/h2&gt;&quot;);
   return; <span class="color-comment">// Exit doGet()</span>
} 
<span class="color-comment">// Okay to perform the database query using the above codes</span>
......
......</pre></li>

<li>Compile the &quot;<code>QueryMultiValueServlet.java</code>&quot; into &quot;<code>QueryMultiValueServlet.class</code>&quot;.</li>
</ol>

<h5>Step 2: Configure the New Servlet in &quot;<span class="font-code">web.xml</span>&quot;</h5>

<p>In your application's &quot;<code>web.xml</code>&quot; (i.e., &quot;<code>ebookshop\WEB-INF\web.xml</code>&quot;), include a configuration to map the request URL &quot;<code>/querymv</code>&quot; to &quot;<code>QueryMultiValueServlet.class</code>&quot;, as follows:</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre>
</td>
<td>
<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;web-app version=&quot;3.0&quot;
    xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
    metadata-complete=&quot;true&quot;&gt;
 
  <span class="color-comment">&lt;!-- To save as &quot;ebookshop\WEB-INF\web.xml&quot; --&gt;</span>
 
  &lt;servlet&gt;
    &lt;servlet-name&gt;EBookShopQuery&lt;/servlet-name&gt;
    &lt;servlet-class&gt;QueryServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
 
  <span class="color-new">&lt;servlet&gt;
    &lt;servlet-name&gt;EBookShopQueryMultiValue&lt;/servlet-name&gt;
    &lt;servlet-class&gt;<span class="highlight">QueryMultiValueServlet</span>&lt;/servlet-class&gt;
  &lt;/servlet&gt;</span>
 
  <span class="color-comment">&lt;!-- Note: All &lt;servlet&gt; elements must be placed
       in front of &lt;servlet-mapping&gt; elements --&gt;</span>
 
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;EBookShopQuery&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/query&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
 
  <span class="color-new">&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;EBookShopQueryMultiValue&lt;/servlet-name&gt;
    &lt;url-pattern&gt;<span class="highlight">/querymv</span>&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;</span>
 
&lt;/web-app&gt;</pre>
</td>
</tr>
</tbody>
</table>

<p><strong>IMPORTANT:</strong> Take note that you have to group all the <code>&lt;servlet&gt;</code> elements in front of the <code>&lt;servlet-mapping&gt;</code> elements. Each servlet requires one pair of <code>&lt;servlet&gt;</code> and <code>&lt;servlet-mapping&gt;</code> elements, with a unique but arbitrary <code>&lt;servlet-name&gt;</code>.</p>

<h5>Step 3: Write the HTML Form - &quot;<span class="font-code">querybookmv.html</span>&quot;</h5>

<p>Write a new HTML form &quot;<code>querybookmv.html</code>&quot; (based on &quot;<code>querybook.html</code>&quot;) to direct the <code>action</code> to &quot;<code>/querymv</code>&quot;, as follows:</p>

<pre class="color-example">
&lt;form method=&quot;get&quot; action=&quot;<strong>querymv</strong>&quot;&gt;
  ......
&lt;/form&gt;</pre>
 
<h5>Step 4: Test Your Application</h5>
<p>Now, you can try out the new form, new servlet and the new configuration.</p>
<p><strong>IMPORTANT:</strong> Most browsers <em>cache</em> pages downloaded to improve performance. You need to <em>refresh</em> your page. Use <strong>Ctrl-F5</strong> (instead of F5) to refresh, which clears the cache. You may use &quot;view source&quot; to check and ensure that you are working on the modified page instead of the cached page.</p>

<h4>Exercise 3: Multiple Query Parameters - &quot;<span class="font-code">QueryMultiParamServlet.java</span>&quot;</h4>

<p>Create a new servlet called &quot;<code>QueryMultiParamServlet.java</code>&quot; (based on &quot;<code>QueryServlet.java</code>&quot;) to handle multiple query parameters. For example, the following URL has two parameters: <code>author</code> and <code>price</code>.</p>

<pre class="color-command">
http://localhost:9999/ebookshop/<strong>querymp?author=kumar&amp;price=50</strong></pre>
 We shall map the request URL &quot;<code>/querymp</code>&quot; to &quot;<code>QueryMultiParamServlet.class</code>&quot; in the &quot;<code>web.xml</code>&quot; later.

 <h5>Step 1: HTML form - &quot;<span class="font-code">querybookmp.html</span>&quot;</h5>

<p>Write a new HTML form (called &quot;<code>querybookmp.html</code>&quot;), which could submit two query parameters: <code>author</code> and <code>price</code>, using checkboxes and radio buttons respectively, as follows:</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre>
</td>
<td>
<pre>
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Yet Another e-Bookshop&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h2&gt;Yet Another e-Bookshop&lt;/h2&gt;
  &lt;form method=&quot;get&quot; action=&quot;<strong>querymp</strong>&quot;&gt;
    Choose an author:
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Tan Ah Teck&quot;</strong> /&gt;Ah Teck
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Mohammad Ali&quot;</strong> /&gt;Ali
    &lt;input type=&quot;checkbox&quot; <strong>name=&quot;author&quot; value=&quot;Kumar&quot;</strong> /&gt;Kumar
    &lt;br /&gt;&lt;br /&gt;
    Choose a price range:
    &lt;input type=&quot;radio&quot; <strong>name=&quot;price&quot; value=&quot;50&quot;</strong> checked /&gt;less than $50
    &lt;input type=&quot;radio&quot; <strong>name=&quot;price&quot; value=&quot;100&quot;</strong> /&gt;less than $100
    &lt;br /&gt;&lt;br /&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Search&quot; /&gt;
    &lt;input type=&quot;reset&quot; value=&quot;Clear&quot; /&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</td>
</tr>
</tbody>
</table>

<p>Note that:</p>
<ol>
<li><em>Checkboxes</em> (can check zero or more boxes) are used for <code>author</code> and <em>radio buttons</em> (can check zero or one box) are used for <code>price</code>.</li>

<li>A &quot;<code>reset</code>&quot; button is added (<code>&lt;input type=&quot;reset&quot;&gt;</code>), which clears the inputs.</li>
</ol>

<h5>Step 2: Write the Processing Servlet - &quot;<span class="font-code">QueryMultiParamServlet.java</span>&quot;</h5>

<p>Write a servlet called &quot;<code>QueryMultiParamServlet.java</code>&quot; (based on &quot;<code>QueryServlet.java</code>&quot;). You can form the SQL statement as follows:</p>

<pre class="color-example">
<span class="color-comment">// Step 3: Execute a SQL SELECT query</span>
String sqlStr = &quot;SELECT * FROM books WHERE author = &quot;
      + <strong>&quot;'&quot; + request.getParameter(&quot;author&quot;) + &quot;'&quot;</strong>
      + &quot; AND price &lt; &quot; + <strong>request.getParameter(&quot;price&quot;)</strong>
      + &quot; AND qty &gt; 0 ORDER BY author ASC, title ASC&quot;;</pre>
 
<p>Note that:</p>
<ol>
<li>In the SQL SELECT statement, <code>author</code> is a string and must be enclosed by a pair of single quotes; <code>price</code> is a number and cannot be quoted.</li>
<li>The <code>name=value</code> pair of <code>price=&quot;50&quot;</code> is interpreted as <code>price&lt;50</code> in the SELECT statement.</li>
</ol>

<p>Compile the &quot;<code>QueryMultiParamServlet.java</code>&quot; into &quot;<code>QueryMultiParamServlet.class</code>&quot;.</p>

<h5>Step 3: Configure the servlet in &quot;<span class="font-code">web.xml</span>&quot;</h5>

<p>In your application's &quot;<code>web.xml</code>&quot; (i.e., &quot;<code>ebookshop\WEB-INF\web.xml</code>&quot;), include a configuration to map the request URL &quot;<code>/querymp</code>&quot; to &quot;<code>QueryMultiParamServlet.class</code>&quot;, as follows:</p>

<p>Group the <code>&lt;servlet&gt;</code> elements together:</p>
<pre class="color-example">
&lt;servlet&gt;
  &lt;servlet-name&gt;EBookShopQueryMultiParam&lt;/servlet-name&gt;
  &lt;servlet-class&gt;<strong>QueryMultiParamServlet</strong>&lt;/servlet-class&gt;
&lt;/servlet&gt;</pre>
 
<p>Group the <code>&lt;servlet-mapping&gt;</code> elements together:</p>
<pre class="color-example">
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;EBookShopQueryMultiParam&lt;/servlet-name&gt;
  &lt;url-pattern&gt;<strong>/querymp</strong>&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre>
 
<h4>Exercise 4: Multiple Multi-Value Parameters (Optional)</h4>

<p>Combining Exercises 2 and 3:</p>
<ol>
<li>Write a servlet called &quot;<code>QueryMultiParamValueServlet.java</code>&quot;, that is capable of processing multiple authors and a single price.</li>
<li>In the &quot;<code>web.xml</code>&quot;, configure this servlet to map to the URL &quot;<code>/querymvp</code>&quot;.</li>
<li>Write an HTML form called &quot;<code>querybookmvp.html</code>&quot; to trigger this servlet.</li>
</ol>

<h4>Exercise 5: HTTP POST Request</h4>

<p>HTTP defines two request methods: GET and POST. We have been using GET requests thus far (as specified in our <code>&lt;form&gt;</code>'s attribute <code>method=&quot;get&quot;</code>). GET request is processed by the method <code>doGet()</code> in our servlet. POST request, on the other hand, is processed by a <code>doPost()</code> method in the servlet.</p>

<p>Let's try out the HTTP POST request method:</p>

<ol>

<li>Create an HTML form called &quot;<code>querybookpost.html</code>&quot; (based on &quot;<code>querybook.html</code>&quot;)
<ol>
<li>Change the <code>&lt;form&gt;</code>'s attribute <code>method=&quot;get&quot;</code> to <strong><code>method=&quot;post&quot;</code></strong>.</li>
<li>Change the <code>&lt;form&gt;</code>'s <code>action</code> attribute to <strong><code>action=&quot;querypost&quot;</code></strong>.</li>
</ol></li>

<li>Create a new servlet called &quot;<code>QueryPostServlet.java</code>&quot; (based on &quot;<code>QueryServlet.java</code>&quot;). Rename the method <code>doGet()</code> to <code>doPost()</code>. Compile the source.</li>

<li>In &quot;<code>web.xml</code>&quot;, configure URL &quot;<code>/querypost</code>&quot; to map to &quot;<code>QueryPostServlet.class</code>&quot;</li>

<li>Try out the new form and new servlet.</li>
</ol>

<p>What is the difference between GET and POST? For POST request, the query string is not shown in the URL (i.e., no &quot;<code>?author=Tan+Ah+Teck&amp;...</code>&quot;). Instead, the query string is sent in the <em>body</em> of the HTTP request message. The advantages are: (a) the client will not see the strange-looking query string in the URL; (b) The GET request's query string length is limited, because it is part of the URL. POST request can send unlimited amount of data in the body of the request message.</p>

<p>In practice, it is common to use the <em>same</em> method to handle both the GET and POST requests. In this case, you could simply re-direct <code>doPost()</code> to <code>doGet()</code>. In your &quot;<code>QueryPostServlet.java</code>&quot;, (a) rename <code>doPost()</code> back to <code>doGet()</code>, and (b) write a <code>doPost()</code> as follow:</p>

<pre class="color-example">
@Override
public void <strong>doPost</strong> (HttpServletRequest request, HttpServletResponse response)
                   throws ServletException, IOException {
   <strong>doGet(request, response);</strong>  <span class="color-comment">// Re-direct POST request to doGet()</span>
}</pre>
 
<p>Try it out.</p>

<h3>Programming the Client-Side (Front-End)</h3>

<p>In the previous sections, we used a simple HTML <em>form</em> of <em>checkboxes</em>. HTML also provides other input component, such as text field, radio button and pull-down menu.</p>

<h5>HTML Form with &quot;Pull-down Menu&quot;</h5>

<p>Create the following HTML form with a &quot;pull-down menu&quot; and save as &quot;<code>querybookmenu.html</code>&quot;. Pull-down menu uses <code>&lt;select&gt;</code> and <code>&lt;option&gt;</code> tags. The <code>name</code> is specified in <code>&lt;select&gt;</code>; while the <code>value</code> is specified in <code>&lt;option&gt;</code>.</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre>
</td>
<td>
<pre>
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Yet Another e-Bookshop&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h2&gt;Yet Another e-Bookshop&lt;/h2&gt;
  &lt;form method=&quot;get&quot; action=&quot;query&quot;&gt;
    Choose an author:
    &lt;select <strong>name=&quot;author&quot;</strong> size=&quot;1&quot;&gt;
      &lt;option <strong>value=&quot;Tan Ah Teck&quot;</strong>&gt;Ah Teck&lt;/option&gt;
      &lt;option <strong>value=&quot;Mohammad Ali&quot;</strong>&gt;Ali&lt;/option&gt;
      &lt;option <strong>value=&quot;Kumar&quot;</strong>&gt;Kumar&lt;/option&gt;
    &lt;/select&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Search&quot; /&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</td>
</tr>
</tbody>
</table>

<h5>HTML form with Text Field</h5>

<p>Write an HTML form with text field (called &quot;<code>querybooktextfield.html</code>&quot;). The syntax for text field is as follow. The &quot;<code>name</code>&quot; is specified in the <code>&lt;input&gt;</code> tag; while the &quot;<code>value</code>&quot; corresponds to the user's input.</p>

<pre class="color-example">
&lt;form ......&gt;
  Enter an author: <strong>&lt;input type=&quot;text&quot; name=&quot;author&quot; /&gt;</strong>
  ......
&lt;/form&gt;</pre>

<h5>HTML form with Text Area</h5>
<p>Text field allows you to enter a single line of text; while text area allows you to enter multiple lines. Text area uses <code>&lt;textarea&gt;...&lt;/textarea&gt;</code> tag as follow. Write an HTML form with text area (called &quot;<code>querybooktextarea.html</code>&quot;).</p>

<pre class="color-example">
&lt;form ......&gt;
  <strong>&lt;textarea name=&quot;author&quot;&gt;Enter an author&lt;/textarea&gt;</strong>
  ......
&lt;/form&gt;</pre>

<h3>Programming the Server-Side to Process Order</h3>

<p>So far, we have tested the &quot;query&quot; part of the e-shop. Let us continue to allow the client to &quot;order&quot; items in our e-shop.</p>

<p>The sequence of events shall be as follow (as illustrated in the figure):</p>

<ol>
<li>A client issues URL <code>http://<em>hostname</em>:9999/ebookshop/eshopquery.html</code>. The server responses with an HTML form showing the available authors. The form is to be submitted to URL &quot;<code>/eshopquery</code>&quot;, which is mapped to &quot;<code>EshopQueryServlet.class</code>&quot;.</li>

<li>The client selects the author(s) and sends the request to the &quot;<code>EshopQueryServlet</code>&quot;, with request parameter &quot;<code>author=<em>authorName</em></code>&quot;. The servlet retrieves the authors' name, queries the database, and returns a list of available books by that authors. Instead of writing a paragraph (<code>&lt;p&gt;...&lt;/p&gt;</code>) for each book (as in the previous exercises), the servlet shall now print a checkbox for each book. This allows the client to further interact with the server. The checkboxes are enclosed within an HTML form, which is to be submitted to URL &quot;<code>/eshoporder</code>&quot; (mapped to &quot;<code>EshopOrderServlet.class</code>&quot;).</li>
<li>The client selects the book(s) and sends the order request to the &quot;<code>EshopOrderServlet</code>&quot;, with request parameter &quot;<code>id=<em>xxx</em></code>&quot;. The servlet retrieves the books' <code>id</code>, updates the database, and returns a confirmation message.</li>

</ol>

<img class="image-center image-border" src="images/ServletCS_Order.png" alt="ServletCS_Order.png" />

<h4>Display an Order Form - &quot;<span class="font-code">EshopQueryServlet.java</span>&quot;</h4>

<p>The &quot;<code>QueryServlet</code>&quot; that we wrote easier returns a <em>static</em> HTML page, which prints a paragraph (using <code>&lt;p&gt;...&lt;/p&gt;</code>) for each book returned.  We shall modify it (called &quot;<code>EshopQueryServlet</code>&quot;) to return a <em>dynamic</em> HTML page containing <em>a form of checkboxes</em> to allow the client to order books. We shall map the &quot;<code>EshopQueryServlet</code>&quot; to URL &quot;<code>/eshopquery</code>&quot;.</p>

<p>Recall that a checkbox is produced by an <code>&lt;input&gt;</code> tag as follows:</p>

<pre class="color-command">
&lt;input type='checkbox' name='<strong><em>aName</em></strong>' value='<strong><em>aValue</em></strong>' /&gt;<strong><em>aLabel</em></strong></pre>

<p>We shall use the book's <code>id</code> as the ordering criterion. We shall choose &quot;<code>id=<em>xxx</em></code>&quot; as the <code>name=value</code><code></code> pair of the checkbox. We shall use <code>author</code>, <code>title</code> and <code>price</code> as the <em>label</em> for the checkbox. Hence, the servlet needs to produce an <code>&lt;input&gt;</code> tag which looks like:</p>

<pre class="color-command">
&lt;input type='checkbox' name='<strong>id</strong>' value='<strong>1001</strong>' /&gt;Tan Ah Teck, Java For Dummies, $11.11</pre>

<p>Take note that I used single-quotes (instead of double quotes) for the attribute values in the above HTML tags, as they are easier to print in <code>println()</code>.</p>
 

<p>The <code>EshopQueryServlet</code> shall send the order request to another servlet called <code>EshopOrderServlet</code> (which shall be mapped to an URL &quot;<code>/eshoporder</code>&quot;). Hence the <code>&lt;form&gt;</code> tag shall look like:</p>

<pre class="color-command">
&lt;form method='get' action='<strong>eshoporder</strong>'&gt;
  &lt;p&gt;&lt;input type='checkbox' name='id' value='1001' /&gt;Tan Ah Teck, Java For Dummies, $11.11&lt;/p&gt;
  &lt;p&gt;&lt;input type='checkbox' name='id' value='1002' /&gt;.........&lt;/p&gt;
  ......
&lt;/form&gt;</pre>

<br />
<p>The steps are as follows:</p>
 
<p><span class="line-heading">Step 1:</span> Write the &quot;<code>EshopQueryServlet.java</code>&quot; (based on  &quot;<code>QueryMultiValueServlet.java</code>&quot;). It shall process the <code>ResultSet</code> as follow, so as to generate the desired HTML <code>&lt;form&gt;</code> and <code>&lt;input&gt;</code> tags:</p>

<pre class="color-example">
<span class="color-comment">// Step 4: Process the query result
// Print the &lt;form&gt; start tag</span>
out.println(&quot;&lt;form method='get' action='<strong>eshoporder</strong>'&gt;&quot;);
<span class="color-comment"> 
// For each row in ResultSet, print one checkbox inside the &lt;form&gt;</span>
while(rset.next()) {
   out.println(&quot;&lt;p&gt;<strong>&lt;input type='checkbox' name='id' value=&quot;
         + &quot;'&quot; + rset.getString(&quot;id&quot;) + &quot;' /&gt;</strong>&quot;
         + rset.getString(&quot;author&quot;) + &quot;, &quot;
         + rset.getString(&quot;title&quot;) + &quot;, $&quot;
         + rset.getString(&quot;price&quot;) + &quot;&lt;/p&gt;&quot;);
}
 
<span class="color-comment">// Print the submit button and &lt;/form&gt; end-tag</span>
out.println(&quot;&lt;p&gt;&lt;input type='submit' value='ORDER' /&gt;&quot;);
out.println(&quot;&lt;/form&gt;&quot;);</pre>

<p><span class="line-heading">Step 2:</span> In &quot;<code>web.xml</code>&quot;, configure request URL &quot;<code>/eshopquery</code>&quot; to &quot;<code>EshopQueryServlet.class</code>&quot;.</p>

<p><span class="line-heading">Step 3:</span> Write an HTML form called &quot;<code>eshopquery.html</code>&quot; (based on &quot;<code>querybook.html</code>&quot;), which triggers &quot;<strong><code>eshopquery</code></strong>&quot;.</p>

<p>Select some books and click the &quot;ORDER&quot; submit button. Observe the HTTP GET request triggered. You are expected to receive a &quot;404 File Not Found&quot; error because you have yet to write the <code>EshopOrderServlet</code>.</p>
 
<h4>Processing the Order - &quot;<span class="font-code">EshopOrderServlet.java</span>&quot;</h4>

<p>The submit button in the previous step invokes this URL, with possibly zero or more <code>id</code>'s corresponding to the book(s) ordered.</p>

<pre class="color-command">
http://<em>hostname</em>:9999/ebookshop/<strong>eshoporder?id=1001&amp;id=1002</strong></pre>
 
<p>We shall map the request URL &quot;<code>/eshoporder</code>&quot; to a new servlet called &quot;<code>EshopOrderServlet</code>&quot;.</p>

<p>The &quot;<code>EshopOrderServlet</code>&quot; shall process the order by:</p>

<ol>
<li>Retrieve the <code>id</code> number(s) from the request.</li>

<li>In table <code>books</code>, reduce the &quot;<code>qty</code>&quot; by 1 for that particular <code>id</code> number. To update records in the table <code>books</code>, use an SQL UPDATE statement as follows:

<pre class="color-command">
UPDATE books <strong>SET qty = qty – 1</strong> WHERE <strong>id = 1001</strong>
UPDATE books <strong>SET qty = qty – 1</strong> WHERE <strong>id = 1002</strong></pre>
</li>

<li>Insert a transaction record in a new table called &quot;<code>order_records</code>&quot;.</li>
</ol>

<br  />
<p>The steps are as follows:</p>

<p><span class="line-heading">Step 1:</span> Create a <em>new</em> table called &quot;<code>order_records</code>&quot; in the same database &quot;<code>ebookshop</code>&quot; with five columns: <code>id</code> (<code>int</code>), <code>qty_ordered</code> (<code>int</code>), <code>cust_name</code> (<code>String</code>), <code>cust_email</code> (<code>String</code>) and <code>cust_phone</code> (<code>String</code>).</p>
<p>[Notes: You should avoid naming the table <code>order</code>, as it is a reserve word in SQL, which requries special handling.]</p>

<pre class="color-example">
Database: <strong>ebookshop</strong>
Table: <strong>order_records</strong>
+-------+-------------+---------------+---------------+------------+
| <strong>id  </strong>  | <strong>qty_ordered</strong> | <strong>cust_name</strong>     | <strong>cust_email</strong>    | <strong>cust_phone</strong> |
| (INT) | (INT)       | (VARCHAR(30)) | (VARCHAR(30)) | CHAR(8)    |
+-------+-------------+---------------+---------------+------------+</pre>

<p>You could use the following SQL script:</p>

<pre class="color-command">
use ebookshop;
 
drop table if exists order_records;
create table order_records (
  id          int,
  qty_ordered int,
  cust_name   varchar(30),
  cust_email  varchar(30),
  cust_phone  char(8));</pre>
 
<p><span class="line-heading">Step 2:</span> Write the &quot;<code>EshopOrderServlet.java</code>&quot; which retrieves the <code>id</code> from the request parameter &quot;<code>id=<em>xxx</em></code>&quot;, and updates the tables <code>books</code> and <code>order_records</code>.</p>

<p>The syntax for SQL INSERT is as follows:</p>
<pre class="color-command">
<span class="color-comment">// Insert full record</span>
INSERT INTO order_records VALUES (1001, 2, 'Kelvin Jones', 'kelvin@somewhere.com', '88881234')
<span class="color-comment">// Insert partial record</span>
INSERT INTO order_records (id, qty_ordered) VALUES (1001, 1)</pre>
 
<p>To execute SQL UPDATE and INSERT statements, you have to use the method <code>executeUpdate(<em>sqlStr</em>)</code>, which returns an <code>int</code>, indicating the number of rows affected by the UPDATE or INSERT. (Recall that we use <code>executeQuery()</code> for SQL SELECT, which returns a <code>ResultSet</code>). For example,</p>

<pre class="color-example">
String <strong>sqlstr = &quot;INSERT INTO order_records (id, qty_ordered) VALUES (1234, 1)&quot;</strong>;
int count;
count = stmt.<strong>executeUpdate(sqlstr)</strong>;
out.println(count + &quot; records inserted.&quot;);</pre>
 
<p>The <code>doGet()</code> method of the <code>EshopOrderServlet</code> shall look like:</p>

<pre class="color-example">
<span class="color-comment">// Step 3 &amp; 4: Execute a SQL SELECT query and Process the query result
</span>out.println(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Order Results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;);
<span class="color-comment"> 
// Retrieve the books' id. Can order more than one books.</span>
String[] ids = request.getParameterValues(&quot;id&quot;);
if (ids != null) {
   String sqlStr;
   int count;
 
   <span class="color-comment">// Process each of the books</span>
   for (int i = 0; i &lt; ids.length; ++i) {
      <span class="color-comment">// Update the qty of the table books</span>
      sqlStr = &quot;UPDATE books SET qty = qty - 1 WHERE id = &quot; + ids[i];
      out.println(&quot;&lt;p&gt;&quot; + sqlStr + &quot;&lt;/p&gt;&quot;);  <span class="color-comment">// for debugging</span>
      count = stmt.executeUpdate(sqlStr);
      out.println(&quot;&lt;p&gt;&quot; + count + &quot; record updated.&lt;/p&gt;&quot;);
 
      <span class="color-comment">// Create a transaction record</span>
      sqlStr = &quot;INSERT INTO order_records (id, qty_ordered) VALUES (&quot;
            + ids[i] + &quot;, 1)&quot;;
      out.println(&quot;&lt;p&gt;&quot; + sqlStr + &quot;&lt;/p&gt;&quot;);  <span class="color-comment">// for debugging</span>
      count = stmt.executeUpdate(sqlStr);
      out.println(&quot;&lt;p&gt;&quot; + count + &quot; record inserted.&lt;/p&gt;&quot;);
      out.println(&quot;&lt;h3&gt;Your order for book id=&quot; + ids[i]
            + &quot; has been confirmed.&lt;/h3&gt;&quot;);
   }
   out.println(&quot;&lt;h3&gt;Thank you.&lt;h3&gt;&quot;);
} else { <span class="color-comment">// No book selected</span>
   out.println(&quot;&lt;h3&gt;Please go back and select a book...&lt;/h3&gt;&quot;);
}
out.println(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);
</pre>
 
<p><span class="line-heading">Step 3:</span> In &quot;<code>web.xml</code>&quot;, configure the URL &quot;<code>/eshoporder</code>&quot; to &quot;<code>EshopOrderServlet.class</code>&quot;.</p>

<p>Run the application. Check the database to confirm the updating. Make sure that you have the message &quot;Thank you&quot; displayed.</p>

<h4>Touching Up</h4>

<ol>
<li>Add three text fields: <code>cust_name</code>, <code>cust_email</code> and <code>cust_phone</code> in <code>EshopQueryServlet</code>. The <code>&lt;input&gt;</code> tag for text fields look like:

  <pre class="color-syntax">
&lt;p&gt;Enter your Name: <strong>&lt;input type='text' name='cust_name' /&gt;</strong>&lt;/p&gt;
&lt;p&gt;Enter your Email: <strong>&lt;input type='text' name='cust_email' /&gt;</strong>&lt;/p&gt;
&lt;p&gt;Enter your Phone Number: <strong>&lt;input type='text' name='cust_phone' /&gt;</strong>&lt;/p&gt;</pre>

The <code>value</code> of a text field is the string entered.

<img class="image-center" src="images/ServletCS_Table.png" alt="ServletCS_Table.png" />

</li>

<li>In <code>EShopQueryServlet</code>, put the rows into an HTML table.

The syntax for displaying HTML table is:
  <pre class="color-syntax">
&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;heading for column 1&lt;/th&gt;
    &lt;th&gt;heading for column 2&lt;/th&gt;
    ......
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;data for column 1&lt;/td&gt;
    &lt;td&gt;data for column 2&lt;/td&gt;
    ......
  &lt;/tr&gt;
  ......
&lt;/table&gt;</pre>
 
The <code>&lt;table&gt;...&lt;/table&gt;</code> tag markups a <em>table</em>; <code>&lt;tr&gt;...&lt;/tr&gt;</code> markups a <em>row</em>; <code>&lt;th&gt;...&lt;/th&gt;</code> is a <em>header</em> <em>cell</em> in the row, and <code>&lt;td&gt;...&lt;/td&gt;</code> is a <em>data cell</em>.<br />
You need to print the HTML tags via <code>out.println()</code>. Print the <code>&lt;table&gt;</code> begin-tag and header-row before the while-loop<code></code> (for processing the <code>ResultSet</code>); print the data-row inside the while-loop; print the <code>&lt;/table&gt;</code> end-tag after the while-loop.</li>

</ol>
 
<h3>What's Next</h3>
<p>You have created an e-shop, driven by Tomcat HTTP server and a database, with Java servlet as the server-side programs and HTML form and Java Applet as the client-side programs. This e-shop, although primitive, is functional. It illustrates the principles and technologies behind a database webapp.</p>

<p>You can improve on:</p>
<ol>
<li>Database: use a comprehensive database with multiple tables (e.g., <code>authors</code>, <code>books</code>, <code>writes</code>, <code>customers</code>, <code>order_details</code>, etc.).</li>
<li>Client-side: use HTML 5, CSS 3 and JavaScript to improve on the presentation and client-side validation.</li>
<li>Server-side: provide more functions.</li>
</ol>


<p>Some critical components are still missing in our e-shop:</p>
<ol>
<li>The names of authors are hard-coded in <code>&quot;Eshopquerybook.html</code>&quot;. Instead of hard-coding, write a servlet (called <code>EShopDisplayServlet</code>) to <strong>generate the list of authors from the database automatically</strong>. Instead of starting with an HTML page, the webapp begins by requesting for the servlet.<br />
Hints: Use the following SQL statement to retrieve all the <em>distinct</em> authors from table <code>books</code>:

<pre class="color-command">
SELECT <strong>DISTINCT</strong> author FROM books WHERE qty &gt; 0</pre></li>

 <li><strong>Input Validation</strong> (client-side and server-side), e.g., phone number (8-digit), email (xxx@yyy), name required, proper date format.</li>
 <li><strong>Database Connection Pooling</strong>: Creating a connection for each user request is inefficient, due to the high overhead in initializing and opening the connection. We commonly set up a pool of connection known as <em>database connection pool</em>. A request picks up an available connection from the pool, and returns the connection to the pool after processing.</li>
 <li><strong>Session Management</strong> (aka &quot;<strong>Shopping Cart</strong>&quot;): HTTP is a <em>stateless</em> protocol. It does not maintain state information across requests. That is, the 2nd HTTP request does not know what was done in the 1st request. This poses a problem for our e-shop. If a user chooses a few books over multiple requests, the books chosen in the earlier requests have to be &quot;remembered&quot; and placed inside a so-called &quot;shopping cart&quot;. The user will check-out the items in the &quot;shopping cart&quot; after he/she finishes all his/her shopping.</li>

<li><strong>User Management</strong>: to manage users with different roles, such as administrator, users, etc.</li>
<li><strong>Uploading Files</strong>.</li>
<li><strong>Deploying the Web Application</strong></li>
<li><strong>A Secured Payment Gateway</strong></li>
</ol>

<p>These topics are beyond the scope of this workshop.</p>

<p class="references">REFERENCES &amp; RESOURCES</p>

<ol>

<li>JDK (aka Java SE) Home Page @ <a href="http://java.sun.com/javase">http://java.sun.com/javase</a> (or <a href="http://www.oracle.com/technetwork/java/javase/overview/index.html">http://www.oracle.com/technetwork/java/javase/overview/index.html</a>).</li>

<li>Apache Tomcat Home Page @ <a href="http://tomcat.apache.org">http://tomcat.apache.org</a>.</li>

<li>Java Database Connectivity (JDBC) Home Page @ <a href="http://java.sun.com/products/jdbc">http://java.sun.com/products/jdbc</a>.</li>

<li>Java Servlets Home Page @ <a href="http://java.sun.com/products/servlet/">http://java.sun.com/products/servlet</a>. Servlet Developers @ <a href="http://java.net/projects/servlet/">http://java.net/projects/servlet/</a>.</li>

<li>The Java EE 6 Tutorial, Chapter 10 &quot;<em>Java Servlet Technology</em>&quot;, December 2009 @ <a href="http://java.sun.com/javaee/6/docs/tutorial/doc/bnafd.html">http://java.sun.com/javaee/6/docs/tutorial/doc/bnafd.html</a>.</li>

<li>The Java EE 5 Tutorial, Chapter 4 &quot;<em>Java Servlet Technology</em>&quot;, October 2008 @ <a href="http://java.sun.com/javaee/5/docs/tutorial/doc/bnafd.html">http://java.sun.com/javaee/5/docs/tutorial/doc/bnafd.html</a>.</li>

<li>The J2EE 1.4 Tutorial, Chapter 11 &quot;<em>Java Servlet Technology</em>&quot;, December, 2005 @ <a href="http://java.sun.com/j2ee/1.4/docs/tutorial/doc/">http://java.sun.com/j2ee/1.4/docs/tutorial/doc/</a>.</li>

<li>The J2EE 1.3 Tutorial &quot;<em>Java Servlet Technology</em>&quot; @ <a href="http://java.sun.com/j2ee/tutorial/1_3-fcs/doc/Servlets.html">http://java.sun.com/j2ee/tutorial/1_3-fcs/doc/Servlets.html</a>.</li>
  
<li>White Fisher, et al., &quot;<em>JDBC API Tutorial and Reference</em>&quot;, 3rd eds, Addison Wesley.</li>

<li>MySQL Mother Site @ <a href="http://www.mysql.com">www.mysql.com</a>, and MySQL 5.5 Reference Manual @ <a href="http://dev.mysql.com/doc/refman/5.1/en/index.html.">http://dev.mysql.com/doc/refman/5.5/en/index.html.</a></li>

<li>SQL.org @ <a href="http://www.sql.org">http://www.sql.org</a>.</li>
  
<li>Marty Hall, et al., &quot;<em>Core Servlets and JavaServer Pages</em>&quot;, vol.1 (2nd eds, 2003) and vol. 2 (2nd eds, 2006), Prentice Hall.</li>
  
<li>RFC2616 &quot;<em>Hypertext Transfer Protocol HTTP 1.1</em>&quot;, World-Wide-Web Consortium (W3C), June 1999.</li>
  
<li>&quot;<em>HTML 4.01 Specification</em>&quot;, W3C Recommendation, 24 Dec 1999.</li>

<li>Eric Ladd and Jim O’Donnell, &quot;<em>Using HTML, Java and CGI</em>&quot; and &quot;<em>Using HTML 4, XML and Java 1.2</em>&quot;, Que.</li>
</ol>

</div> <!-- End the content-main division -->

<div id="content-footer">
<p>Latest version tested: Apache Tomcat 8.0.30, MySQL 5.7.11, JDK 1.8.0_66<br />
Last modified: February, 2016</p>
</div>

</div>  <!-- End the wrap-inner division -->

<!-- footer filled by JavaScript -->
<div id="footer" class="header-footer"><p>&nbsp;</p></div>

</div>  <!-- End the wrap-outer division -->
</body>
</html>
